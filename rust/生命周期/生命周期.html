<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../css/wolai.css"/><title>生命周期 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="生命周期" class="main-title"></div></div></header><article><div id="w2YTaABUYcNVzKhT8y14BV" class="wolai-block wolai-text"><div><span class="blue inline-wrap">使用目的</span><span class="inline-wrap">：让编译器知道被标记的对象的生命周期</span></div></div><div id="w4yL1CSryxkmsjywZ1Z5Ur" class="wolai-block wolai-text"><div><span class="blue inline-wrap">根本因素：</span><span class="inline-wrap">Rust<span class="jill"></span>编译器需要在编译时确定引用的生命周期，以确保引用在使用时仍然有效，防止悬垂引用或访问已释放的内存。</span></div></div><div id="3bCHiu9oAFxmiGsejeV9UE" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h1 id="bUJasSYToDgTmbVspsp9rW" class="wolai-block"><span class="inline-wrap">静态生命周期</span><div id="mA95MJmNRJgEcPibRzVou7" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明：</span><span class="inline-wrap"><code>&#39;static</code></span><span class="inline-wrap">：拥有该生命周期的引用可以和整个程序活得一样久。</span></div></div><div id="oWyoHB4TQNKbPeMmBkUAfP" class="wolai-block wolai-text"><div><span class="inline-wrap">示例</span></div></div><code-block id="bd9YRe9PehLobuvhNXWrRF" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre><span class="token keyword">let</span> s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">"我没啥优点，就是活得久，嘿嘿"</span><span class="token punctuation">;</span></pre></div></code-block></h1><h1 id="944F2H3HK2Pevt5NXYXpvb" class="wolai-block"><span class="inline-wrap">函数生命周期</span><aside id="8Rb2UbXPacbgmpbcYr4hDa" class="bg-cultured wolai-block"><div data-symbol="📌" class="icon"></div><span class="inline-wrap"><b>函数的返回值如果是一个引用类型，那么它的生命周期只会来源于</b></span><span class="inline-wrap">：
1. 函数参数的生命周期
2. </span><span class="inline-wrap">函数体中某个新建引用的生命周期</span></aside><details id="3nCKPm6poLLJXTnVUhVG6" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">概念</span></summary><div id="5kosx6Vf6kz5hnoY2EsUsJ" class="wolai-block wolai-text"><div><span class="blue inline-wrap">输入生命周期</span><span class="inline-wrap">：参数的生命周期</span></div></div><div id="e7XHbxWgppg1NC4HLPaDdB" class="wolai-block wolai-text"><div><span class="blue inline-wrap">输出生命周期</span><span class="inline-wrap">：返回值的生命周期</span></div></div></details><details id="9DFdsiSByYk8kxXyRhJA6r" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">目的</span></summary><div id="ofVbkpHe4WNMNwQ5cd7M2c" class="wolai-block wolai-text"><div><span class="inline-wrap">对于函数参数的生命周期标注，是为了确保输出参数的生命周期不超过输入参数的生命周期。这是为了避免在函数结束后返回无效的引用。</span></div></div></details><details id="w38ZAw7cR4uBUg3prkScDM" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">错误示例</span></summary><code-block id="osfPq9KTW9idqMMPHdz1w1" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> string1 <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"abcd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> string2 <span class="token operator">=</span> <span class="token string">"xyz"</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">longest</span><span class="token punctuation">(</span>string1<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> string2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The longest string is {}"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function-definition function">longest</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> x<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> y<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        y
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></div></code-block><div id="ssT97By2fRdSFCFi9hWtmQ" class="wolai-block wolai-text"><div><span class="blue inline-wrap">错误原因：</span><span class="inline-wrap">在<span class="jill"></span>Rust<span class="jill"></span>中，编译器无法推断出</span><span class="inline-wrap"><code>longest</code></span><span class="inline-wrap">函数参数的生命周期，因为它涉及到引用的生命周期问题。</span></div></div></details><details id="7yGT3iRqRsp3pMhrW3SxUK" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">消除规则</span></summary><details id="6YRr2ea4FNdv7HhqwXdtWL" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">每一个引用参数都会获得独自的生命周期</span></summary><ol class="wolai-block"><li id="4k6FLsVMJxocisdNzREkfT"><div class="marker"></div><span class="inline-wrap">一个引用参数的函数就有一个生命周期标注: </span><span class="inline-wrap"><code>fn foo&lt;&#39;a&gt;(x: &amp;&#39;a i32)</code></span><span class="inline-wrap">，</span></li><li id="3WfcyEVNJbSYETzeSXTTUV"><div class="marker"></div><span class="inline-wrap">两个引用参数的有两个生命周期标注:</span><span class="inline-wrap"><code>fn foo&lt;&#39;a, &#39;b&gt;(x: &amp;&#39;a i32, y: &amp;&#39;b i32)</code></span><span class="inline-wrap">, 依此类推。</span></li></ol></details><details id="7YcLQLo8imimPMK6TasM9h" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">若只有一个输入生命周期(函数参数中只有一个引用类型)，那么该生命周期会被赋给所有的输出生命周期</span></summary><ol class="wolai-block"><li id="2q6CGjkX6D4pnkZGK1joT9"><div class="marker"></div><span class="inline-wrap">例如函数 </span><span class="inline-wrap"><code>fn foo(x: &amp;i32) -&gt; &amp;i32</code></span><span class="inline-wrap">，</span><span class="inline-wrap"><code>x</code></span><span class="inline-wrap"> 参数的生命周期会被自动赋给返回值 </span><span class="inline-wrap"><code>&amp;i32</code></span><span class="inline-wrap">，因此该函数等同于 </span><span class="inline-wrap"><code>fn foo&lt;&#39;a&gt;(x: &amp;&#39;a i32) -&gt; &amp;&#39;a i32</code></span></li></ol></details><details id="mYBUiQ33P1ihabJtmgebJP" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">若存在多个输入生命周期，且其中一个是 </span><span class="inline-wrap"><code>&amp;self</code></span><span class="inline-wrap"> 或 </span><span class="inline-wrap"><code>&amp;mut self</code></span><span class="inline-wrap">，则 </span><span class="inline-wrap"><code>&amp;self</code></span><span class="inline-wrap"> 的生命周期被赋给所有的输出生命周期</span></summary><div id="kf2udXMa7ZGVgiYvJGRTPb" class="wolai-block wolai-text"><div><span class="inline-wrap">拥有 </span><span class="inline-wrap"><code>&amp;self</code></span><span class="inline-wrap"> 形式的参数，说明该函数是一个 </span><span class="inline-wrap"><code>方法</code></span><span class="inline-wrap">，该规则让方法的使用便利度大幅提升。</span></div></div></details></details></h1><h1 id="37QXrYPvV9sSoC8RYJ82JQ" class="wolai-block"><span class="inline-wrap">结构体</span><span class="inline-wrap">生命</span><span class="inline-wrap">周期</span><details id="f4JvMpNm4WJ5a76DuYQDmP" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">示例</span></summary><div id="o3mtRBNFWUxJCJjv9Mu8ez" class="wolai-block wolai-text"><div><span class="inline-wrap">说明：</span><span class="inline-wrap"><code>ImportantExcerpt</code></span><span class="inline-wrap"> 结构体中有一个引用类型的字段 </span><span class="inline-wrap"><code>part</code></span><span class="inline-wrap">，因此需要为它标注上生命周期。结构体的生命周期标注语法跟泛型参数语法很像，需要对生命周期参数进行声明 </span><span class="inline-wrap"><code>&lt;&#39;a&gt;</code></span><span class="inline-wrap">。该生命周期标注说明，</span><span class="inline-wrap"><b>结构体 </b></span><span class="inline-wrap"><b><code>ImportantExcerpt</code></b></span><span class="inline-wrap"><b> 所引用的字符串 </b></span><span class="inline-wrap"><b><code>str</code></b></span><span class="inline-wrap"><b> 必须比该结构体活得更久</b></span><span class="inline-wrap">。</span></div></div><code-block id="3wgMgGppukSYWgbkcySqLX" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre><span class="token keyword">struct</span> <span class="token type-definition class-name">ImportantExcerpt</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">{</span>
    part<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> novel <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Call me Ishmael. Some years ago..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> first_sentence <span class="token operator">=</span> novel<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Could not find a '.'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token class-name">ImportantExcerpt</span> <span class="token punctuation">{</span>
        part<span class="token punctuation">:</span> first_sentence<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block></details></h1><h1 id="rAfTdbiaae6RtwHenwDByx" class="wolai-block"><span class="inline-wrap">方法生命周期</span><aside id="b9wBd6sthEhB2XSijQkzDS" class="bg-cultured wolai-block"><div data-symbol="📌" class="icon"></div><span class="inline-wrap">1. </span><span class="inline-wrap"><code>impl</code></span><span class="inline-wrap">中必须使用结构体的完整名称，包括 </span><span class="inline-wrap"><code>&lt;&#39;a&gt;</code></span><span class="inline-wrap">，因为生命周期标注也是结构体类型的一部分！
2. 方法签名中，往往不需要标注生命周期，得益于生命周期消除的第一和第三规则</span></aside><div id="o374ttrU6sKZLAZ3jT9FhP" class="wolai-block wolai-text"><div><span class="blue inline-wrap">目的：</span><span class="inline-wrap">以避免悬垂引用和无效引用的情况。</span></div></div><details id="6erx4CcWnp4CaW8i4sjtBM" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">使用场景</span></summary><details id="uf2RwdzZfeeXcWxwdaFPto" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">结构体或枚举中的方法</span></summary><div id="cL5r4y3GHSnZNZPzbq7dQb" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明：</span><span class="inline-wrap">在这个例子中，</span><span class="inline-wrap"><code>&#39;a</code></span><span class="inline-wrap"> 是一个生命周期参数，它指定了方法 </span><span class="inline-wrap"><code>get_data</code></span><span class="inline-wrap"> 返回的引用的有效范围与结构体中的引用 </span><span class="inline-wrap"><code>data</code></span><span class="inline-wrap"> 相同。这确保了返回的引用不会超出 </span><span class="inline-wrap"><code>Foo</code></span><span class="inline-wrap"> 结构体实例所引用的字符串切片的生命周期。</span></div></div><code-block id="62KtxU8TwKebPGGJBE2keb" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre><span class="token keyword">struct</span> <span class="token type-definition class-name">Foo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get_data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>data
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block></details><details id="qDjP7VTV5EsUFFwdzFSdQN" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">Trait 方法中的生命周期参数</span></summary><div id="RV6JJaek9r2mbzvvNUPU6" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明：</span><span class="inline-wrap">在这个例子中，</span><span class="inline-wrap"><code>&#39;a</code></span><span class="inline-wrap"> 是一个生命周期参数，它表示输入参数 </span><span class="inline-wrap"><code>data</code></span><span class="inline-wrap"> 和返回值的引用共享相同的生命周期。这样确保了在实现 </span><span class="inline-wrap"><code>Bar</code></span><span class="inline-wrap"> trait 的类型中使用 </span><span class="inline-wrap"><code>process_data</code></span><span class="inline-wrap"> 方法时，引用的有效性。</span></div></div><code-block id="kn4G9EXnazd27n6AEyqNJw" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre><span class="token keyword">trait</span> <span class="token type-definition class-name">Bar</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">process_data</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block></details></details></h1><div id="vP2wdzLUrLc6ip2DvCTbaq" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div></article><footer></footer></body></html>