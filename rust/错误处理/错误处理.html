<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../css/wolai.css"/><title>错误处理 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="错误处理" class="main-title"></div></div></header><article><h1 id="w5A5pmuSjG2vEuWUZSmMYR" class="wolai-block"><span class="inline-wrap">分类</span><details id="7ATvpr3F2PM5LkH9sNmcht" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">可恢复错误</span></summary><div id="btp7n45dpY86FJwFYsS5Uu" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明：</span><span class="inline-wrap">通常用于从系统全局角度来看可以接受的错误，些错误只会影响某个用户自身的操作进程，而不会对系统的全局稳定性产生影响</span></div></div><div id="emvw3YSkcaBT5PrBnw7RBr" class="wolai-block wolai-text"><div><span class="blue inline-wrap">示例：</span><span class="inline-wrap">处理用户的访问、操作等错误</span></div></div><div id="aNkDTqbAcMAdcPgihuQG6A" class="wolai-block wolai-text"><div><span class="blue inline-wrap">代码：</span><span class="inline-wrap"><code>Result&lt;T,E&gt;</code></span></div></div></details><details id="8vSbR9Dwu4H1vvLCYuQ4uo" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">不可恢复错误</span></summary><div id="2GXvFhWydCdVTXBbYRrJqK" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明：</span><span class="inline-wrap">该错误通常是全局性或者系统性的错误</span></div></div><div id="axPZUQKvFihGc4yAQ87jUX" class="wolai-block wolai-text"><div><span class="blue inline-wrap">示例：</span><span class="inline-wrap">数组越界访问，系统启动时发生了影响启动流程的错误</span></div></div><div id="n5NvvGfAcv52dYpbxqjfRb" class="wolai-block wolai-text"><div><span class="blue inline-wrap">代码：</span><span class="blue inline-wrap"><code>panic!()</code></span></div></div><details id="g3KeiTneoMeRcunGqV14tK" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">终止方式</span></summary><details id="ucVyfPcFg592nYioWWm2bB" class="wolai-block"><summary><div class="marker placeholder"></div><span class="inline-wrap">栈展开（默认）</span></summary></details><details id="sTrTTqauTakrTqc7xUBU7H" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">直接终止</span></summary><div id="dk9FAEA1xekPASPn6mkJTZ" class="wolai-block wolai-text"><div><span class="inline-wrap">修改 </span><span class="inline-wrap"><code>Cargo.toml</code></span><span class="inline-wrap"> 文件，实现在 </span><span class="inline-wrap"><a href="https://course.rs/first-try/cargo.html#手动编译和运行项目"><span><code>release</code></span></a></span><span class="inline-wrap"> 模式下遇到 </span><span class="inline-wrap"><code>panic</code></span><span class="inline-wrap"> 直接终止：</span></div></div><code-block id="YZGV3VgfXCUs2ks3F5BDZ" class="wolai-block"><div class="wolai-pre"><div data-lang="Ini" class="marker"></div><pre><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">profile.release</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">panic</span> <span class="token punctuation">=</span> <span class="token value attr-value">'<span class="token inner-value">abort</span>'</span></pre></div></code-block></details></details><details id="o16gNqw3y8odxh1uZXQDcR" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">原理</span></summary><details id="9KHmzzD5xndCAQFEE19nRU" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">情况一（常见）</span></summary><div id="wA3yYnbkb7QWFctCiUiw4p" class="wolai-block wolai-text"><div><span class="inline-wrap">当调用 </span><span class="inline-wrap"><code>panic!</code></span><span class="inline-wrap"> 宏时，它会</span></div></div><ol class="wolai-block"><li id="715ymitmusLW69F1PDwKyb"><div class="marker"></div><span class="inline-wrap">格式化 </span><span class="inline-wrap"><code>panic</code></span><span class="inline-wrap"> 信息，然后使用该信息作为参数，调用 </span><span class="inline-wrap"><code>std::panic::panic_any()</code></span><span class="inline-wrap"> 函数</span></li><li id="eNSWH4dbTAvGCwHM2dBS8X"><div class="marker"></div><span class="inline-wrap"><code>panic_any</code></span><span class="inline-wrap"> 会检查应用是否使用了 </span><span class="inline-wrap"><a href="https://doc.rust-lang.org/std/panic/fn.set_hook.html"><span><code>panic hook</code></span></a></span><span class="inline-wrap">，如果使用了，该 </span><span class="inline-wrap"><code>hook</code></span><span class="inline-wrap"> 函数就会被调用（</span><span class="inline-wrap"><code>hook</code></span><span class="inline-wrap"> 是一个钩子函数，是外部代码设置的，用于在 </span><span class="inline-wrap"><code>panic</code></span><span class="inline-wrap"> 触发时，执行外部代码所需的功能）</span></li><li id="7eurWGwNoiTxry2QHRoo9j"><div class="marker"></div><span class="inline-wrap">当 </span><span class="inline-wrap"><code>hook</code></span><span class="inline-wrap"> 函数返回后，当前的线程就开始进行栈展开：从 </span><span class="inline-wrap"><code>panic_any</code></span><span class="inline-wrap"> 开始，如果寄存器或者栈因为某些原因信息错乱了，那很可能该展开会发生异常，最终线程会直接停止，展开也无法继续进行</span></li><li id="8Hg9xXBsSNDSHoxC5CjwT7"><div class="marker"></div><span class="inline-wrap">展开的过程是一帧一帧的去回溯整个栈，每个帧的数据都会随之被丢弃，但是在展开过程中，你可能会遇到被用户标记为 </span><span class="inline-wrap"><code>catching</code></span><span class="inline-wrap"> 的帧（通过 </span><span class="inline-wrap"><code>std::panic::catch_unwind()</code></span><span class="inline-wrap"> 函数标记），此时用户提供的 </span><span class="inline-wrap"><code>catch</code></span><span class="inline-wrap"> 函数会被调用，展开也随之停止：当然，如果 </span><span class="inline-wrap"><code>catch</code></span><span class="inline-wrap"> 选择在内部调用 </span><span class="inline-wrap"><code>std::panic::resume_unwind()</code></span><span class="inline-wrap"> 函数，则展开还会继续。</span></li></ol></details><details id="mHXJb2D7ZDxpB6FReov9C6" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">情况二</span></summary><div id="qd77n6Aidac7Kwo5HRJdSk" class="wolai-block wolai-text"><div><span class="inline-wrap">展开过程中，如果展开本身 </span><span class="inline-wrap"><code>panic</code></span><span class="inline-wrap"> 了，那展开线程会终止，展开也随之停止。</span></div></div></details><div id="4srGjdebhDXqBJ3ZTV5a9C" class="wolai-block wolai-text"><div><span class="inline-wrap">一旦线程展开被终止或者完成，最终的输出结果是取决于哪个线程 </span><span class="inline-wrap"><code>panic</code></span><span class="inline-wrap">：对于 </span><span class="inline-wrap"><code>main</code></span><span class="inline-wrap"> 线程，操作系统提供的终止功能 </span><span class="inline-wrap"><code>core::intrinsics::abort()</code></span><span class="inline-wrap"> 会被调用，最终结束当前的 </span><span class="inline-wrap"><code>panic</code></span><span class="inline-wrap"> 进程；如果是其它子线程，那么子线程就会简单的终止，同时信息会在稍后通过 </span><span class="inline-wrap"><code>std::thread::join()</code></span><span class="inline-wrap"> 进行收集。</span></div></div></details></details></h1><h1 id="7hhUVYr4rjap67e32u1kDx" class="wolai-block"><span class="inline-wrap">.unwrap()</span><div id="wR5PhCjrMH5GtAuzrUnz7U" class="wolai-block wolai-text"><div><span class="inline-wrap">说明：</span><span class="inline-wrap"><code>unwrap()</code></span><span class="inline-wrap"> 是一种方法用于处理 </span><span class="inline-wrap"><code>Option</code></span><span class="inline-wrap"> 和 </span><span class="inline-wrap"><code>Result</code></span><span class="inline-wrap"> 类型的值。它是一个用于提取 </span><span class="inline-wrap"><code>Option</code></span><span class="inline-wrap"> 或 </span><span class="inline-wrap"><code>Result</code></span><span class="inline-wrap"> 的值的简便方法，如果值是 </span><span class="inline-wrap"><code>Some</code></span><span class="inline-wrap"> 或 </span><span class="inline-wrap"><code>Ok</code></span><span class="inline-wrap">，则返回内部的值；如果是 </span><span class="inline-wrap"><code>None</code></span><span class="inline-wrap"> 或 </span><span class="inline-wrap"><code>Err</code></span><span class="inline-wrap">，则会引发 panic。</span></div></div></h1><div id="oFnzDceuzZLJBfvuq8gj8H" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h1 id="uw1ci1vGM4aLfrRLy6yY5C" class="wolai-block"><span class="inline-wrap">向上传播：</span><span class="inline-wrap"><code>?</code></span><details id="wW8ZP4sWc7YZsVdq7EJuJ" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">使用方法</span></summary><ul class="wolai-block"><li id="eVdeX3wBPXYNDgwWGUHabW"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>let v = xxx()?;</code></span></li><li id="5c7m4Tz5gNxp6C8k85inaQ"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>xxx()?.yyy()?;</code></span></li></ul></details><details id="vW7Hy7Bf5ucnn4GiUkSSj5" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">示例</span></summary><details id="7bz4kXrteqSSZvpNQDnqqp" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">用于</span><span class="inline-wrap"><code>Result&lt;T,E&gt;</code></span></summary><code-block id="8Xfoqvht6Soi9qc7mb7XCy" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Read</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">read_username_from_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"hello.txt"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// let mut f = match f {</span>
    <span class="token comment">//  打开文件成功，将file句柄赋值给f</span>
    <span class="token comment">// Ok(file) => file,</span>
    <span class="token comment">//  打开文件失败，将错误返回(向上传播)</span>
    <span class="token comment">// Err(e) => return Err(e),</span>
    <span class="token comment">// };</span>
    <span class="token comment">// 等同于</span>
    f<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    


    <span class="token class-name">Ok</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre></div></code-block></details><details id="bUEDTc6r4bLg6Z1Tk5Uuk2" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">用于</span><span class="inline-wrap"><code>Option</code></span></summary><code-block id="h4Tj4jfMXum9rSePs2mGVh" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre><span class="token keyword">fn</span> <span class="token function-definition function">divide</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">0.0</span> <span class="token punctuation">{</span>
        <span class="token class-name">None</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span>a <span class="token operator">/</span> b<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Result: {}"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Result: {}"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这行不会执行</span>

    <span class="token comment">// Ok(()) 只是一个惯用的写法，表示成功的结果，而不包含任何有用的值。</span>
    <span class="token comment">// 表示 main 函数成功地执行并返回一个不包含任何有用信息的成功值。() 是一个表示空元组的值。</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></pre></div></code-block></details></details><details id="shge4gcEGUrnvA3Jy2eiKj" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">意义</span></summary><div id="rqH6Sjy1aM8Le23YBB2FA1" class="wolai-block wolai-text"><div><span class="inline-wrap">这种转换非常好用，意味着你可以用一个大而全的 </span><span class="inline-wrap"><code>ReturnError</code></span><span class="inline-wrap"> 来覆盖所有错误类型，只需要为各种子错误类型实现这种转换即可。</span></div></div></details><details id="aawHNQisuyajuiE99qvA3M" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">本质</span></summary><div id="spjpXwCxVX3pWpiQQki3m1" class="wolai-block wolai-text"><div><span class="inline-wrap">根本原因是在于标准库中定义的 </span><span class="inline-wrap"><code>From</code></span><span class="inline-wrap"> 特征，该特征有一个方法 </span><span class="inline-wrap"><code>from</code></span><span class="inline-wrap">，用于把一个类型转成另外一个类型，</span><span class="inline-wrap"><code>?</code></span><span class="inline-wrap"> 可以自动调用该方法，然后进行隐式类型转换。因此只要函数返回的错误 </span><span class="inline-wrap"><code>ReturnError</code></span><span class="inline-wrap"> 实现了 </span><span class="inline-wrap"><code>From&lt;OtherError&gt;</code></span><span class="inline-wrap"> 特征，那么 </span><span class="inline-wrap"><code>?</code></span><span class="inline-wrap"> 就会自动把 </span><span class="inline-wrap"><code>OtherError</code></span><span class="inline-wrap"> 转换为 </span><span class="inline-wrap"><code>ReturnError</code></span></div></div></details></h1><h1 id="ec1wsoV51brhkGGybmHdf3" class="wolai-block"><span class="inline-wrap">自定义错误</span><details id="5CMj58CJkvHPwtmgpgsEjE" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">thiserror</span></summary><div id="qPoY6u4CcpxaJ2DY9mmKEH" class="wolai-block wolai-text"><div><span class="inline-wrap">当在<span class="jill"></span>Rust<span class="jill"></span>中使用 </span><span class="inline-wrap"><code>thiserror</code></span><span class="inline-wrap"> 宏库时，您可以定义自定义错误类型并为其提供方便的错误处理功能。以下是一个使用 </span><span class="inline-wrap"><code>thiserror</code></span><span class="inline-wrap"> 的示例：</span></div></div><div id="jV2sJSNw4JhbfmRHDWWTeM" class="wolai-block wolai-text"><div><span class="inline-wrap">首先，在您的 </span><span class="inline-wrap"><code>Cargo.toml</code></span><span class="inline-wrap"> 文件中，将 </span><span class="inline-wrap"><code>thiserror</code></span><span class="inline-wrap"> 添加为依赖项：</span></div></div><code-block id="t8nNgRCXUB7LCZjNv2Lbrf" class="wolai-block"><div class="wolai-pre"><div data-lang="Toml" class="marker"></div><pre><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">thiserror</span> <span class="token punctuation">=</span> <span class="token string">"1.0"</span></pre></div></code-block><div id="ruv51w9VvTHeP5n5KUHxSq" class="wolai-block wolai-text"><div><span class="inline-wrap">然后，在您的 Rust 代码中，导入 </span><span class="inline-wrap"><code>thiserror</code></span><span class="inline-wrap"> 宏库和其他必要的模块：</span></div></div><code-block id="ecKgb7fVapQqYyRpc1SQGW" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre><span class="token keyword">use</span> <span class="token namespace">thiserror<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Read</span><span class="token punctuation">;</span></pre></div></code-block><div id="s6oUNFFJSqqwsfAxXhsLdi" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，定义一个自定义错误类型，并使用 </span><span class="inline-wrap"><code>thiserror</code></span><span class="inline-wrap"> 宏为其实现错误处理功能：</span></div></div><code-block id="eiRsMkbH3pzjbX3TU2cuB4" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre><span class="token attribute attr-name">#[derive(Error, Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">MyError</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[error(<span class="token string">"Failed to open file: {0}"</span>)]</span>
    <span class="token class-name">FileError</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[error(<span class="token string">"Failed to read file: {0}"</span>)]</span>
    <span class="token class-name">ReadError</span><span class="token punctuation">(</span><span class="token attribute attr-name">#[from]</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="3FGSSyCsxJyCrURzfDcejx" class="wolai-block wolai-text"><div><span class="inline-wrap">在上面的示例中，我们定义了一个枚举 </span><span class="inline-wrap"><code>MyError</code></span><span class="inline-wrap">，其中包含两个错误变体。第一个变体 </span><span class="inline-wrap"><code>FileError</code></span><span class="inline-wrap"> 接受一个字符串作为参数，用于描述文件打开失败的错误。第二个变体 </span><span class="inline-wrap"><code>ReadError</code></span><span class="inline-wrap"> 使用 </span><span class="inline-wrap"><code>#[from]</code></span><span class="inline-wrap"> 属性将 </span><span class="inline-wrap"><code>std::io::Error</code></span><span class="inline-wrap"> 类型映射为 </span><span class="inline-wrap"><code>MyError</code></span><span class="inline-wrap"> 类型，并自动提供错误转换。</span></div></div><div id="5au4stLVaCoyjCJWdVosqn" class="wolai-block wolai-text"><div><span class="inline-wrap">现在，您可以在代码中使用自定义错误类型并进行错误处理。例如，下面的示例演示了如何打开文件并读取其内容，同时处理可能出现的错误：</span></div></div><code-block id="dvgTB5AQxmf3F18XYNevRA" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre><span class="token keyword">fn</span> <span class="token function-definition function">read_file_contents</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">MyError</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>e<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">MyError</span><span class="token punctuation">::</span><span class="token class-name">FileError</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> <span class="token keyword">mut</span> contents <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">MyError</span><span class="token punctuation">::</span><span class="token class-name">ReadError</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="5ay5q6vcTDTECwuoHmddqx" class="wolai-block wolai-text"><div><span class="inline-wrap">在上面的示例中，我们定义了一个函数 </span><span class="inline-wrap"><code>read_file_contents</code></span><span class="inline-wrap">，它接受一个文件路径，并尝试打开文件并读取其内容。如果打开文件或读取内容时发生错误，将返回一个 </span><span class="inline-wrap"><code>Result</code></span><span class="inline-wrap"> 类型，其中包含自定义的 </span><span class="inline-wrap"><code>MyError</code></span><span class="inline-wrap">。</span></div></div><div id="7PGCXpNh5ozymEBeUBt56f" class="wolai-block wolai-text"><div><span class="inline-wrap">这只是 </span><span class="inline-wrap"><code>thiserror</code></span><span class="inline-wrap"> 宏库的一个简单示例，您可以根据自己的需求定义更复杂的错误类型和错误处理逻辑。</span></div></div></details></h1><div id="iD6nUQWoA42aD4MhXtvRZP" class="wolai-block wolai-text"><div></div></div></article><footer></footer></body></html>