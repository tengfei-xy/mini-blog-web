<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../css/wolai.css"/><title>变量 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="变量" class="main-title"></div></div></header><article><h1 id="qwyy7c16DDizCcmg8kykPe" class="wolai-block"><span class="inline-wrap">绑定</span><div id="piiync8u9K5UVhwsXDJ9ao" class="wolai-block wolai-text"><div><span class="inline-wrap">或称赋值，但变量绑定强调所有权</span></div></div><code-block id="3H9AvkiVG13AFJBG4aNry3" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token string">"hello world"</span></pre></div></code-block></h1><h1 id="27XuymUp6iQRyA7LB6qLzM" class="wolai-block"><span class="inline-wrap">可变性</span><div id="jnqm7vEQhNuyX8xY3etrbv" class="wolai-block wolai-text"><div><span class="inline-wrap">默认不可变，但可以通过</span><span class="inline-wrap"><code>mut</code></span><span class="inline-wrap">关键词让变量可变</span></div></div><code-block id="oZDqpNnGvEiPnZUE2ecrSQ" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token comment">// 错误</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The value of x is: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    x <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The value of x is: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 正确</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The value of x is: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    x <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The value of x is: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre></div></code-block></h1><h1 id="kTAQVNtRps514rHMx8aa9E" class="wolai-block"><span class="inline-wrap">作用域</span><div id="snRMmSeLkwyBCk3jkCgkK4" class="wolai-block wolai-text"><div><span class="blue inline-wrap">定义：</span><span class="inline-wrap">Rust 的作用域是指变量、函数和数据的可见性和生命周期。每个代码块内部形成一个独立的作用域，在该作用域中声明的变量和函数只在该作用域内可见。</span></div></div><div id="sv6M93DepeuEJpFk1er6LE" class="wolai-block wolai-text"><div><span class="blue inline-wrap">作用范围：</span><span class="inline-wrap">从声明到最后一次使用变量的范围，并不总是为</span><span class="inline-wrap"><code>{</code></span><span class="inline-wrap">开始和</span><span class="inline-wrap"><code>}</code></span><span class="inline-wrap">结束</span></div></div><div id="qSwGJVKnn2pFmk4TXNUmio" class="wolai-block wolai-text"><div><span class="blue inline-wrap">意义：</span><span class="inline-wrap">作用域规定了在程序中何处可以访问和使用特定的标识符。</span></div></div><details id="dhNFKvJDjz6d4wqrrtGiQ9" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">示例</span></summary><code-block id="sPmrc4V1LCoHZGbb7uubir" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// main 函数作用域开始</span>
    
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// x 在 main 函数作用域中可见</span>
    
    <span class="token punctuation">{</span> <span class="token comment">// 新的代码块开始</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// y 在新代码块作用域中可见</span>
        
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"x: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可以访问 x</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"y: {}"</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可以访问 y</span>
    <span class="token punctuation">}</span> <span class="token comment">// 新的代码块结束</span>
    
    <span class="token comment">// println!("y: {}", y); // 错误！y 不在该作用域中</span>
    
    <span class="token comment">// main 函数作用域结束</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="nuJr98B4yuks6RJAyQEEHr" class="wolai-block wolai-text"><div><span class="inline-wrap">在上面的示例中，</span><span class="inline-wrap"><code>x</code></span><span class="inline-wrap"> 变量被声明在 </span><span class="inline-wrap"><code>main</code></span><span class="inline-wrap"> 函数的作用域内，因此在整个 </span><span class="inline-wrap"><code>main</code></span><span class="inline-wrap"> 函数中都可以访问。另一方面，</span><span class="inline-wrap"><code>y</code></span><span class="inline-wrap"> 变量被声明在新的代码块作用域内，只能在该代码块内部使用。如果尝试在 </span><span class="inline-wrap"><code>y</code></span><span class="inline-wrap"> 的作用域之外访问它，将会导致编译错误。</span></div></div></details><div id="jM1GCMHn9Bu7BEyd4s1PMb" class="wolai-block wolai-text"><div><span class="blue inline-wrap">作用域与生命周期：</span><span class="inline-wrap">作用域还影响变量的生命周期。在 Rust 中，变量的生命周期是指变量从创建到销毁的整个时间范围。Rust 使用借用检查器（borrow checker）来确保引用的有效性和安全性。通过作用域规则和借用检查器，Rust 在编译时捕获潜在的内存管理错误，避免了许多常见的安全漏洞，如空指针引用和数据竞争。</span></div></div></h1><h1 id="hFcNS9iPYXBj7XYsHb5EQr" class="wolai-block"><span class="inline-wrap">解构</span><div id="hmSDSFidc3bgShnCR3iJsj" class="wolai-block wolai-text"><div><span class="blue inline-wrap">定义：</span><span class="inline-wrap">变量解构是指从一个复合数据结构（如元组、数组、结构体等）中提取和分配其内部的值给多个变量的过程。这种操作可以一次性地将复合数据结构中的值绑定到多个变量上，使得我们可以方便地访问和使用这些值。</span></div></div><div id="63ehNWQDpzc4bH2YtCweGm" class="wolai-block wolai-text"><div><span class="blue inline-wrap">意义：</span><span class="inline-wrap">解构提供了一种方便和灵活的方式来处理复合数据结构，并能在模式匹配和变量交换等场景中提供更高的表达能力和代码简洁性。</span></div></div><details id="jKVDpZS6GAs519Q4eUCrm8" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">元组解构</span></summary><code-block id="ufA1pMVAoVURABmfe1ZB3X" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> tuple <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span> <span class="token operator">=</span> tuple<span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"x: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出: x: 1</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"y: {}"</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出: y: hello</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"z: {}"</span><span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出: z: 3.14</span>
<span class="token punctuation">}</span></pre></div></code-block></details><details id="8aRPxbXbf8j5kAu6ZYKnuB" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">数组解构</span></summary><code-block id="aTyY3SmDsAkiCggazMTdDS" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"x: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出: x: 1</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"y: {}"</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出: y: 2</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"z: {}"</span><span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出: z: 3</span>
<span class="token punctuation">}</span></pre></div></code-block></details><details id="FyowHjgWvK8pmJby52udS" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">结构体解构</span></summary><code-block id="ktjehJ4gaotca8vCn59uWk" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">struct</span> <span class="token type-definition class-name">Point</span> <span class="token punctuation">{</span>
  x<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
  y<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> point <span class="token operator">=</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> point<span class="token punctuation">;</span>
  <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"x: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出: x: 5</span>
  <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"y: {}"</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出: y: 10</span>
<span class="token punctuation">}</span></pre></div></code-block></details></h1><h1 id="dsRoaKyjEU2NLxwyJphCy" class="wolai-block"><span class="inline-wrap">遮蔽（shadowing）</span><div id="p7cPN7VnwLzF78VsiG4QM5" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明：</span><span class="inline-wrap">Rust 允许声明相同的变量名，在后面声明的变量会遮蔽掉前面声明的，</span></div></div><details id="hfvJyptMddryAx1ERptFM9" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">示例</span></summary><code-block id="uk3CYDfxUEZxkVivH87GNC" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token comment">// 在main函数的作用域内对之前的x进行遮蔽</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token punctuation">{</span>
        <span class="token comment">// 在当前的花括号作用域内，对之前的x进行遮蔽</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token comment">// 输出16</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The value of x in the inner scope is: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 输出6</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"The value of x is: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block></details><div id="mR9MaTvqFMZDdzxEo7AVHc" class="wolai-block wolai-text"><div><span class="blue inline-wrap">用处：</span><span class="inline-wrap">如果你在某个作用域内无需再使用之前的变量（在被遮蔽后，无法再访问到之前的同名变量），就可以重复的使用变量名字，而不用绞尽脑汁去想更多的名字。</span></div></div></h1><h1 id="eyUWWpmcUChXhjEKMJNQVE" class="wolai-block"><span class="inline-wrap">忽略未使用的变量</span><div id="5wB2SUEHanhbbWZJp1AbHr" class="wolai-block wolai-text"><div><span class="inline-wrap">用下划线作为变量名的开头，让编译器忽略警告</span></div></div><code-block id="bckxrcJd7Q5WaGRwBR4FNK" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block></h1><h1 id="guxW45fHphargUySyxbSj1" class="wolai-block"><span class="inline-wrap">类型转化</span><div id="cjCjL4pugMn2wV2CfhNKcU" class="wolai-block wolai-text"><div><span class="inline-wrap">使用</span><span class="inline-wrap"><code>As</code></span><span class="inline-wrap">来完成一个类型到另一个类型的转换,</span><span class="inline-wrap"><a href="https://course.rs/advance/into-types/converse.html"><span>参考文档</span></a></span><span class="inline-wrap">。转换需要时显式的</span></div></div></h1><div id="8cbDHETyNg6xTgDV3eKgE3" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h1 id="qpserK7rfW52caqzjpTFco" class="wolai-block"><span class="inline-wrap">全局变量</span><details id="nmFdAvqv9xmeaFSueNZxM6" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">编译期间</span></summary><details id="5VNRjGGBRuZwYs9dxYLwCG" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>const</code></span><span class="inline-wrap">常量方式</span></summary><div id="iUoG7F7DmyBxmZsJbYhRP1" class="wolai-block wolai-text"><div><span class="inline-wrap">定义对象：定义</span><span class="inline-wrap">全局</span><span class="inline-wrap">静态变量的时候必须赋值为在编译期就可以计算出的值(常量表达式/数学表达式)，不能是运行时才能计算出的值(如函数)</span></div></div><code-block id="nXMcdfGrSUwh5dqTzcBqNi" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">const</span> <span class="token constant">MAX_ID</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span>  <span class="token keyword">usize</span><span class="token punctuation">::</span><span class="token constant">MAX</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"用户ID允许的最大值是{}"</span><span class="token punctuation">,</span><span class="token constant">MAX_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block></details><details id="2NaiXuAn97srvDAxZFp9rZ" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>static</code></span><span class="inline-wrap">全局静态变量</span><span class="inline-wrap">方式</span></summary><div id="2cJwRASDZyatiWHUPJZWBZ" class="wolai-block wolai-text"><div><span class="inline-wrap">定义对象：定义</span><span class="inline-wrap">全局</span><span class="inline-wrap">静态变量的时候必须赋值为在编译期就可以计算出的值(常量表达式/数学表达式)，不能是运行时才能计算出的值(如函数)</span></div></div><aside id="4Rnv4QdKoqiQCEPrJBDMeY" class="bg-cultured wolai-block"><div data-symbol="📌" class="icon"></div><span class="inline-wrap">Rust 要求必须使用</span><span class="inline-wrap"><code>unsafe</code></span><span class="inline-wrap">语句块才能访问和修改</span><span class="inline-wrap"><code>static</code></span><span class="inline-wrap">变量，因为这种使用方式往往并不安全，其实编译器是对的，当在多线程中同时去修改时，会不可避免的遇到脏数据。</span><span class="inline-wrap">只有在同一线程内或者不在乎数据的准确性时，才应该使用全局静态变量。</span></aside><code-block id="fdBSMMXKokzbpby6eL6KEt" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">static</span> <span class="token keyword">mut</span> <span class="token constant">REQUEST_RECV</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token constant">REQUEST_RECV</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token constant">REQUEST_RECV</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="sjX29DHcrZGY6D4Gg1foWp" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="dBPoQeESa5qz7oZvEXP56z" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div></details><details id="aNeyFjufrx2x46R4HFymvn" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>Atomic</code></span><span class="inline-wrap">创建</span><span class="inline-wrap"><a href="https://course.rs/advance/concurrency-with-threads/sync2.html"><span>原子类型</span></a></span></summary><div id="iKV7vhc8QXiuPJVMrgArZP" class="wolai-block wolai-text"><div><span class="inline-wrap">想要全局计数器、状态控制等功能，又想要线程安全的实现，原子类型是非常好的办法。</span></div></div><details id="uqeiesNaxJfVPnWDRTYfo7" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">示例</span></summary><details id="jYDhwXswGb7wwAj5MxT6wc" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">一般用法</span></summary><code-block id="6Zj9iY98jh2rg94v1R56fa" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>atomic<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">AtomicUsize</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token constant">REQUEST_RECV</span><span class="token punctuation">:</span> <span class="token class-name">AtomicUsize</span>  <span class="token operator">=</span> <span class="token class-name">AtomicUsize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">100</span> <span class="token punctuation">{</span>
        <span class="token constant">REQUEST_RECV</span><span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"当前用户请求数{:?}"</span><span class="token punctuation">,</span><span class="token constant">REQUEST_RECV</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block></details><details id="xfgmtVctteVMcqAxFNVksU" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">全局<span class="jill"></span>ID<span class="jill"></span>生成器</span></summary><code-block id="ii2Bk3nvryCyQAxyVhqiiZ" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>atomic<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Ordering</span><span class="token punctuation">,</span> <span class="token class-name">AtomicUsize</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Factory</span><span class="token punctuation">{</span>
    factory_id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token constant">GLOBAL_ID_COUNTER</span><span class="token punctuation">:</span> <span class="token class-name">AtomicUsize</span> <span class="token operator">=</span> <span class="token class-name">AtomicUsize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">MAX_ID</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token keyword">usize</span><span class="token punctuation">::</span><span class="token constant">MAX</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">generate_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-></span><span class="token keyword">usize</span><span class="token punctuation">{</span>
    <span class="token comment">// 检查两次溢出，否则直接加一可能导致溢出</span>
    <span class="token keyword">let</span> current_val <span class="token operator">=</span> <span class="token constant">GLOBAL_ID_COUNTER</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> current_val <span class="token operator">></span> <span class="token constant">MAX_ID</span><span class="token punctuation">{</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Factory ids overflowed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token constant">GLOBAL_ID_COUNTER</span><span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> next_id <span class="token operator">=</span> <span class="token constant">GLOBAL_ID_COUNTER</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> next_id <span class="token operator">></span> <span class="token constant">MAX_ID</span><span class="token punctuation">{</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Factory ids overflowed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    next_id
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Factory</span><span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">-></span><span class="token keyword">Self</span><span class="token punctuation">{</span>
        <span class="token keyword">Self</span><span class="token punctuation">{</span>
            factory_id<span class="token punctuation">:</span> <span class="token function">generate_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></div></code-block></details></details></details></details><details id="vFSnUJmj8NJfG6akTgtkMH" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">运行期间</span></summary><details id="giT7kgUzX7TrxLNjU9kTX7" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>lazy_static</code></span><span class="inline-wrap">用于懒初始化</span></summary><aside id="732g2MCLEdwFxW7NMi4J5S" class="bg-cultured wolai-block"><div data-symbol="📌" class="icon"></div><span class="inline-wrap">性能关注：使用</span><span class="inline-wrap"><code>lazy_static</code></span><span class="inline-wrap">在每次访问静态变量时，会有轻微的性能损失，因为其内部实现用了一个底层的并发原语</span><span class="inline-wrap"><code>std::sync::Once</code></span><span class="inline-wrap">，在每次访问该变量时，程序都会执行一次原子指令用于确认静态变量的初始化是否完成</span></aside><code-block id="sjor5iQebcNAevtZiEUAdi" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">lazy_static<span class="token punctuation">::</span></span>lazy_static<span class="token punctuation">;</span>
<span class="token macro property">lazy_static!</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">ref</span> <span class="token constant">NAMES</span><span class="token punctuation">:</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Sunface, Jack, Allen"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> v <span class="token operator">=</span> <span class="token constant">NAMES</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">", Myth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block></details><details id="7LaJPi9fpHy7M5yAc6V7zo" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>Box::leak</code></span><span class="inline-wrap">利用内存泄漏将一个变量的生命周期变为</span><span class="inline-wrap"><code>&#39;static</code></span></summary><div id="nsKA2k2Qig1hjgNMLtfkaX" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://course.rs/advance/global-variable.html#boxleak"><span>https://course.rs/advance/global-variable.html#boxleak</span></a></span></div></div></details><details id="qYYupc2Hdkj3GfiU4MHHD4" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>std::sync::OnceLock</code></span></summary><code-block id="fzrGiKWTgkjt3NpxHVv9TZ" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">OnceLock</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">structopt<span class="token punctuation">::</span></span><span class="token class-name">StructOpt</span><span class="token punctuation">;</span>
<span class="token attribute attr-name">#[derive(Debug, StructOpt)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Opt</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[structopt(short = <span class="token string">"f"</span>, long = <span class="token string">"file"</span>, help = <span class="token string">"指定文件名"</span>)]</span>
    filename<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>

    <span class="token attribute attr-name">#[structopt(short = <span class="token string">"a"</span>, long = <span class="token string">"output-full"</span>, help = <span class="token string">"输出完整地址"</span>)]</span>
    of<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token constant">OPT</span><span class="token punctuation">:</span> <span class="token class-name">OnceLock</span><span class="token operator">&lt;</span><span class="token class-name">Opt</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">OnceLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
         <span class="token constant">OPT</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token class-name">Opt</span><span class="token punctuation">::</span><span class="token function">from_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span><span class="token constant">OPT</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filename<span class="token punctuation">.</span><span class="token function">as_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block></details></details></h1><div id="kACLccVjVYRcECh7pv2x1q" class="wolai-block wolai-text"><div></div></div></article><footer></footer></body></html>