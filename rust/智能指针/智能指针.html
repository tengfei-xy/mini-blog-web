<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../css/wolai.css"/><title>智能指针 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="智能指针" class="main-title"></div></div></header><article><div id="8eXbTc1sviktF9vinqwLhw" class="wolai-block wolai-text"><div><span class="blue inline-wrap">定义：</span><span class="inline-wrap">智能指针是一种数据类型，通常是结构体类型，</span></div></div><div id="k4wqtRi4XVYMJLzi222e6p" class="wolai-block wolai-text"><div><span class="blue inline-wrap">作用：</span><span class="inline-wrap">智能指针可以在编译时捕获内存错误，避免常见的问题，如空指针引用和内存泄漏。此外，智能指针还允许你在不使用垃圾回收器的情况下进行内存管理。</span></div></div><div id="hvbA6WQBMZpf1EdUK71PZv" class="wolai-block wolai-text"><div><span class="blue inline-wrap">意义：</span><span class="inline-wrap">智能指针提供了对内存中分配的资源的所有权管理，实现了</span><span class="inline-wrap"><code>Deref</code></span><span class="inline-wrap">Trait</span><span class="inline-wrap"> 和 </span><span class="inline-wrap"><code>Drop</code></span><span class="inline-wrap">Trait，并提供了额外的功能和语义。</span></div></div><details id="pRg8LH7RmK2mU2Ho3xjGNw" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">特征</span></summary><div id="4pMArCreB6e3AmhQoTWB7" class="wolai-block wolai-text"><div><span class="inline-wrap"><code>Deref</code></span><span class="inline-wrap"> 可以让智能指针像引用那样工作，这样你就可以写出同时支持智能指针和引用的代码，例如 </span><span class="inline-wrap"><code>*T</code></span></div></div><div id="rZErPNFbMCVmPwKXmbUpii" class="wolai-block wolai-text"><div><span class="inline-wrap"><code>Drop</code></span><span class="inline-wrap"> 允许你指定智能指针超出作用域后自动执行的代码，例如做一些数据清除等收尾工作</span></div></div></details><details id="cJStqzrcTAUnZp8fCNtQwq" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>Box&lt;T&gt;</code></span></summary><div id="hu8hkj3AYJe7GT8af7kn1n" class="wolai-block wolai-text"><div><span class="blue inline-wrap">定义：</span><span class="inline-wrap"><code>Box&lt;T&gt;</code></span><span class="inline-wrap">是最简单的智能指针类型，它用于在堆上分配存储空间并拥有唯一所有权。</span></div></div><div id="8a193E87JjvzfM58JRaHYF" class="wolai-block wolai-text"><div><span class="blue inline-wrap">本质：</span><span class="inline-wrap">是调用 </span><span class="inline-wrap"><code>jemalloc</code></span><span class="inline-wrap"> 来做内存管理</span></div></div><div id="aVBY5arYsSCtTXfAWZXveR" class="wolai-block wolai-text"><div><span class="blue inline-wrap">作用：</span><span class="inline-wrap">在 Rust 中用于解决动态大小类型和所有权传递的问题。它提供了在堆上分配和管理内存的能力，允许处理无法在编译时确定大小的类型，并在需要传递所有权时提供高效的内存管理方式。</span></div></div><div id="xj4PPimHb8KAbjCiqWTFUG" class="wolai-block wolai-text"><div><span class="blue inline-wrap">结构体：</span><span class="inline-wrap"><a href="https://rustwiki.org/zh-CN/std/boxed/struct.Box.html"><span>文档</span></a></span></div></div><blockquote id="dYbaqR285C1N867G9vdpcK" class="wolai-block"><span class="inline-wrap">Boxes 为这个分配提供所有权，并在离开作用域时丢弃它们的内容。Boxes 还确保它们分配的字节数永远不会超过 </span><span class="inline-wrap"><code>isize::MAX</code></span><span class="inline-wrap"> 字节。 — — </span><span class="inline-wrap"><a href="https://rustwiki.org/zh-CN/std/boxed/index.html#"><span>标准库</span></a></span></blockquote><details id="7mFPaKTAJx6NH4xdsPkxch" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">使用场景</span></summary><div id="9Tqbbv1ocEtcPgiBis1tmU" class="wolai-block wolai-text"><div><span class="inline-wrap">说明：当你需要在编译时确定对象的大小或需要确保所有权是唯一的时候</span></div></div><details id="wCpsTGX9gNPqeYhQrFFGrx" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">特意的将数据分配在堆上</span></summary><div id="3z9TUPSGk8nfpkP7iL68Lu" class="wolai-block wolai-text"><div><span class="inline-wrap">通过创建 </span><span class="inline-wrap"><a href="https://rustwiki.org/zh-CN/std/boxed/struct.Box.html"><span><code>Box</code></span></a></span><span class="inline-wrap">，将值从栈移动到堆：</span></div></div><code-block id="kK7HrcVM75c9BNB3wZeu3s" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"a = {}"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a = 3</span>

    <span class="token comment">// 下面一行代码将报错</span>
    <span class="token comment">// let b = a + 1; // cannot add `{integer}` to `Box&lt;{integer}>`</span>
<span class="token punctuation">}</span></pre></div></code-block><ul class="wolai-block"><li id="tpFMX8a52JfUBxDYcFTRjm"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>println!</code></span><span class="inline-wrap"> 可以正常打印出 </span><span class="inline-wrap"><code>a</code></span><span class="inline-wrap"> 的值，是因为它隐式地调用了 </span><span class="inline-wrap"><code>Deref</code></span><span class="inline-wrap"> 对智能指针 </span><span class="inline-wrap"><code>a</code></span><span class="inline-wrap"> 进行了解引用</span></li><li id="sBwggTxo4UfZ8e2KmRDs2r"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">最后一行代码 </span><span class="inline-wrap"><code>let b = a + 1</code></span><span class="inline-wrap"> 报错，是因为在表达式中，我们无法自动隐式地执行 </span><span class="inline-wrap"><code>Deref</code></span><span class="inline-wrap"> 解引用操作，你需要使用 </span><span class="inline-wrap"><code>*</code></span><span class="inline-wrap"> 操作符 </span><span class="inline-wrap"><code>let b = *a + 1</code></span><span class="inline-wrap">，来显式的进行解引用</span></li><li id="38e9rZLLC9x9AxRCnXAPdf"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>a</code></span><span class="inline-wrap"> 持有的智能指针将在作用域结束（</span><span class="inline-wrap"><code>main</code></span><span class="inline-wrap"> 函数结束）时，被释放掉，这是因为 </span><span class="inline-wrap"><code>Box&lt;T&gt;</code></span><span class="inline-wrap"> 实现了 </span><span class="inline-wrap"><code>Drop</code></span><span class="inline-wrap"> 特征</span></li></ul></details><details id="b7jSbo1iyG4PppqrdewQH1" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">数据较大时，又不想在转移所有权时进行数据拷贝</span></summary><code-block id="wJnv3zBKGqSM4mvjjTa23r" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">LargeData</span> <span class="token punctuation">{</span>
    <span class="token comment">// 假设这里有很大的数据</span>
    data<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">process_data</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">LargeData</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在这里对数据进行处理</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Processing data with size: {}"</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> large_data <span class="token operator">=</span> <span class="token class-name">LargeData</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">1_000_000</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 假设这里有 1MB 的数据</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> boxed_data <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>large_data<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">process_data</span><span class="token punctuation">(</span>boxed_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Finished processing data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="2NMX4yvGY1JPtM2ELgAVFK" class="wolai-block wolai-text"><div><span class="inline-wrap">在这个示例中，我们定义了一个 </span><span class="inline-wrap"><code>LargeData</code></span><span class="inline-wrap"> 结构体，其中包含了一个较大的数据（这里假设为 </span><span class="inline-wrap"><code>Vec&lt;u8&gt;</code></span><span class="inline-wrap">）。我们通过实现 </span><span class="inline-wrap"><code>Clone</code></span><span class="inline-wrap"> trait 来允许对 </span><span class="inline-wrap"><code>LargeData</code></span><span class="inline-wrap"> 进行拷贝。</span></div></div><div id="86ix68yEoP4h9mKgvKMV6T" class="wolai-block wolai-text"><div><span class="inline-wrap">然后，我们定义了一个 </span><span class="inline-wrap"><code>process_data</code></span><span class="inline-wrap"> 函数，它接收一个 </span><span class="inline-wrap"><code>Box&lt;LargeData&gt;</code></span><span class="inline-wrap"> 参数。在这个函数中，我们可以对数据进行处理。在这里，我们只是打印了数据的大小。</span></div></div><div id="d5DFbus7TPq9KetWiv4T8d" class="wolai-block wolai-text"><div><span class="inline-wrap">在 </span><span class="inline-wrap"><code>main</code></span><span class="inline-wrap"> 函数中，我们创建了一个 </span><span class="inline-wrap"><code>large_data</code></span><span class="inline-wrap"> 对象，其中包含了较大的数据。然后，我们使用 </span><span class="inline-wrap"><code>clone</code></span><span class="inline-wrap"> 方法创建了一个 </span><span class="inline-wrap"><code>boxed_data</code></span><span class="inline-wrap">，它是一个 </span><span class="inline-wrap"><code>Box&lt;LargeData&gt;</code></span><span class="inline-wrap"> 类型的拷贝。接着，我们将 </span><span class="inline-wrap"><code>boxed_data</code></span><span class="inline-wrap"> 传递给 </span><span class="inline-wrap"><code>process_data</code></span><span class="inline-wrap"> 函数进行处理。</span></div></div><div id="8WqotjcscR2qpwemsHABYm" class="wolai-block wolai-text"><div><span class="inline-wrap">通过使用 </span><span class="inline-wrap"><code>Box&lt;T&gt;</code></span><span class="inline-wrap">，我们在堆上分配了 </span><span class="inline-wrap"><code>LargeData</code></span><span class="inline-wrap"> 对象，并在拷贝时只复制了指针，而不是整个数据。这可以提高性能并减少内存消耗，特别是在处理较大的数据时。</span></div></div><div id="tn8gYq9SLK9nanffpPfxhg" class="wolai-block wolai-text"><div><span class="inline-wrap">请注意，由于 </span><span class="inline-wrap"><code>LargeData</code></span><span class="inline-wrap"> 实现了 </span><span class="inline-wrap"><code>Clone</code></span><span class="inline-wrap"> trait，我们可以使用 </span><span class="inline-wrap"><code>clone</code></span><span class="inline-wrap"> 方法创建 </span><span class="inline-wrap"><code>boxed_data</code></span><span class="inline-wrap"> 的拷贝。如果你的数据类型没有实现 </span><span class="inline-wrap"><code>Clone</code></span><span class="inline-wrap">，你需要考虑其他的拷贝方式，如使用 </span><span class="inline-wrap"><code>Rc&lt;T&gt;</code></span><span class="inline-wrap"> 或 </span><span class="inline-wrap"><code>Arc&lt;T&gt;</code></span><span class="inline-wrap"> 来进行引用计数。</span></div></div></details><details id="sGenYeT3k9tkcLMNoYcktp" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">类型的大小在编译期无法确定，但是我们又需要固定大小的类型时</span></summary><code-block id="fqisXhW1EJM4GM2LqjTmTB" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建一个动态大小的类型 `DynamicType` 的实例，并将其放入 `Box` 中</span>
    <span class="token keyword">let</span> dynamic_value<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">DynamicType</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">ConcreteType</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 调用 `DynamicType` trait 的方法，这是一个动态分发的过程</span>
    dynamic_value<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义一个动态大小的类型 `DynamicType`，它是一个 trait,它代表了一个动态大小的类型</span>
<span class="token keyword">trait</span> <span class="token type-definition class-name">DynamicType</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义一个实现了 `DynamicType` trait 的具体类型 `ConcreteType`</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">ConcreteType</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">ConcreteType</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConcreteType</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">DynamicType</span> <span class="token keyword">for</span> <span class="token class-name">ConcreteType</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Value: {}"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="oPGMcEaZy6T9BQopvUkLNs" class="wolai-block wolai-text"><div><span class="inline-wrap">在上面的示例中，我们定义了一个 </span><span class="inline-wrap"><code>DynamicType</code></span><span class="inline-wrap"> trait，它代表了一个动态大小的类型。然后，我们实现了这个 trait 的具体类型 </span><span class="inline-wrap"><code>ConcreteType</code></span><span class="inline-wrap">，它包含一个 </span><span class="inline-wrap"><code>i32</code></span><span class="inline-wrap"> 类型的值。在 </span><span class="inline-wrap"><code>main</code></span><span class="inline-wrap"> 函数中，我们创建了一个 </span><span class="inline-wrap"><code>ConcreteType</code></span><span class="inline-wrap"> 的实例，并将其放入 </span><span class="inline-wrap"><code>Box&lt;dyn DynamicType&gt;</code></span><span class="inline-wrap"> 中。这样，我们就可以通过 </span><span class="inline-wrap"><code>dynamic_value</code></span><span class="inline-wrap"> 调用 </span><span class="inline-wrap"><code>DynamicType</code></span><span class="inline-wrap"> trait 的方法 </span><span class="inline-wrap"><code>foo()</code></span><span class="inline-wrap">，并且会在运行时动态分发到 </span><span class="inline-wrap"><code>ConcreteType</code></span><span class="inline-wrap"> 的实现。</span></div></div><div id="3nDRkYBdxeD3GZ6cM9tGtt" class="wolai-block wolai-text"><div><span class="inline-wrap">使用 </span><span class="inline-wrap"><code>Box&lt;T&gt;</code></span><span class="inline-wrap"> 可以在编译期无法确定类型大小的情况下，为类型提供固定大小的存储空间，并进行所有权管理和自动清理。</span></div></div></details><details id="hck1cAT3Up1k6wvcWgCJ1H" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">特征对象</span></summary><div id="tDFqXz7Lc4zqkgPLGm4R12" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明：</span><span class="inline-wrap">使用 trait 对象和 </span><span class="inline-wrap"><code>Box&lt;T&gt;</code></span><span class="inline-wrap"> 来实现包含不同类型的数组。</span></div></div><code-block id="eM16njpD72YjjJ3KKSqDt9" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">trait</span> <span class="token type-definition class-name">Shape</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">area</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Circle</span> <span class="token punctuation">{</span>
    radius<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Shape</span> <span class="token keyword">for</span> <span class="token class-name">Circle</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">area</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">{</span>
        <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">f64</span><span class="token punctuation">::</span><span class="token namespace">consts<span class="token punctuation">::</span></span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>radius <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>radius
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Rectangle</span> <span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Shape</span> <span class="token keyword">for</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">area</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> shapes<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Shape</span><span class="token operator">>></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Circle</span> <span class="token punctuation">{</span> radius<span class="token punctuation">:</span> <span class="token number">3.0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Rectangle</span> <span class="token punctuation">{</span> width<span class="token punctuation">:</span> <span class="token number">4.0</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">5.0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> shape <span class="token keyword">in</span> shapes <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Area: {}"</span><span class="token punctuation">,</span> shape<span class="token punctuation">.</span><span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="mCjFRBhRRy3HkoAR928PVA" class="wolai-block wolai-text"><div><span class="inline-wrap">在这个示例中，我们定义了一个 </span><span class="inline-wrap"><code>Shape</code></span><span class="inline-wrap"> trait，它有一个 </span><span class="inline-wrap"><code>area</code></span><span class="inline-wrap"> 方法来计算形状的面积。然后我们实现了 </span><span class="inline-wrap"><code>Circle</code></span><span class="inline-wrap"> 和 </span><span class="inline-wrap"><code>Rectangle</code></span><span class="inline-wrap"> 结构体，并为它们分别实现了 </span><span class="inline-wrap"><code>Shape</code></span><span class="inline-wrap"> trait。</span></div></div><div id="wEJNMGBP1RNEeJiuG8BEaB" class="wolai-block wolai-text"><div><span class="inline-wrap">在 </span><span class="inline-wrap"><code>main</code></span><span class="inline-wrap"> 函数中，我们创建了一个 </span><span class="inline-wrap"><code>shapes</code></span><span class="inline-wrap"> 数组，其中包含了两个不同类型的对象：</span><span class="inline-wrap"><code>Circle</code></span><span class="inline-wrap"> 和 </span><span class="inline-wrap"><code>Rectangle</code></span><span class="inline-wrap">。这些对象被包装在 </span><span class="inline-wrap"><code>Box&lt;dyn Shape&gt;</code></span><span class="inline-wrap"> 中，使它们成为 trait 对象。通过使用 </span><span class="inline-wrap"><code>dyn</code></span><span class="inline-wrap"> 关键字，我们可以在数组中存储不同类型的对象。</span></div></div><div id="qoaKcnNpGxCr93xAHFgUB2" class="wolai-block wolai-text"><div><span class="inline-wrap">在循环中，我们遍历 </span><span class="inline-wrap"><code>shapes</code></span><span class="inline-wrap"> 数组并调用每个对象的 </span><span class="inline-wrap"><code>area</code></span><span class="inline-wrap"> 方法来计算面积，并打印出结果。</span></div></div><div id="jm6RvmmzhyTevbAP9eKu9X" class="wolai-block wolai-text"><div><span class="inline-wrap">这样，我们就通过特征对象实现了一个包含不同类型的数组，并且使用了 </span><span class="inline-wrap"><code>Box&lt;T&gt;</code></span><span class="inline-wrap"> 来对对象进行堆分配。</span></div></div></details></details><details id="jybLJFq98u8HvbdM2DVhkY" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">创建递归数据结构</span></summary><code-block id="6gJxzUxQU2LKigqbRoCASP" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token class-name">Nil</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> list<span class="token punctuation">:</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">::</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">::</span><span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{list:?}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></details></details><details id="aUmcTrt6ScojxL92XQ7WMe" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>Rc&lt;T&gt;</code></span></summary><div id="5Ma3C7e29HZVEoWCf2UAbm" class="wolai-block wolai-text"><div><span class="inline-wrap"><code>Rc&lt;T&gt;</code></span><span class="inline-wrap">代表引用计数（Reference Counting）智能指针。它允许多个所有者共享相同的数据，通过跟踪对目标对象的引用数量来管理所有权。当引用计数为零时，对象将被自动释放。</span><span class="inline-wrap"><code>Rc&lt;T&gt;</code></span><span class="inline-wrap">只能用于单线程环境。</span></div></div></details><details id="fpBWYdAn2MHHYGxmRpUEP5" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>Arc&lt;T&gt;</code></span></summary><div id="b5jB4dLDojERndKwiRAj2B" class="wolai-block wolai-text"><div><span class="inline-wrap"><code>Arc&lt;T&gt;</code></span><span class="inline-wrap">是</span><span class="inline-wrap"><code>Rc&lt;T&gt;</code></span><span class="inline-wrap">的线程安全版本，它可以在多个线程之间共享数据。</span><span class="inline-wrap"><code>Arc&lt;T&gt;</code></span><span class="inline-wrap">使用了原子操作来跟踪引用计数，以确保线程安全性。</span></div></div></details><div id="x6mkgKR4sqfs4xYGUVU2nQ" class="wolai-block wolai-text"><div></div></div></article><footer></footer></body></html>