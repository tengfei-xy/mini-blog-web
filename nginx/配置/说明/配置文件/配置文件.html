<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>配置文件 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font less-lead"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="配置文件" class="main-title"></div></div></header><article><div id="rxhXkWnPUtdS8w9xx9dgAp" class="wolai-block wolai-text"><div><span class="inline-wrap">Nginx<span class="jill"></span>的主配置文件是<span class="jill"></span>nginx.conf，这个配置文件一共由三部分组成，分别为</span><span class="inline-wrap"><b>全局块、events<span class="jill"></span>块和<span class="jill"></span>http<span class="jill"></span>块</b></span><span class="inline-wrap">。在<span class="jill"></span>http<span class="jill"></span>块中，又包含<span class="jill"></span>http<span class="jill"></span>全局块、多个<span class="jill"></span>server<span class="jill"></span>块。每个<span class="jill"></span>server<span class="jill"></span>块中，可以包含<span class="jill"></span>server<span class="jill"></span>全局块和多个<span class="jill"></span>location<span class="jill"></span>块。在同一配置块中嵌套的配置块，各个之间不存在次序关系。</span></div></div><div id="wy8uDXJAFUZnuiHCowgxSn" class="wolai-block wolai-text"><div><span class="inline-wrap">配置文件支持大量可配置的指令，绝大多数指令不是特定属于某一个块的。同一个指令放在不同层级的块中，其作用域也不同，一般情况下，高一级块中的指令可以作用于自身所在的块和此块包含的所有低层级块。如果某个指令在两个不同层级的块中同时出现，则采用“就近原则”，即以较低层级块中的配置为准。比如，某指令同时出现在<span class="jill"></span>http<span class="jill"></span>全局块中和<span class="jill"></span>server<span class="jill"></span>块中，并且配置不同，则应该以<span class="jill"></span>server<span class="jill"></span>块中的配置为准。</span></div></div><div id="1sY37uiyU4vAJiJCVVPCPx" class="wolai-block wolai-text"><div><span class="inline-wrap">整个配置文件的结构大致如下：</span></div></div><code-block id="8U7yWvZkYd3ZSmGi8YRjoq" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">#全局块
#user  nobody<span class="token punctuation">;</span>
worker_processes  <span class="token number">1</span><span class="token punctuation">;</span>

#event块
events <span class="token punctuation">{</span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

#http块
http <span class="token punctuation">{</span>
    #http全局块
    include       mime<span class="token punctuation">.</span><span class="token property-access">types</span><span class="token punctuation">;</span>
    default_type  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>
    sendfile        on<span class="token punctuation">;</span>
    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span>
    #server块
    server <span class="token punctuation">{</span>
        #server全局块
        listen       <span class="token number">8000</span><span class="token punctuation">;</span>
        server_name  localhost<span class="token punctuation">;</span>
        #<span class="token dom variable">location</span>块
        <span class="token dom variable">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
            index  index<span class="token punctuation">.</span><span class="token property-access">html</span> index<span class="token punctuation">.</span><span class="token property-access">htm</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  <span class="token operator">/</span>50x<span class="token punctuation">.</span><span class="token property-access">html</span><span class="token punctuation">;</span>
        <span class="token dom variable">location</span> <span class="token operator">=</span> <span class="token operator">/</span>50x<span class="token punctuation">.</span><span class="token property-access">html</span> <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    #这边可以有多个server块
    server <span class="token punctuation">{</span>
      <span class="token spread operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><h2 id="4aFgWoktMEUQFMfx1jtEWm" class="wolai-block"><span class="inline-wrap">全局块</span></h2><div id="xj29dcoEVscpsyANkg8NEV" class="wolai-block wolai-text"><div><span class="inline-wrap">全局块是默认配置文件从开始到<span class="jill"></span>events<span class="jill"></span>块之间的一部分内容，主要设置一些影响<span class="jill"></span>Nginx<span class="jill"></span>服务器整体运行的配置指令，因此，这些指令的作用域是<span class="jill"></span>Nginx<span class="jill"></span>服务器全局。</span></div></div><div id="21e1AyCvfPh82FfLGu5aLH" class="wolai-block wolai-text"><div><span class="inline-wrap">通常包括配置运行<span class="jill"></span>Nginx<span class="jill"></span>服务器的用户（组）、允许生成的<span class="jill"></span>worker process<span class="jill"></span>数、Nginx<span class="jill"></span>进程<span class="jill"></span>PID<span class="jill"></span>存放路径、日志的存放路径和类型以及配置文件引入等。</span></div></div><code-block id="cDtGs1wb2BMpzLLixriFqp" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"># 指定可以运行nginx服务的用户和用户组，只能在全局块配置
# user <span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token punctuation">[</span>group<span class="token punctuation">]</span>
# 将user指令注释掉，或者配置成nobody的话所有用户都可以运行
# user nobody nobody<span class="token punctuation">;</span>
# user指令在Windows上不生效，如果你制定具体用户和用户组会报小面警告
# nginx<span class="token operator">:</span> <span class="token punctuation">[</span>warn<span class="token punctuation">]</span> <span class="token string">"user"</span> is not supported<span class="token punctuation">,</span> ignored <span class="token keyword">in</span> <span class="token constant">D</span><span class="token operator">:</span>\software\nginx<span class="token operator">-</span><span class="token number">1.18</span><span class="token number">.0</span><span class="token operator">/</span>conf<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token property-access">conf</span><span class="token operator">:</span><span class="token number">2</span>

# 指定工作线程数，可以制定具体的进程数，也可使用自动模式，这个指令只能在全局块配置
# worker_processes number <span class="token operator">|</span> auto；
# 列子：指定<span class="token number">4</span>个工作线程，这种情况下会生成一个master进程和<span class="token number">4</span>个worker进程
# worker_processes <span class="token number">4</span><span class="token punctuation">;</span>

# 指定pid文件存放的路径，这个指令只能在全局块配置
# pid logs<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">;</span>

# <span class="token function">指定错误日志的路径和日志级别，此指令可以在全局块、http块、server块以及location块中配置。</span><span class="token punctuation">(</span>在不同的块配置有啥区别？？<span class="token punctuation">)</span>
# 其中debug级别的日志需要编译时使用<span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>debug开启debug开关
# error_log <span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token punctuation">[</span>debug <span class="token operator">|</span> info <span class="token operator">|</span> notice <span class="token operator">|</span> warn <span class="token operator">|</span> error <span class="token operator">|</span> crit <span class="token operator">|</span> alert <span class="token operator">|</span> emerg<span class="token punctuation">]</span> 
# error_log  logs<span class="token operator">/</span>error<span class="token punctuation">.</span><span class="token property-access">log</span>  notice<span class="token punctuation">;</span>
# error_log  logs<span class="token operator">/</span>error<span class="token punctuation">.</span><span class="token property-access">log</span>  info<span class="token punctuation">;</span></pre></div></code-block><h2 id="hbjCe9yQVTm3DRoQP9qUNR" class="wolai-block"><span class="inline-wrap">events<span class="jill"></span>块</span></h2><div id="vsJuoMvHSsMqnY87SAA3sW" class="wolai-block wolai-text"><div><span class="inline-wrap">events<span class="jill"></span>块涉及的指令主要影响<span class="jill"></span>Nginx<span class="jill"></span>服务器与用户的网络连接。常用到的设置包括是否开启对多<span class="jill"></span>worker process<span class="jill"></span>下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型处理连接请求，每个<span class="jill"></span>worker process<span class="jill"></span>可以同时支持的最大连接数等。</span></div></div><div id="aW5TbHF2xbCwJT7rrMV1DM" class="wolai-block wolai-text"><div><span class="inline-wrap">这一部分的指令对<span class="jill"></span>Nginx<span class="jill"></span>服务器的性能影响较大，在实际配置中应该根据实际情况灵活调整。</span></div></div><code-block id="n2mPvD7thiXmSx9uNJ8xYu" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"># 当某一时刻只有一个网络连接到来时，多个睡眠进程会被同时叫醒，但只有一个进程可获得连接。如果每次唤醒的进程数目太多，会影响一部分系统性能。在Nginx服务器的多进程下，就有可能出现这样的问题。
# 开启的时候，将会对多个Nginx进程接收连接进行序列化，防止多个进程对连接的争抢
# 默认是开启状态，只能在events块中进行配置
# accept_mutex on <span class="token operator">|</span> off<span class="token punctuation">;</span>

# 如果multi_accept被禁止了，nginx一个工作进程只能同时接受一个新的连接。否则，一个工作进程可以同时接受所有的新连接。 
# 如果nginx使用kqueue连接方法，那么这条指令会被忽略，因为这个方法会报告在等待被接受的新连接的数量。
# 默认是off状态，只能在event块配置
# multi_accept on <span class="token operator">|</span> off<span class="token punctuation">;</span>

# 指定使用哪种网络<span class="token constant">IO</span>模型，method可选择的内容有：select、poll、kqueue、epoll、rtsig、<span class="token operator">/</span>dev<span class="token operator">/</span>poll以及eventport，一般操作系统不是支持上面所有模型的。
# 只能在events块中进行配置
# use method
# use epoll

# 设置允许每一个worker process同时开启的最大连接数，当每个工作进程接受的连接数超过这个值时将不再接收连接
# 当所有的工作进程都接收满时，连接进入logback，logback满后连接被拒绝
# 只能在events块中进行配置
# 注意：这个值不能超过超过系统支持打开的最大文件数，也不能超过单个进程支持打开的最大文件数，具体可以参考这篇文章：https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span><span class="token property-access">tencent</span><span class="token punctuation">.</span><span class="token property-access">com</span><span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1114773</span>
# worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span></pre></div></code-block><h2 id="6B2yb5TjpUfKzUSwArhX9N" class="wolai-block"><span class="inline-wrap">http<span class="jill"></span>块</span></h2><div id="fzVdHDV1Qs5CMn3bUFQkcU" class="wolai-block wolai-text"><div><span class="inline-wrap">http<span class="jill"></span>块是<span class="jill"></span>Nginx<span class="jill"></span>服务器配置中的重要部分，代理、缓存和日志定义等绝大多数的功能和第三方模块的配置都可以放在这个模块中。</span></div></div><div id="ryFgaac3woJkCUqXv23zAE" class="wolai-block wolai-text"><div><span class="inline-wrap">前面已经提到，http<span class="jill"></span>块中可以包含自己的全局块，也可以包含<span class="jill"></span>server<span class="jill"></span>块，server<span class="jill"></span>块中又可以进一步包含<span class="jill"></span>location<span class="jill"></span>块，在本书中我们使用“http<span class="jill"></span>全局块”来表示<span class="jill"></span>http<span class="jill"></span>中自己的全局块，即<span class="jill"></span>http<span class="jill"></span>块中不包含在<span class="jill"></span>server<span class="jill"></span>块中的部分。</span></div></div><div id="apSLpw1zphjDGskeqKdHfU" class="wolai-block wolai-text"><div><span class="inline-wrap">可以在<span class="jill"></span>http<span class="jill"></span>全局块中配置的指令包括文件引入、MIME-Type<span class="jill"></span>定义、日志自定义、是否使用<span class="jill"></span>sendfile<span class="jill"></span>传输文件、连接超时时间、单连接请求数上限等。</span></div></div><code-block id="sBcvFFmgaX6kcCt4jHXfoX" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"># 常用的浏览器中，可以显示的内容有<span class="token constant">HTML</span>、<span class="token constant">XML</span>、<span class="token constant">GIF</span>及Flash等种类繁多的文本、媒体等资源，浏览器为区分这些资源，需要使用<span class="token constant">MIME</span> <span class="token maybe-class-name">Type。换言之，</span><span class="token constant">MIME</span> <span class="token maybe-class-name">Type是网络资源的媒体类型。Nginx服务器作为Web服务器，必须能够识别前端请求的资源类型。</span>

# include指令，用于包含其他的配置文件，可以放在配置文件的任何地方，但是要注意你包含进来的配置文件一定符合配置规范，比如说你include进来的配置是worker_processes指令的配置，而你将这个指令包含到了http块中，着肯定是不行的，上面已经介绍过worker_processes指令只能在全局块中。
# 下面的指令将mime<span class="token punctuation">.</span><span class="token property-access">types包含进来，mime</span><span class="token punctuation">.</span><span class="token property-access">types和ngin</span><span class="token punctuation">.</span><span class="token property-access">cfg同级目录，不同级的话需要指定具体路径</span>
# include  mime<span class="token punctuation">.</span><span class="token property-access">types</span><span class="token punctuation">;</span>

# 配置默认类型，如果不加此指令，默认值为text<span class="token operator">/</span>plain。
# 此指令还可以在http块、server块或者<span class="token dom variable">location</span>块中进行配置。
# default_type  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>

# access_log配置，此指令可以在http块、server块或者<span class="token dom variable">location</span>块中进行设置
# 在全局块中，我们介绍过errer_log指令，其用于配置Nginx进程运行时的日志存放和级别，此处所指的日志与常规的不同，它是指记录Nginx服务器提供服务过程应答前端请求的日志
# access_log path <span class="token punctuation">[</span>format <span class="token punctuation">[</span>buffer<span class="token operator">=</span>size<span class="token punctuation">]</span><span class="token punctuation">]</span>
# 如果你要关闭access_log<span class="token punctuation">,</span>你可以使用下面的命令
# access_log off<span class="token punctuation">;</span>

# log_format指令，用于定义日志格式，此指令只能在http块中进行配置
# log_format  main <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" '</span>
#                  <span class="token string">'$status $body_bytes_sent "$http_referer" '</span>
#                  <span class="token string">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="token punctuation">;</span>
# 定义了上面的日志格式后，可以以下面的形式使用日志
# access_log  logs<span class="token operator">/</span>access<span class="token punctuation">.</span><span class="token property-access">log</span>  main<span class="token punctuation">;</span>

# 开启关闭sendfile方式传输文件，可以在http块、server块或者<span class="token dom variable">location</span>块中进行配置
# sendfile  on <span class="token operator">|</span> off<span class="token punctuation">;</span>

# 设置sendfile最大数据量<span class="token punctuation">,</span>此指令可以在http块、server块或<span class="token dom variable">location</span>块中配置
# sendfile_max_chunk size<span class="token punctuation">;</span>
# 其中，size值如果大于<span class="token number">0</span>，Nginx进程的每个worker <span class="token function">process每次调用sendfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">传输的数据量最大不能超过这个值</span><span class="token punctuation">(</span>这里是128k，所以每次不能超过128k<span class="token punctuation">)</span>；如果设置为<span class="token number">0</span>，则无限制。默认值为<span class="token number">0</span>。
# sendfile_max_chunk 128k<span class="token punctuation">;</span>

# 配置连接超时时间<span class="token punctuation">,</span>此指令可以在http块、server块或<span class="token dom variable">location</span>块中配置。
# 与用户建立会话连接后，Nginx服务器可以保持这些连接打开一段时间
# timeout，服务器端对连接的保持时间。默认值为75s<span class="token punctuation">;</span>header_timeout，可选项，在应答报文头部的Keep<span class="token operator">-</span><span class="token maybe-class-name">Alive域设置超时时间：“Keep</span><span class="token operator">-</span><span class="token maybe-class-name">Alive</span><span class="token operator">:</span>timeout<span class="token operator">=</span> header_timeout”。报文中的这个指令可以被Mozilla或者Konqueror识别。
# keepalive_timeout timeout <span class="token punctuation">[</span>header_timeout<span class="token punctuation">]</span>
# 下面配置的含义是，在服务器端保持连接的时间设置为<span class="token number">120</span> s，发给用户端的应答报文头部中Keep<span class="token operator">-</span><span class="token maybe-class-name">Alive域的超时时间设置为</span><span class="token number">100</span> s。
# keepalive_timeout 120s 100s

# 配置单连接请求数上限，此指令可以在http块、server块或<span class="token dom variable">location</span>块中配置。
# <span class="token maybe-class-name">Nginx服务器端和用户端建立会话连接后，用户端通过此连接发送请求。指令keepalive_requests用于限制用户通过某一连接向Nginx服务器发送请求的次数。默认是</span><span class="token number">100</span>
# keepalive_requests number<span class="token punctuation">;</span></pre></div></code-block><h2 id="2mgp7mFSAPE6n1E4Wzo6Uu" class="wolai-block"><span class="inline-wrap">server<span class="jill"></span>块</span></h2><div id="g68et3ZSsERkEs5MYavVKf" class="wolai-block wolai-text"><div><span class="inline-wrap">server<span class="jill"></span>块和“虚拟主机”的概念有密切联系。</span></div></div><div id="kAmzGcpGMhMe1ErFxXCN12" class="wolai-block wolai-text"><div><span class="inline-wrap">虚拟主机，又称虚拟服务器、主机空间或是网页空间，它是一种技术。该技术是为了节省互联网服务器硬件成本而出现的。这里的“主机”或“空间”是由实体的服务器延伸而来，硬件系统可以基于服务器群，或者单个服务器等。虚拟主机技术主要应用于<span class="jill"></span>HTTP、FTP<span class="jill"></span>及<span class="jill"></span>EMAIL<span class="jill"></span>等多项服务，将一台服务器的某项或者全部服务内容逻辑划分为多个服务单位，对外表现为多个服务器，从而充分利用服务器硬件资源。从用户角度来看，一台虚拟主机和一台独立的硬件主机是完全一样的。</span></div></div><div id="scDt3oTxtqdHf1Z5sMsDZG" class="wolai-block wolai-text"><div><span class="inline-wrap">在使用<span class="jill"></span>Nginx<span class="jill"></span>服务器提供<span class="jill"></span>Web<span class="jill"></span>服务时，利用虚拟主机的技术就可以避免为每一个要运行的网站提供单独的<span class="jill"></span>Nginx<span class="jill"></span>服务器，也无需为每个网站对应运行一组<span class="jill"></span>Nginx<span class="jill"></span>进程。虚拟主机技术使得<span class="jill"></span>Nginx<span class="jill"></span>服务器可以在同一台服务器上只运行一组<span class="jill"></span>Nginx<span class="jill"></span>进程，就可以运行多个网站。</span></div></div><div id="1EQkw5WNRDEnYnXNkUv7Gg" class="wolai-block wolai-text"><div><span class="inline-wrap">在前面提到过，每一个<span class="jill"></span>http<span class="jill"></span>块都可以包含多个<span class="jill"></span>server<span class="jill"></span>块，而每个<span class="jill"></span>server<span class="jill"></span>块就相当于一台虚拟主机，它内部可有多台主机联合提供服务，一起对外提供在逻辑上关系密切的一组服务（或网站）。</span></div></div><div id="fA5MDCifDnHPKGAnK73eTw" class="wolai-block wolai-text"><div><span class="inline-wrap">和<span class="jill"></span>http<span class="jill"></span>块相同，server<span class="jill"></span>块也可以包含自己的全局块，同时可以包含多个<span class="jill"></span>location<span class="jill"></span>块。在<span class="jill"></span>server<span class="jill"></span>全局块中，最常见的两个配置项是本虚拟主机的监听配置和本虚拟主机的名称或<span class="jill"></span>IP<span class="jill"></span>配置。</span></div></div><h3 id="kcK9K6GyCuYF5cZzvcMWhJ" class="wolai-block"><span class="inline-wrap">listen<span class="jill"></span>指令</span></h3><div id="5kgPTmHSgbjiVVKCkx8RWr" class="wolai-block wolai-text"><div><span class="inline-wrap">server<span class="jill"></span>块中最重要的指令就是<span class="jill"></span>listen<span class="jill"></span>指令，这个指令有三种配置语法。这个指令默认的配置值是：listen *:80 | *:8000；只能在<span class="jill"></span>server<span class="jill"></span>块种配置这个指令。</span></div></div><code-block id="hbsZNHEcfvnDN7opEUyFU1" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token comment">//第一种</span>
listen address<span class="token punctuation">[</span><span class="token operator">:</span>port<span class="token punctuation">]</span> <span class="token punctuation">[</span>default_server<span class="token punctuation">]</span> <span class="token punctuation">[</span>ssl<span class="token punctuation">]</span> <span class="token punctuation">[</span>http2 <span class="token operator">|</span> spdy<span class="token punctuation">]</span> <span class="token punctuation">[</span>proxy_protocol<span class="token punctuation">]</span> <span class="token punctuation">[</span>setfib<span class="token operator">=</span>number<span class="token punctuation">]</span> <span class="token punctuation">[</span>fastopen<span class="token operator">=</span>number<span class="token punctuation">]</span> <span class="token punctuation">[</span>backlog<span class="token operator">=</span>number<span class="token punctuation">]</span> <span class="token punctuation">[</span>rcvbuf<span class="token operator">=</span>size<span class="token punctuation">]</span> <span class="token punctuation">[</span>sndbuf<span class="token operator">=</span>size<span class="token punctuation">]</span> <span class="token punctuation">[</span>accept_filter<span class="token operator">=</span>filter<span class="token punctuation">]</span> <span class="token punctuation">[</span>deferred<span class="token punctuation">]</span> <span class="token punctuation">[</span>bind<span class="token punctuation">]</span> <span class="token punctuation">[</span>ipv6only<span class="token operator">=</span>on<span class="token operator">|</span>off<span class="token punctuation">]</span> <span class="token punctuation">[</span>reuseport<span class="token punctuation">]</span> <span class="token punctuation">[</span>so_keepalive<span class="token operator">=</span>on<span class="token operator">|</span>off<span class="token operator">|</span><span class="token punctuation">[</span>keepidle<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">[</span>keepintvl<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">[</span>keepcnt<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//第二种</span>
listen port <span class="token punctuation">[</span>default_server<span class="token punctuation">]</span> <span class="token punctuation">[</span>ssl<span class="token punctuation">]</span> <span class="token punctuation">[</span>http2 <span class="token operator">|</span> spdy<span class="token punctuation">]</span> <span class="token punctuation">[</span>proxy_protocol<span class="token punctuation">]</span> <span class="token punctuation">[</span>setfib<span class="token operator">=</span>number<span class="token punctuation">]</span> <span class="token punctuation">[</span>fastopen<span class="token operator">=</span>number<span class="token punctuation">]</span> <span class="token punctuation">[</span>backlog<span class="token operator">=</span>number<span class="token punctuation">]</span> <span class="token punctuation">[</span>rcvbuf<span class="token operator">=</span>size<span class="token punctuation">]</span> <span class="token punctuation">[</span>sndbuf<span class="token operator">=</span>size<span class="token punctuation">]</span> <span class="token punctuation">[</span>accept_filter<span class="token operator">=</span>filter<span class="token punctuation">]</span> <span class="token punctuation">[</span>deferred<span class="token punctuation">]</span> <span class="token punctuation">[</span>bind<span class="token punctuation">]</span> <span class="token punctuation">[</span>ipv6only<span class="token operator">=</span>on<span class="token operator">|</span>off<span class="token punctuation">]</span> <span class="token punctuation">[</span>reuseport<span class="token punctuation">]</span> <span class="token punctuation">[</span>so_keepalive<span class="token operator">=</span>on<span class="token operator">|</span>off<span class="token operator">|</span><span class="token punctuation">[</span>keepidle<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">[</span>keepintvl<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">[</span>keepcnt<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//第三种（可以不用重点关注）</span>
listen unix<span class="token operator">:</span>path <span class="token punctuation">[</span>default_server<span class="token punctuation">]</span> <span class="token punctuation">[</span>ssl<span class="token punctuation">]</span> <span class="token punctuation">[</span>http2 <span class="token operator">|</span> spdy<span class="token punctuation">]</span> <span class="token punctuation">[</span>proxy_protocol<span class="token punctuation">]</span> <span class="token punctuation">[</span>backlog<span class="token operator">=</span>number<span class="token punctuation">]</span> <span class="token punctuation">[</span>rcvbuf<span class="token operator">=</span>size<span class="token punctuation">]</span> <span class="token punctuation">[</span>sndbuf<span class="token operator">=</span>size<span class="token punctuation">]</span> <span class="token punctuation">[</span>accept_filter<span class="token operator">=</span>filter<span class="token punctuation">]</span> <span class="token punctuation">[</span>deferred<span class="token punctuation">]</span> <span class="token punctuation">[</span>bind<span class="token punctuation">]</span> <span class="token punctuation">[</span>so_keepalive<span class="token operator">=</span>on<span class="token operator">|</span>off<span class="token operator">|</span><span class="token punctuation">[</span>keepidle<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">[</span>keepintvl<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">[</span>keepcnt<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></div></code-block><div id="4G5MzSRZeQ97mtgmYBDVxh" class="wolai-block wolai-text"><div><span class="inline-wrap">listen<span class="jill"></span>指令的配置非常灵活，可以单独制定<span class="jill"></span>ip，单独指定端口或者同时指定<span class="jill"></span>ip<span class="jill"></span>和端口。</span></div></div><code-block id="4FTxPigr6t4XH3cpXCyRkq" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">listen <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8000</span><span class="token punctuation">;</span>  #只监听来自<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>这个<span class="token constant">IP</span>，请求<span class="token number">8000</span>端口的请求
listen <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">;</span> #只监听来自<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>这个<span class="token constant">IP</span>，请求<span class="token number">80</span>端口的请求（不指定端口，默认<span class="token number">80</span>）
listen <span class="token number">8000</span><span class="token punctuation">;</span> #监听来自所有<span class="token constant">IP</span>，请求<span class="token number">8000</span>端口的请求
listen <span class="token operator">*</span><span class="token operator">:</span><span class="token number">8000</span><span class="token punctuation">;</span> #和上面效果一样
listen localhost<span class="token operator">:</span><span class="token number">8000</span><span class="token punctuation">;</span> #和第一种效果一致</pre></div></code-block><div id="5dA5552h1fzuTZ6RbesyKy" class="wolai-block wolai-text"><div><span class="inline-wrap">关于上面的一些重要参数做如下说明：</span></div></div><ul class="wolai-block"><li id="4sb2ETUUWbn2qRXaj2LucA"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">address：监听的<span class="jill"></span>IP<span class="jill"></span>地址（请求来源的<span class="jill"></span>IP<span class="jill"></span>地址），如果是<span class="jill"></span>IPv6<span class="jill"></span>的地址，需要使用中括号“[]”括起来，比如[fe80::1]等。</span></li><li id="41xwtsgKcBxjCxUpDL6TcZ"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">port：端口号，如果只定义了<span class="jill"></span>IP<span class="jill"></span>地址没有定义端口号，就使用<span class="jill"></span>80<span class="jill"></span>端口。</span><span class="inline-wrap"><b>这边需要做个说明：要是你压根没配置<span class="jill"></span>listen<span class="jill"></span>指令，那么那么如果<span class="jill"></span>nginx<span class="jill"></span>以超级用户权限运行，则使用</b></span><span class="inline-wrap"><b><code>\*</code></b></span><span class="inline-wrap"><b>:80，否则使用</b></span><span class="inline-wrap"><b><code>\*</code></b></span><span class="inline-wrap"><b>:8000</b></span><span class="inline-wrap">。多个虚拟主机可以同时监听同一个端口,但是<span class="jill"></span>server_name<span class="jill"></span>需要设置成不一样；</span></li><li id="eq3uTdUoyuspeP94NW6ZvK"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">default_server：假如通过<span class="jill"></span>Host<span class="jill"></span>没匹配到对应的虚拟主机，则通过这台虚拟主机处理。具体的可以参考这篇</span><span class="inline-wrap"><a href="https://segmentfault.com/a/1190000015681272"><span>文章</span></a></span><span class="inline-wrap">，写的不错。</span></li><li id="aKpCJbL4fNG33Qi5qvwEUn"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">backlog=number：设置监听函数<span class="jill"></span>listen()最多允许多少网络连接同时处于挂起状态，在<span class="jill"></span>FreeBSD<span class="jill"></span>中默认为-1，其他平台默认为<span class="jill"></span>511。</span></li><li id="6AxN65tGpeXsdGdB3AQkfk"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">accept_filter=filter，设置监听端口对请求的过滤，被过滤的内容不能被接收和处理。本指令只在<span class="jill"></span>FreeBSD<span class="jill"></span>和<span class="jill"></span>NetBSD 5.0+<span class="jill"></span>平台下有效。filter<span class="jill"></span>可以设置为<span class="jill"></span>dataready<span class="jill"></span>或<span class="jill"></span>httpready，感兴趣的读者可以参阅<span class="jill"></span>Nginx<span class="jill"></span>的官方文档。</span></li><li id="iFFrfoWvDo6N3EeriEinb5"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">bind：标识符，使用独立的<span class="jill"></span>bind()处理此<span class="jill"></span>address:port；一般情况下，对于端口相同而<span class="jill"></span>IP<span class="jill"></span>地址不同的多个连接，Nginx<span class="jill"></span>服务器将只使用一个监听命令，并使用<span class="jill"></span>bind()处理端口相同的所有连接。</span></li><li id="xmfdeumrXYehegtQutEgss"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ssl：标识符，设置会话连接使用<span class="jill"></span>SSL<span class="jill"></span>模式进行，此标识符和<span class="jill"></span>Nginx<span class="jill"></span>服务器提供的<span class="jill"></span>HTTPS<span class="jill"></span>服务有关。</span></li></ul><div id="fumPd5d7HPFjbPxtFFWC9f" class="wolai-block wolai-text"><div><span class="inline-wrap">listen<span class="jill"></span>指令的使用看起来比较复杂，但其实在一般的使用过程中，相对来说比较简单，并不会进行太复杂的配置。</span></div></div><h3 id="jV3hAYsvsNLXVeRRDudqTu" class="wolai-block"><span class="inline-wrap">server_name<span class="jill"></span>指令</span></h3><div id="cWLiMXXPKJCfnpya9mBaUF" class="wolai-block wolai-text"><div><span class="inline-wrap">用于配置虚拟主机的名称。语法是：</span></div></div><code-block id="rG3BobWRAjZbVBc7Nquofd" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token literal-property property">Syntax</span><span class="token operator">:</span>  server_name name <span class="token spread operator">...</span><span class="token punctuation">;</span>
<span class="token literal-property property">Default</span><span class="token operator">:</span>  
server_name <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token literal-property property">Context</span><span class="token operator">:</span>  server</pre></div></code-block><div id="t6i1scUkwbjm6EMV26nxsM" class="wolai-block wolai-text"><div><span class="inline-wrap">对于<span class="jill"></span>name 来说，可以只有一个名称，也可以由多个名称并列，之间用空格隔开。每个名字就是一个域名，由两段或者三段组成，之间由点号“.”隔开。比如</span></div></div><code-block id="toLwQeSdb9vP3he9w8rJvp" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">server_name myserver<span class="token punctuation">.</span><span class="token property-access">com</span> www<span class="token punctuation">.</span><span class="token property-access">myserver</span><span class="token punctuation">.</span><span class="token property-access">com</span></pre></div></code-block><div id="sgWwcQaxFKD7NKtXJqCxzd" class="wolai-block wolai-text"><div><span class="inline-wrap">在该例中，此虚拟主机的名称设置为<span class="jill"></span>myserver.com<span class="jill"></span>或<span class="jill"></span>www. myserver.com。Nginx<span class="jill"></span>服务器规定，第一个名称作为此虚拟主机的主要名称。</span></div></div><div id="awFWQitewEYkc2nzHjfLgK" class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>name 中可以使用通配符“ *”，但通配符只能用在由三段字符串组成的名称的首段或尾段，或者由两段字符串组成的名称的尾段，如：</span><span class="inline-wrap">在<span class="jill"></span>name 中可以使用通配符“ *”，但通配符只能用在由三段字符串组成的名称的首段或尾段，或者由两段字符串组成的名称的尾段，如：</span></div></div><code-block id="iY4U1KuddsymA9LRmxum2t" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">server_name myserver<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token property-access">myserver</span><span class="token punctuation">.</span><span class="token property-access">com</span></pre></div></code-block><div id="sefGLawBbqf2jhiEAAZphW" class="wolai-block wolai-text"><div><span class="inline-wrap">另外<span class="jill"></span>name<span class="jill"></span>还支持正则表达式的形式。这边就不详细展开了。</span></div></div><div id="a2DGqsNfmM42koiQMUY5u7" class="wolai-block wolai-text"><div><span class="inline-wrap">由于<span class="jill"></span>server_name<span class="jill"></span>指令支持使用通配符和正则表达式两种配置名称的方式，因此在包含有多个虚拟主机的配置文件中，可能会出现一个名称被多个虚拟主机的<span class="jill"></span>server_name<span class="jill"></span>匹配成功。那么，来自这个名称的请求到底要交给哪个虚拟主机处理呢？Nginx<span class="jill"></span>服务器做出如下规定：</span></div></div><div id="tjG32M2Kv5PXaTa3N5LW87" class="wolai-block wolai-text"><div><span class="inline-wrap">a. 对于匹配方式不同的，按照以下的优先级选择虚拟主机，排在前面的优先处理请求。</span></div></div><ul class="wolai-block"><li id="kVZmiA3c2syqpoJA5QCHiR"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">① 准确匹配<span class="jill"></span>server_name</span></li><li id="8ZKaRnoxgTgKtoc2s5nb44"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">② 通配符在开始时匹配<span class="jill"></span>server_name<span class="jill"></span>成功</span></li><li id="kD9tNShxkgAeMA4Sp4tMSX"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">③ 通配符在结尾时匹配<span class="jill"></span>server_name<span class="jill"></span>成功</span></li><li id="hRGxXurqeEbL4goKXUYHuT"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">④ 正则表达式匹配<span class="jill"></span>server_name<span class="jill"></span>成功</span></li></ul><div id="sGMeVeChu7tcvtPup5SJ1J" class="wolai-block wolai-text"><div><span class="inline-wrap">b. 在以上四种匹配方式中，如果<span class="jill"></span>server_name<span class="jill"></span>被处于同一优先级的匹配方式多次匹配成功，则首次匹配成功的虚拟主机处理请求。</span></div></div><div id="5AK7fmyQbGfEjvCQMuKou3" class="wolai-block wolai-text"><div><span class="inline-wrap">有时候我们希望使用基于<span class="jill"></span>IP<span class="jill"></span>地址的虚拟主机配置，比如访问<span class="jill"></span>192.168.1.31<span class="jill"></span>有虚拟主机<span class="jill"></span>1<span class="jill"></span>处理，访问<span class="jill"></span>192.168.1.32<span class="jill"></span>由虚拟主机<span class="jill"></span>2<span class="jill"></span>处理。</span></div></div><div id="cEhirXHp8ziupA2psBTQ85" class="wolai-block wolai-text"><div><span class="inline-wrap">这时我们要先网卡绑定别名，比如说网卡之前绑定的<span class="jill"></span>IP<span class="jill"></span>是<span class="jill"></span>192.168.1.30，现在将<span class="jill"></span>192.168.1.31<span class="jill"></span>和<span class="jill"></span>192.168.1.32<span class="jill"></span>这两个<span class="jill"></span>IP<span class="jill"></span>都绑定到这个网卡上，那么请求这个两个<span class="jill"></span>IP<span class="jill"></span>的请求才会到达这台机器。</span></div></div><div id="oscAaiXLm7dbwu6Q2h3UzW" class="wolai-block wolai-text"><div><span class="inline-wrap">绑定别名后进行以下配置即可：</span></div></div><code-block id="cq2tv4KZtvjYJYjFwCe1aX" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">http
<span class="token punctuation">{</span>
  <span class="token punctuation">{</span>
     <span class="token literal-property property">listen</span><span class="token operator">:</span>  <span class="token number">80</span><span class="token punctuation">;</span>
     <span class="token literal-property property">server_name</span><span class="token operator">:</span>  <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.31</span><span class="token punctuation">;</span>
     <span class="token spread operator">...</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">{</span>
     <span class="token literal-property property">listen</span><span class="token operator">:</span>  <span class="token number">80</span><span class="token punctuation">;</span>
     <span class="token literal-property property">server_name</span><span class="token operator">:</span>  <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.32</span><span class="token punctuation">;</span>
     <span class="token spread operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><h2 id="9waQCDsqFztu3sm3589Dpo" class="wolai-block"><span class="inline-wrap">location<span class="jill"></span>块</span></h2><div id="vUe93yotK6yfAoKYEXbwjv" class="wolai-block wolai-text"><div><span class="inline-wrap">每个<span class="jill"></span>server<span class="jill"></span>块中可以包含多个<span class="jill"></span>location<span class="jill"></span>块。在整个<span class="jill"></span>Nginx<span class="jill"></span>配置文档中起着重要的作用，而且<span class="jill"></span>Nginx<span class="jill"></span>服务器在许多功能上的灵活性往往在<span class="jill"></span>location<span class="jill"></span>指令的配置中体现出来。</span></div></div><div id="p7QaSsHpHNXoCxVwC3KApG" class="wolai-block wolai-text"><div><span class="inline-wrap">location<span class="jill"></span>块的主要作用是，基于<span class="jill"></span>Nginx<span class="jill"></span>服务器接收到的请求字符串（例如， server_name/uri-string），对除虚拟主机名称（也可以是<span class="jill"></span>IP<span class="jill"></span>别名，后文有详细阐述）之外的字符串（前例中“/uri-string”部分）进行匹配，对特定的请求进行处理。地址定向、数据缓存和应答控制等功能都是在这部分实现。许多第三方模块的配置也是在<span class="jill"></span>location<span class="jill"></span>块中提供功能。</span></div></div><div id="fmVv115mdJEQtbieFL53RB" class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>Nginx<span class="jill"></span>的官方文档中定义的<span class="jill"></span>location<span class="jill"></span>的语法结构为：</span></div></div><code-block id="doFtqjPuZtBGZxKbdHjkM2" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token dom variable">location</span> <span class="token punctuation">[</span> <span class="token operator">=</span> <span class="token operator">|</span> <span class="token operator">~</span> <span class="token operator">|</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">|</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token punctuation">]</span> uri <span class="token punctuation">{</span> <span class="token spread operator">...</span> <span class="token punctuation">}</span></pre></div></code-block><div id="gkip21gd1w2cQ6X9UhRuAQ" class="wolai-block wolai-text"><div><span class="inline-wrap">其中，uri<span class="jill"></span>变量是待匹配的请求字符串，可以是不含正则表达的字符串，如/myserver.php<span class="jill"></span>等；也可以是包含有正则表达的字符串，如 .php$（表示以.php<span class="jill"></span>结尾的<span class="jill"></span>URL）等。为了下文叙述方便，我们约定，不含正则表达的<span class="jill"></span>uri<span class="jill"></span>称为“标准<span class="jill"></span>uri”，使用正则表达式的<span class="jill"></span>uri<span class="jill"></span>称为“正则<span class="jill"></span>uri”。</span></div></div><div id="3cscaAiShfzjNUiJTA3Z4r" class="wolai-block wolai-text"><div><span class="inline-wrap">其中方括号里的部分，是可选项，用来改变请求字符串与 uri 的匹配方式。在介绍四种标识的含义之前，我们需要先了解不添加此选项时，Nginx<span class="jill"></span>服务器是如何在<span class="jill"></span>server<span class="jill"></span>块中搜索并使用<span class="jill"></span>location<span class="jill"></span>块的<span class="jill"></span>uri<span class="jill"></span>和请求字符串匹配的。</span></div></div><div id="5EhEwLQfE2mW7zGi1unibz" class="wolai-block wolai-text"><div><span class="inline-wrap">在不添加此选项时，Nginx<span class="jill"></span>服务器首先在<span class="jill"></span>server<span class="jill"></span>块的多个<span class="jill"></span>location<span class="jill"></span>块中搜索是否有标准<span class="jill"></span>uri<span class="jill"></span>和请求字符串匹配，如果有多个可以匹配，就记录匹配度最高的一个。然后，服务器再用<span class="jill"></span>location<span class="jill"></span>块中的正则<span class="jill"></span>uri<span class="jill"></span>和请求字符串匹配，当第一个正则<span class="jill"></span>uri<span class="jill"></span>匹配成功，结束搜索，并使用这个<span class="jill"></span>location<span class="jill"></span>块处理此请求；如果正则匹配全部失败，就使用刚才记录的匹配度最高的<span class="jill"></span>location<span class="jill"></span>块处理此请求。</span></div></div><div id="5se6ZGRF4QD4NUd1SrBUdc" class="wolai-block wolai-text"><div><span class="inline-wrap">了解了上面的内容，就可以解释可选项中各个标识的含义了：</span></div></div><ul class="wolai-block"><li id="rgW7cKU35f4Ub66f8GniJ8"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">“=”，用于标准<span class="jill"></span>uri<span class="jill"></span>前，要求请求字符串与<span class="jill"></span>uri<span class="jill"></span>严格匹配。如果已经匹配成功，就停止继续向下搜索并立即处理此请求。</span></li><li id="7WcsjdfpJkV3Crn8Gsah1R"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">“^～”，用于标准<span class="jill"></span>uri<span class="jill"></span>前，要求<span class="jill"></span>Nginx<span class="jill"></span>服务器找到标识<span class="jill"></span>uri<span class="jill"></span>和请求字符串匹配度最高的<span class="jill"></span>location<span class="jill"></span>后，立即使用此<span class="jill"></span>location<span class="jill"></span>处理请求，而不再使用<span class="jill"></span>location<span class="jill"></span>块中的正则<span class="jill"></span>uri<span class="jill"></span>和请求字符串做匹配。</span></li><li id="akC9zMpwQmPNot1ZX1jFFG"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">“～”，用于表示<span class="jill"></span>uri<span class="jill"></span>包含正则表达式，并且区分大小写。</span></li><li id="kwsRQcjYwgA64KjWwdw4RV"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">“～</span><span class="inline-wrap"><code>*</code></span><span class="inline-wrap">”，用于表示<span class="jill"></span>uri<span class="jill"></span>包含正则表达式，并且不区分大小写。注意如果<span class="jill"></span>uri<span class="jill"></span>包含正则表达式，就必须要使用“～”或者“～ *”标识。</span><span class="inline-wrap">”，用于表示<span class="jill"></span>uri<span class="jill"></span>包含正则表达式，并且不区分大小写。注意如果<span class="jill"></span>uri<span class="jill"></span>包含正则表达式，就必须要使用“～”或者“～ *”标识。</span></li></ul><blockquote id="utpptKhAEykb3szfaxANQU" class="wolai-block"><span class="inline-wrap">我们知道，在浏览器传送<span class="jill"></span>URI<span class="jill"></span>时对一部分字符进行<span class="jill"></span>URL<span class="jill"></span>编码，比如空格被编码为“%20”，问号被编码为“%3f”等。“～”有一个特点是，它对<span class="jill"></span>uri<span class="jill"></span>中的这些符号将会进行编码处理。比如，如果<span class="jill"></span>location<span class="jill"></span>块收到的<span class="jill"></span>URI<span class="jill"></span>为“/html/%20/data”，则当<span class="jill"></span>Nginx<span class="jill"></span>服务器搜索到配置为“～ /html/ /data”的<span class="jill"></span>location<span class="jill"></span>时，可以匹配成功。</span></blockquote><h3 id="1RUeWRt1PzhKv8Rp8PqQJa" class="wolai-block"><span class="inline-wrap">root<span class="jill"></span>指令</span><span class="inline-wrap"><a href="https://www.cnblogs.com/54chensongxia/p/12938929.html#root指令"><span>#</span></a></span></h3><div id="xdHxXWtPfKGWZZWpQyCGJz" class="wolai-block wolai-text"><div><span class="inline-wrap">这个指令用于设置请求寻找资源的跟目录，此指令可以在<span class="jill"></span>http<span class="jill"></span>块、server<span class="jill"></span>块或者<span class="jill"></span>location<span class="jill"></span>块中配置。由于使用<span class="jill"></span>Nginx<span class="jill"></span>服务器多数情况下要配置多个<span class="jill"></span>location<span class="jill"></span>块对不同的请求分别做出处理，因此该指令通常在<span class="jill"></span>location<span class="jill"></span>块中进行设置。</span></div></div><code-block id="9UBX5xbkrNa3Cn5VmhcUiG" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">root path</pre></div></code-block><div id="hU9Q3kr24ZYWBVZ5w8dU1v" class="wolai-block wolai-text"><div><span class="inline-wrap">path<span class="jill"></span>变量中可以包含<span class="jill"></span>Nginx<span class="jill"></span>服务器预设的大多数变量，只有𝑑𝑜𝑐𝑢𝑚𝑒𝑛𝑡𝑟𝑜𝑜𝑡和<span class="jill"></span>documentroot<span class="jill"></span>和<span class="jill"></span>realpath_root<span class="jill"></span>不可以使用。</span></div></div><h3 id="8PANc5SoHoK6Hde5cHh3i3" class="wolai-block"><span class="inline-wrap">alisa<span class="jill"></span>指令</span><span class="inline-wrap"><a href="https://www.cnblogs.com/54chensongxia/p/12938929.html#alisa指令"><span>#</span></a></span></h3><h3 id="8fzr13yxAxwu8EdhhYEUig" class="wolai-block"><span class="inline-wrap">index<span class="jill"></span>指令</span><span class="inline-wrap"><a href="https://www.cnblogs.com/54chensongxia/p/12938929.html#index指令"><span>#</span></a></span></h3><h3 id="1ZaKUnAyYN2cT5ejM79Nzn" class="wolai-block"><span class="inline-wrap">error_page<span class="jill"></span>指令</span><span class="inline-wrap"><a href="https://www.cnblogs.com/54chensongxia/p/12938929.html#error_page指令"><span>#</span></a></span></h3><h2 id="uxCtUPobH8Yf3U9ceQhUgz" class="wolai-block"><span class="inline-wrap">一点说明</span><span class="inline-wrap"><a href="https://www.cnblogs.com/54chensongxia/p/12938929.html#一点说明"><span>#</span></a></span></h2><div id="2PzC2uoyNGTVut5MfZGYB1" class="wolai-block wolai-text"><div><span class="inline-wrap">上面列举了<span class="jill"></span>Nginx<span class="jill"></span>中全局块、event<span class="jill"></span>块和<span class="jill"></span>http<span class="jill"></span>块的一些配置指令，但是<span class="jill"></span>Nginx<span class="jill"></span>的指令远远不止这些。其实这边最主要的还是讲解整个配置文件的结构，如果大家要看比较全的指令介绍、模块介绍的话，建议去<span class="jill"></span>Nginx<span class="jill"></span>的官网。</span></div></div><h2 id="xyYvoE7Fh72om4M979QtPe" class="wolai-block"><span class="inline-wrap">一个配置文件的列子</span><span class="inline-wrap"><a href="https://www.cnblogs.com/54chensongxia/p/12938929.html#一个配置文件的列子"><span>#</span></a></span></h2><code-block id="v8vUsrF1BqAjtPJxwA5gte" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">######<span class="token maybe-class-name">Nginx配置文件nginx</span><span class="token punctuation">.</span><span class="token property-access">conf中文详解</span>#####

#定义Nginx运行的用户和用户组
user www www<span class="token punctuation">;</span>

#nginx进程数，建议设置为等于<span class="token constant">CPU</span>总核心数。
worker_processes <span class="token number">8</span><span class="token punctuation">;</span>
 
#全局错误日志定义类型，<span class="token punctuation">[</span> debug <span class="token operator">|</span> info <span class="token operator">|</span> notice <span class="token operator">|</span> warn <span class="token operator">|</span> error <span class="token operator">|</span> crit <span class="token punctuation">]</span>
error_log <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>logs<span class="token operator">/</span>error<span class="token punctuation">.</span><span class="token property-access">log</span> info<span class="token punctuation">;</span>

#进程pid文件
pid <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>logs<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">;</span>

#指定进程可以打开的最大描述符：数目
#工作模式与连接数上限
#这个指令是指当一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（ulimit <span class="token operator">-</span>n）与nginx进程数相除，但是nginx分配请求并不是那么均匀，所以最好与ulimit <span class="token operator">-</span>n 的值保持一致。
#现在在linux <span class="token number">2.6</span>内核下开启文件打开数为<span class="token number">65535</span>，worker_rlimit_nofile就相应应该填写<span class="token number">65535</span>。
#这是因为nginx调度时分配请求到进程并不是那么的均衡，所以假如填写<span class="token number">10240</span>，总并发量达到<span class="token number">3</span><span class="token operator">-</span><span class="token number">4</span>万时就有进程可能超过<span class="token number">10240</span>了，这时会返回<span class="token number">502</span>错误。
worker_rlimit_nofile <span class="token number">65535</span><span class="token punctuation">;</span>


events
<span class="token punctuation">{</span>
    #参考事件模型，use <span class="token punctuation">[</span> kqueue <span class="token operator">|</span> rtsig <span class="token operator">|</span> epoll <span class="token operator">|</span> <span class="token operator">/</span>dev<span class="token operator">/</span>poll <span class="token operator">|</span> select <span class="token operator">|</span> poll <span class="token punctuation">]</span><span class="token punctuation">;</span> epoll模型
    #是Linux <span class="token number">2.6</span>以上版本内核中的高性能网络<span class="token constant">I</span><span class="token operator">/</span><span class="token constant">O</span>模型，linux建议epoll，如果跑在FreeBSD上面，就用kqueue模型。
    #补充说明：
    #与apache相类，nginx针对不同的操作系统，有不同的事件模型
    #<span class="token constant">A</span>）标准事件模型
    #<span class="token maybe-class-name">Select、poll属于标准事件模型，如果当前系统不存在更有效的方法，nginx会选择select或poll</span>
    #<span class="token constant">B</span>）高效事件模型
    #<span class="token maybe-class-name">Kqueue：使用于FreeBSD</span> <span class="token number">4.1</span><span class="token operator">+</span><span class="token punctuation">,</span> <span class="token maybe-class-name">OpenBSD</span> <span class="token number">2.9</span><span class="token operator">+</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NetBSD</span> <span class="token number">2.0</span> 和 <span class="token maybe-class-name">MacOS</span> <span class="token constant">X</span><span class="token punctuation">.</span><span class="token property-access">使用双处理器的MacOS</span> <span class="token constant">X</span>系统使用kqueue可能会造成内核崩溃。
    #<span class="token maybe-class-name">Epoll：使用于Linux内核</span><span class="token number">2.6</span>版本及以后的系统。
    #<span class="token operator">/</span>dev<span class="token operator">/</span>poll：使用于Solaris <span class="token number">7</span> <span class="token number">11</span><span class="token operator">/</span><span class="token number">99</span><span class="token operator">+</span>，<span class="token constant">HP</span><span class="token operator">/</span><span class="token constant">UX</span> <span class="token number">11.22</span><span class="token operator">+</span> <span class="token punctuation">(</span>eventport<span class="token punctuation">)</span>，<span class="token constant">IRIX</span> <span class="token number">6.5</span><span class="token number">.15</span><span class="token operator">+</span> 和 <span class="token maybe-class-name">Tru64</span> <span class="token constant">UNIX</span> <span class="token number">5</span><span class="token punctuation">.</span>1A<span class="token operator">+</span>。
    #<span class="token maybe-class-name">Eventport：使用于Solaris</span> <span class="token number">10</span>。 为了防止出现内核崩溃的问题， 有必要安装安全补丁。
    use epoll<span class="token punctuation">;</span>

    #单个进程最大连接数（最大连接数<span class="token operator">=</span>连接数<span class="token operator">*</span>进程数）
    #根据硬件调整，和前面工作进程配合起来用，尽量大，但是别把cpu跑到<span class="token number">100</span><span class="token operator">%</span>就行。每个进程允许的最多连接数，理论上每台nginx服务器的最大连接数为。
    worker_connections <span class="token number">65535</span><span class="token punctuation">;</span>

    #keepalive超时时间。
    keepalive_timeout <span class="token number">60</span><span class="token punctuation">;</span>

    #客户端请求头部的缓冲区大小。这个可以根据你的系统分页大小来设置，一般一个请求头的大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。
    #分页大小可以用命令getconf <span class="token constant">PAGESIZE</span> 取得。
    #<span class="token punctuation">[</span>root@web001 <span class="token operator">~</span><span class="token punctuation">]</span># getconf <span class="token constant">PAGESIZE</span>
    #<span class="token number">4096</span>
    #但也有client_header_buffer_size超过4k的情况，但是client_header_buffer_size该值必须设置为“系统分页大小”的整倍数。
    client_header_buffer_size 4k<span class="token punctuation">;</span>

    #这个将为打开文件指定缓存，默认是没有启用的，max指定缓存数量，建议和打开文件数一致，inactive是指经过多长时间文件没被请求后删除缓存。
    open_file_cache max<span class="token operator">=</span><span class="token number">65535</span> inactive<span class="token operator">=</span>60s<span class="token punctuation">;</span>

    #这个是指多长时间检查一次缓存的有效信息。
    #语法<span class="token operator">:</span>open_file_cache_valid time 默认值<span class="token operator">:</span>open_file_cache_valid <span class="token number">60</span> <span class="token literal-property property">使用字段</span><span class="token operator">:</span>http<span class="token punctuation">,</span> server<span class="token punctuation">,</span> <span class="token dom variable">location</span> 这个指令指定了何时需要检查open_file_cache中缓存项目的有效信息<span class="token punctuation">.</span>
    <span class="token property-access">open_file_cache_valid</span> 80s<span class="token punctuation">;</span>

    #open_file_cache指令中的inactive参数时间内文件的最少使用次数，如果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文件在inactive时间内一次没被使用，它将被移除。
    #语法<span class="token operator">:</span>open_file_cache_min_uses number 默认值<span class="token operator">:</span>open_file_cache_min_uses <span class="token number">1</span> <span class="token literal-property property">使用字段</span><span class="token operator">:</span>http<span class="token punctuation">,</span> server<span class="token punctuation">,</span> <span class="token dom variable">location</span>  这个指令指定了在open_file_cache指令无效的参数中一定的时间范围内可以使用的最小文件数<span class="token punctuation">,</span>如果使用更大的值<span class="token punctuation">,</span>文件描述符在cache中总是打开状态<span class="token punctuation">.</span>
    <span class="token property-access">open_file_cache_min_uses</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    #语法<span class="token operator">:</span>open_file_cache_errors on <span class="token operator">|</span> off 默认值<span class="token operator">:</span>open_file_cache_errors off 使用字段<span class="token operator">:</span>http<span class="token punctuation">,</span> server<span class="token punctuation">,</span> <span class="token dom variable">location</span> 这个指令指定是否在搜索一个文件时记录cache错误<span class="token punctuation">.</span>
    <span class="token property-access">open_file_cache_errors</span> on<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
 
 
#设定http服务器，利用它的反向代理功能提供负载均衡支持
http
<span class="token punctuation">{</span>
    #文件扩展名与文件类型映射表
    include mime<span class="token punctuation">.</span><span class="token property-access">types</span><span class="token punctuation">;</span>

    #默认文件类型
    default_type application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>

    #默认编码
    #charset utf<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">;</span>

    #服务器名字的hash表大小
    #保存服务器名字的hash表是由指令server_names_hash_max_size 和server_names_hash_bucket_size所控制的。参数hash bucket size总是等于hash表的大小，并且是一路处理器缓存大小的倍数。在减少了在内存中的存取次数后，使在处理器中加速查找hash表键值成为可能。如果hash bucket size等于一路处理器缓存的大小，那么在查找键的时候，最坏的情况下在内存中查找的次数为<span class="token number">2</span>。第一次是确定存储单元的地址，第二次是在存储单元中查找键 值。因此，如果Nginx给出需要增大hash max size 或 hash bucket size的提示，那么首要的是增大前一个参数的大小<span class="token punctuation">.</span>
    <span class="token property-access">server_names_hash_bucket_size</span> <span class="token number">128</span><span class="token punctuation">;</span>

    #客户端请求头部的缓冲区大小。这个可以根据你的系统分页大小来设置，一般一个请求的头部大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。分页大小可以用命令getconf <span class="token constant">PAGESIZE</span>取得。
    client_header_buffer_size 32k<span class="token punctuation">;</span>

    #客户请求头缓冲大小。nginx默认会用client_header_buffer_size这个buffer来读取header值，如果header过大，它会使用large_client_header_buffers来读取。
    large_client_header_buffers <span class="token number">4</span> 64k<span class="token punctuation">;</span>

    #设定通过nginx上传文件的大小
    client_max_body_size 8m<span class="token punctuation">;</span>

    #开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘<span class="token constant">IO</span>重负载应用，可设置为off，以平衡磁盘与网络<span class="token constant">I</span><span class="token operator">/</span><span class="token constant">O</span>处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off。
    #sendfile指令指定 nginx 是否调用sendfile 函数（zero copy 方式）来输出文件，对于普通应用，必须设为on。如果用来进行下载等应用磁盘<span class="token constant">IO</span>重负载应用，可设置为off，以平衡磁盘与网络<span class="token constant">IO</span>处理速度，降低系统uptime。
    sendfile on<span class="token punctuation">;</span>

    #开启目录列表访问，合适下载服务器，默认关闭。
    autoindex on<span class="token punctuation">;</span>

    #此选项允许或禁止使用socke的<span class="token constant">TCP_CORK</span>的选项，此选项仅在使用sendfile的时候使用
    tcp_nopush on<span class="token punctuation">;</span>
     
    tcp_nodelay on<span class="token punctuation">;</span>

    #长连接超时时间，单位是秒
    keepalive_timeout <span class="token number">120</span><span class="token punctuation">;</span>

    #<span class="token maybe-class-name">FastCGI相关参数是为了改善网站的性能：减少资源占用，提高访问速度。下面参数看字面意思都能理解。</span>
    fastcgi_connect_timeout <span class="token number">300</span><span class="token punctuation">;</span>
    fastcgi_send_timeout <span class="token number">300</span><span class="token punctuation">;</span>
    fastcgi_read_timeout <span class="token number">300</span><span class="token punctuation">;</span>
    fastcgi_buffer_size 64k<span class="token punctuation">;</span>
    fastcgi_buffers <span class="token number">4</span> 64k<span class="token punctuation">;</span>
    fastcgi_busy_buffers_size 128k<span class="token punctuation">;</span>
    fastcgi_temp_file_write_size 128k<span class="token punctuation">;</span>

    #gzip模块设置
    gzip on<span class="token punctuation">;</span> #开启gzip压缩输出
    gzip_min_length 1k<span class="token punctuation">;</span>    #最小压缩文件大小
    gzip_buffers <span class="token number">4</span> 16k<span class="token punctuation">;</span>    #压缩缓冲区
    gzip_http_version <span class="token number">1.0</span><span class="token punctuation">;</span>    #压缩版本（默认<span class="token number">1.1</span>，前端如果是squid2<span class="token punctuation">.</span><span class="token number">5</span>请使用<span class="token number">1.0</span>）
    gzip_comp_level <span class="token number">2</span><span class="token punctuation">;</span>    #压缩等级
    gzip_types text<span class="token operator">/</span>plain application<span class="token operator">/</span>x<span class="token operator">-</span>javascript text<span class="token operator">/</span>css application<span class="token operator">/</span>xml<span class="token punctuation">;</span>    #压缩类型，默认就已经包含textml，所以下面就不用再写了，写上去也不会有问题，但是会有一个warn。
    gzip_vary on<span class="token punctuation">;</span>

    #开启限制<span class="token constant">IP</span>连接数的时候需要使用
    #limit_zone crawler $binary_remote_addr 10m<span class="token punctuation">;</span>



    #负载均衡配置
    upstream jh<span class="token punctuation">.</span><span class="token property-access">w3cschool</span><span class="token punctuation">.</span><span class="token property-access">cn</span> <span class="token punctuation">{</span>
     
        #upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。
        server <span class="token number">192.168</span><span class="token number">.80</span><span class="token number">.121</span><span class="token operator">:</span><span class="token number">80</span> weight<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
        server <span class="token number">192.168</span><span class="token number">.80</span><span class="token number">.122</span><span class="token operator">:</span><span class="token number">80</span> weight<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
        server <span class="token number">192.168</span><span class="token number">.80</span><span class="token number">.123</span><span class="token operator">:</span><span class="token number">80</span> weight<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>

        #nginx的upstream目前支持<span class="token number">4</span>种方式的分配
        #<span class="token number">1</span>、轮询（默认）
        #每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。
        #<span class="token number">2</span>、weight
        #指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。
        #例如：
        #upstream bakend <span class="token punctuation">{</span>
        #    server <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.14</span> weight<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
        #    server <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.15</span> weight<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
        #<span class="token punctuation">}</span>
        #<span class="token number">2</span>、ip_hash
        #每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。
        #例如：
        #upstream bakend <span class="token punctuation">{</span>
        #    ip_hash<span class="token punctuation">;</span>
        #    server <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.14</span><span class="token operator">:</span><span class="token number">88</span><span class="token punctuation">;</span>
        #    server <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">;</span>
        #<span class="token punctuation">}</span>
        #<span class="token number">3</span>、fair（第三方）
        #按后端服务器的响应时间来分配请求，响应时间短的优先分配。
        #upstream backend <span class="token punctuation">{</span>
        #    server server1<span class="token punctuation">;</span>
        #    server server2<span class="token punctuation">;</span>
        #    fair<span class="token punctuation">;</span>
        #<span class="token punctuation">}</span>
        #<span class="token number">4</span>、url_hash（第三方）
        #按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。
        #例：在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法
        #upstream backend <span class="token punctuation">{</span>
        #    server squid1<span class="token operator">:</span><span class="token number">3128</span><span class="token punctuation">;</span>
        #    server squid2<span class="token operator">:</span><span class="token number">3128</span><span class="token punctuation">;</span>
        #    hash $request_uri<span class="token punctuation">;</span>
        #    hash_method crc32<span class="token punctuation">;</span>
        #<span class="token punctuation">}</span>

        #tips<span class="token operator">:</span>
        #upstream bakend<span class="token punctuation">{</span>#定义负载均衡设备的Ip及设备状态<span class="token punctuation">}</span><span class="token punctuation">{</span>
        #    ip_hash<span class="token punctuation">;</span>
        #    server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">9090</span> down<span class="token punctuation">;</span>
        #    server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span> weight<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
        #    server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">6060</span><span class="token punctuation">;</span>
        #    server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">7070</span> backup<span class="token punctuation">;</span>
        #<span class="token punctuation">}</span>
        #在需要使用负载均衡的server中增加 proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">bakend</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

        #每个设备的状态设置为<span class="token operator">:</span>
        #<span class="token number">1</span><span class="token punctuation">.</span><span class="token property-access">down表示单前的server暂时不参与负载</span>
        #<span class="token number">2</span><span class="token punctuation">.</span><span class="token property-access">weight为weight越大，负载的权重就越大。</span>
        #<span class="token number">3</span><span class="token punctuation">.</span><span class="token property-access">max_fails：允许请求失败的次数默认为</span><span class="token number">1.</span>当超过最大次数时，返回proxy_next_upstream模块定义的错误
        #<span class="token number">4</span><span class="token punctuation">.</span><span class="token property-access">fail_timeout</span><span class="token operator">:</span>max_fails次失败后，暂停的时间。
        #<span class="token number">5</span><span class="token punctuation">.</span><span class="token property-access">backup：</span> 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。

        #nginx支持同时设置多组的负载均衡，用来给不用的server来使用。
        #client_body_in_file_only设置为On 可以讲client post过来的数据记录到文件中用来做debug
        #client_body_temp_path设置记录文件的目录 可以设置最多<span class="token number">3</span>层目录
        #<span class="token dom variable">location</span>对<span class="token constant">URL</span>进行匹配<span class="token punctuation">.</span><span class="token property-access">可以进行重定向或者进行新的代理</span> 负载均衡
    <span class="token punctuation">}</span>
     
     
     
    #虚拟主机的配置
    server
    <span class="token punctuation">{</span>
        #监听端口
        listen <span class="token number">80</span><span class="token punctuation">;</span>

        #域名可以有多个，用空格隔开
        server_name www<span class="token punctuation">.</span><span class="token property-access">w3cschool</span><span class="token punctuation">.</span><span class="token property-access">cn</span> w3cschool<span class="token punctuation">.</span><span class="token property-access">cn</span><span class="token punctuation">;</span>
        index index<span class="token punctuation">.</span><span class="token property-access">html</span> index<span class="token punctuation">.</span><span class="token property-access">htm</span> index<span class="token punctuation">.</span><span class="token property-access">php</span><span class="token punctuation">;</span>
        root <span class="token operator">/</span>data<span class="token operator">/</span>www<span class="token operator">/</span>w3cschool<span class="token punctuation">;</span>

        #对<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span>进行负载均衡
        <span class="token dom variable">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">(</span>php<span class="token operator">|</span>php5<span class="token punctuation">)</span><span class="token operator">?</span>$
        <span class="token punctuation">{</span>
            fastcgi_pass <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">9000</span><span class="token punctuation">;</span>
            fastcgi_index index<span class="token punctuation">.</span><span class="token property-access">php</span><span class="token punctuation">;</span>
            include fastcgi<span class="token punctuation">.</span><span class="token property-access">conf</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         
        #图片缓存时间设置
        <span class="token dom variable">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token punctuation">)</span>$
        <span class="token punctuation">{</span>
            expires 10d<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         
        #<span class="token constant">JS</span>和<span class="token constant">CSS</span>缓存时间设置
        <span class="token dom variable">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">(</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span><span class="token operator">?</span>$
        <span class="token punctuation">{</span>
            expires 1h<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         
        #日志格式设定
        #$remote_addr与$http_x_forwarded_for用以记录客户端的ip地址；
        #$remote_user：用来记录客户端用户名称；
        #$time_local： 用来记录访问时间与时区；
        #$request： 用来记录请求的url与http协议；
        #$status： 用来记录请求状态；成功是<span class="token number">200</span>，
        #$body_bytes_sent ：记录发送给客户端文件主体内容大小；
        #$http_referer：用来记录从那个页面链接访问过来的；
        #$http_user_agent：记录客户浏览器的相关信息；
        #通常web服务器放在反向代理的后面，这样就不能获取到客户的<span class="token constant">IP</span>地址了，通过$remote_add拿到的<span class="token constant">IP</span>地址是反向代理服务器的iP地址。反向代理服务器在转发请求的http头信息中，可以增加x_forwarded_for信息，用以记录原有客户端的<span class="token constant">IP</span>地址和原来客户端的请求的服务器地址。
        log_format access <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" '</span>
        <span class="token string">'$status $body_bytes_sent "$http_referer" '</span>
        <span class="token string">'"$http_user_agent" $http_x_forwarded_for'</span><span class="token punctuation">;</span>
         
        #定义本虚拟主机的访问日志
        access_log  <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>logs<span class="token operator">/</span>host<span class="token punctuation">.</span><span class="token property-access">access</span><span class="token punctuation">.</span><span class="token property-access">log</span>  main<span class="token punctuation">;</span>
        access_log  <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>logs<span class="token operator">/</span>host<span class="token punctuation">.</span><span class="token property-access">access</span><span class="token punctuation">.</span><span class="token number">404</span><span class="token punctuation">.</span><span class="token property-access">log</span>  log404<span class="token punctuation">;</span>
         
        #对 <span class="token string">"/"</span> 启用反向代理
        <span class="token dom variable">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">88</span><span class="token punctuation">;</span>
            proxy_redirect off<span class="token punctuation">;</span>
            proxy_set_header <span class="token constant">X</span><span class="token operator">-</span><span class="token maybe-class-name">Real</span><span class="token operator">-</span><span class="token constant">IP</span> $remote_addr<span class="token punctuation">;</span>
             
            #后端的Web服务器可以通过<span class="token constant">X</span><span class="token operator">-</span><span class="token maybe-class-name">Forwarded</span><span class="token operator">-</span><span class="token maybe-class-name">For获取用户真实</span><span class="token constant">IP</span>
            proxy_set_header <span class="token constant">X</span><span class="token operator">-</span><span class="token maybe-class-name">Forwarded</span><span class="token operator">-</span><span class="token maybe-class-name">For</span> $proxy_add_x_forwarded_for<span class="token punctuation">;</span>
             
            #以下是一些反向代理的配置，可选。
            proxy_set_header <span class="token maybe-class-name">Host</span> $host<span class="token punctuation">;</span>

            #允许客户端请求的最大单文件字节数
            client_max_body_size 10m<span class="token punctuation">;</span>

            #缓冲区代理缓冲用户端请求的最大字节数，
            #如果把它设置为比较大的数值，例如256k，那么，无论使用firefox还是<span class="token constant">IE</span>浏览器，来提交任意小于256k的图片，都很正常。如果注释该指令，使用默认的client_body_buffer_size设置，也就是操作系统页面大小的两倍，8k或者16k，问题就出现了。
            #无论使用firefox4<span class="token punctuation">.</span><span class="token number">0</span>还是<span class="token constant">IE8</span><span class="token number">.0</span>，提交一个比较大，200k左右的图片，都返回<span class="token number">500</span> <span class="token maybe-class-name">Internal</span> <span class="token maybe-class-name">Server</span> <span class="token known-class-name class-name">Error</span>错误
            client_body_buffer_size 128k<span class="token punctuation">;</span>

            #表示使nginx阻止<span class="token constant">HTTP</span>应答代码为<span class="token number">400</span>或者更高的应答。
            proxy_intercept_errors on<span class="token punctuation">;</span>

            #后端服务器连接的超时时间_发起握手等候响应超时时间
            <span class="token function">#nginx跟后端服务器连接超时时间</span><span class="token punctuation">(</span>代理连接超时<span class="token punctuation">)</span>
            proxy_connect_timeout <span class="token number">90</span><span class="token punctuation">;</span>

            <span class="token function">#后端服务器数据回传时间</span><span class="token punctuation">(</span>代理发送超时<span class="token punctuation">)</span>
            #后端服务器数据回传时间_就是在规定时间之内后端服务器必须传完所有的数据
            proxy_send_timeout <span class="token number">90</span><span class="token punctuation">;</span>

            <span class="token function">#连接成功后，后端服务器响应时间</span><span class="token punctuation">(</span>代理接收超时<span class="token punctuation">)</span>
            #连接成功后_等候后端服务器响应时间_其实已经进入后端的排队之中等候处理（也可以说是后端服务器处理请求的时间）
            proxy_read_timeout <span class="token number">90</span><span class="token punctuation">;</span>

            #设置代理服务器（nginx）保存用户头信息的缓冲区大小
            #设置从被代理服务器读取的第一部分应答的缓冲区大小，通常情况下这部分应答中包含一个小的应答头，默认情况下这个值的大小为指令proxy_buffers中指定的一个缓冲区的大小，不过可以将其设置为更小
            proxy_buffer_size 4k<span class="token punctuation">;</span>

            #proxy_buffers缓冲区，网页平均在32k以下的设置
            #设置用于读取应答（来自被代理服务器）的缓冲区数目和大小，默认情况也为分页大小，根据操作系统的不同可能是4k或者8k
            proxy_buffers <span class="token number">4</span> 32k<span class="token punctuation">;</span>

            #高负荷下缓冲大小（proxy_buffers<span class="token operator">*</span><span class="token number">2</span>）
            proxy_busy_buffers_size 64k<span class="token punctuation">;</span>

            #设置在写入proxy_temp_path时数据的大小，预防一个工作进程在传递文件时阻塞太长
            #设定缓存文件夹大小，大于这个值，将从upstream服务器传
            proxy_temp_file_write_size 64k<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         
         
        #设定查看Nginx状态的地址
        <span class="token dom variable">location</span> <span class="token operator">/</span><span class="token maybe-class-name">NginxStatus</span> <span class="token punctuation">{</span>
            stub_status on<span class="token punctuation">;</span>
            access_log on<span class="token punctuation">;</span>
            auth_basic <span class="token string">"NginxStatus"</span><span class="token punctuation">;</span>
            auth_basic_user_file confpasswd<span class="token punctuation">;</span>
            #htpasswd文件的内容可以用apache提供的htpasswd工具来产生。
        <span class="token punctuation">}</span>
         
        #本地动静分离反向代理配置
        #所有jsp的页面均交由tomcat或resin处理
        <span class="token dom variable">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token punctuation">(</span>jsp<span class="token operator">|</span>jspx<span class="token operator">|</span><span class="token keyword control-flow">do</span><span class="token punctuation">)</span><span class="token operator">?</span>$ <span class="token punctuation">{</span>
            proxy_set_header <span class="token maybe-class-name">Host</span> $host<span class="token punctuation">;</span>
            proxy_set_header <span class="token constant">X</span><span class="token operator">-</span><span class="token maybe-class-name">Real</span><span class="token operator">-</span><span class="token constant">IP</span> $remote_addr<span class="token punctuation">;</span>
            proxy_set_header <span class="token constant">X</span><span class="token operator">-</span><span class="token maybe-class-name">Forwarded</span><span class="token operator">-</span><span class="token maybe-class-name">For</span> $proxy_add_x_forwarded_for<span class="token punctuation">;</span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         
        #所有静态文件由nginx直接读取不经过tomcat或resin
        <span class="token dom variable">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">(</span>htm<span class="token operator">|</span>html<span class="token operator">|</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token operator">|</span>ioc<span class="token operator">|</span>rar<span class="token operator">|</span>zip<span class="token operator">|</span>txt<span class="token operator">|</span>flv<span class="token operator">|</span>mid<span class="token operator">|</span>doc<span class="token operator">|</span>ppt<span class="token operator">|</span>
        pdf<span class="token operator">|</span>xls<span class="token operator">|</span>mp3<span class="token operator">|</span>wma<span class="token punctuation">)</span>$
        <span class="token punctuation">{</span>
            expires 15d<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
         
        <span class="token dom variable">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">(</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span><span class="token operator">?</span>$
        <span class="token punctuation">{</span>
            expires 1h<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block></article><footer></footer></body></html>