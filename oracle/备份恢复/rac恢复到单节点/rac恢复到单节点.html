<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/wolai.css"/><title>rac恢复到单节点 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font less-lead"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="rac恢复到单节点" class="main-title"></div></div></header><article><h1 id="1iL2DPhTQX3ZJRHsUVDBpV" class="wolai-block"><span class="inline-wrap">11g rac<span class="jill"></span>完全恢复到<span class="jill"></span>11g<span class="jill"></span>单节点</span></h1><blockquote id="jyPLMv8E9DvR2GkWrHCxGN" class="wolai-block"><span class="inline-wrap">参考文档：</span></blockquote><ol class="wolai-block"><li id="95UA1kWaEWSwVjp83t8cV9"><div class="marker"></div><span class="inline-wrap"><a href="https://www.cnblogs.com/Clark-cloud-database/p/7818484.html"><span>RAC<span class="jill"></span>数据库的<span class="jill"></span>RMAN<span class="jill"></span>备份异机恢复到单节点数据库</span></a></span></li><li id="8Kao965PjFdQ3Rq7jLtnmQ"><div class="marker"></div><span class="inline-wrap"><a href="https://dbaclass.com/article/ora-00392-log-7-thread-1-cleared-operation-not-allowed/"><span>open database open resetlogs;</span></a></span></li><li id="69FTuzGYM845Msha9xhaQ8"><div class="marker"></div><span class="inline-wrap"><a href="https://blog.csdn.net/a743044559/article/details/77847069"><span>RAC<span class="jill"></span>数据恢复到单节点</span></a></span></li><li id="4Xj3vLdHT72DTQEKpu7Yov"><div class="marker"></div><span class="inline-wrap"><a href="https://its201.com/article/astrisk99/73222649"><span>RMAN<span class="jill"></span>异机恢复实验 RAC+ASM<span class="jill"></span>恢复到单实例文件系统_astrisk99<span class="jill"></span>的博客-程序员<span class="jill"></span>ITS201</span></a></span></li><li id="g2YJFUj8pN2NSiAb2UJMdx"><div class="marker"></div><span class="inline-wrap"><a href="https://its401.com/article/cjh81378066/100354487"><span>RAC<span class="jill"></span>恢复到单机_cjh81378066<span class="jill"></span>的博客-程序员<span class="jill"></span>ITS401</span></a></span></li><li id="dQGt2fzodd55QctdfWsc33"><div class="marker"></div><span class="inline-wrap"><a href="https://open-hl.toutiao.com/a6952833002304963111/?label=related_news&amp;utm_campaign=open&amp;utm_medium=webview&amp;utm_source=o_llq_api&amp;req_id=202106180726220101512070134243E4DD&amp;dt=PCHM10&amp;gy=36dbc44de10b08494af1d70ade43b30e1a746eef438c255b1bf87e689d1e19482795a501b7b9fce3b2795c6b0e898b9abdc57e128735a86c340fe07fc2588640eb817136f29f7bf98440e04db88507d842cfa7fd400fda005885e2432e89d839ad9fb7ccec01549b6537921338fc80fc2c322d53f972df1155a2c791fdc5d21c4fa0ac2fbecf6a72b16d7b5c345bdf4e&amp;crypt=86&amp;a_t=401602792390165839809383527872ff&amp;item_id=6952833002304963111&amp;__docId__=6847121423354298883&amp;__barStyle__=1_1&amp;__statParams__=sourceMedia&amp;__fromId__=__all__&amp;__source__=toutiao&amp;sourceMedia=toutiao&amp;__cmtCnt__=19&amp;__styleType__=4&amp;__publisher_id__=109834868269&amp;openv=&amp;__pf__=detail&amp;fr=normal&amp;from_gid=6916452153943130628&amp;channel_id=88805669586&amp;oppo_anchor="><span>通过<span class="jill"></span>RMAN<span class="jill"></span>恢复<span class="jill"></span>11G RAC<span class="jill"></span>数据库到单实例</span></a></span></li></ol><blockquote id="3xu6fStiwCnRzhtpNvKRJ2" class="wolai-block"><span class="inline-wrap">友情提示：</span></blockquote><ol class="wolai-block"><li id="8RWtomhv6gf54ANwy9e3V6"><div class="marker"></div><span class="inline-wrap">开三个终端窗口，一个<span class="jill"></span>sqlplus，一个<span class="jill"></span>rman，一个<span class="jill"></span>shell</span></li><li id="7rNFKSTEVeNfq5a6KxMssR"><div class="marker"></div><span class="inline-wrap">单节点存储<span class="jill"></span>rac<span class="jill"></span>的备份文件位置：/home/oracle/rac-backup</span></li><li id="qCgkHwjCL8emJsVdsvmKjH"><div class="marker"></div><span class="inline-wrap">单节点存储<span class="jill"></span>rac<span class="jill"></span>恢复后的文件位置：/u01/app/oracle/oradata/restore</span></li></ol><h2 id="vsKs372Wki7wGt5XQeqbqo" class="wolai-block"><span class="inline-wrap">rac<span class="jill"></span>备份</span></h2><div id="k8h49aJsg4fWZvqnBhrToz" class="wolai-block wolai-text"><div><span class="inline-wrap">rac<span class="jill"></span>备份脚本（该脚本<span class="jill"></span>rac<span class="jill"></span>需要开启归档模式）</span></div></div><ol class="wolai-block"><li id="oRSf6f2ZzGxjthE9DWb5iT"><div class="marker"></div><span class="inline-wrap">如果不指定<span class="jill"></span>format，请从<span class="jill"></span>asmcmd<span class="jill"></span>从使用<span class="jill"></span>cp<span class="jill"></span>复制</span></li></ol><code-block id="cHn521uNRNHjfV1LaYYBcA" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 参考命令:</span>
<span class="token comment"># 查看备份文件信息</span>
RMAN<span class="token operator">></span> list backup of database<span class="token punctuation">;</span>
<span class="token comment"># 复制</span>
ASMCMD<span class="token operator">></span> <span class="token function">cp</span> +DATA/demodb/backupset/2021_12_25/nnndf0_full_all_0.265.1092197639 /home/grid</pre></div></code-block><ol class="wolai-block"><li id="7aCTNUTo6oRpaMKo8eTU9i"><div class="marker"></div><span class="inline-wrap">如果归档文件缺少且备份时归档压缩，使用</span><span class="inline-wrap"><code>catelog BACKUPPIECE</code></span><span class="inline-wrap">注册备份片</span></li></ol><code-block id="rGdgytzQyxKDJ6tSUKwmUq" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre>RMAN<span class="token operator">></span> CONFIGURE CONTROLFILE AUTOBACKUP <span class="token keyword">ON</span><span class="token punctuation">;</span>
<span class="token comment">-- 同时记录DBID</span>
RMAN<span class="token operator">></span> <span class="token keyword">backup</span> <span class="token keyword">as</span> compressed backupset tag full_all <span class="token keyword">database</span> format <span class="token string">'/home/oracle/rac-backup/full_%U_%T.bak'</span> PLUS ARCHIVELOG format <span class="token string">'/home/oracle/rac-backup/arch_%t_%s.bak'</span><span class="token punctuation">;</span></pre></div></code-block><div id="aJhuTDCgEpdvnD2fMocudP" class="wolai-block wolai-text"><div><span class="inline-wrap">进入<span class="jill"></span>asmcmd<span class="jill"></span>直接复制到/home/grid</span></div></div><code-block id="g31wr54Z3eZ3sLVtNtycNg" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 复制参数文件和控制文件（自动备份到一个文件中）</span>
ASMCMD<span class="token operator">></span> <span class="token function">cp</span> +DATA/demodb/autobackup/2021_12_25/s_1092197886.293.1092197887 /home/grid
<span class="token comment"># sysaux</span>

<span class="token comment"># system</span>
ASMCMD<span class="token operator">></span> <span class="token function">cp</span>  +DATA/demodb/backupset/2021_12_25/nnndf0_full_all_0.262.1092197797 /home/grid
<span class="token comment"># undotbs1、users、undotbs2</span>
ASMCMD<span class="token operator">></span> <span class="token function">cp</span> +DATA/demodb/backupset/2021_12_25/nnndf0_full_all_0.261.1092197861 /home/grid
ASMCMD<span class="token operator">></span> <span class="token function">cp</span> +DATA/demodb/datafile/undotbs1.258.1081074747 /home/grid</pre></div></code-block><div id="76gaqipVJQniuxmVdErunp" class="wolai-block wolai-text"><div><span class="inline-wrap">复制备份文件到单节点(/home/oracle/rac-backup)</span></div></div><h2 id="uertrR8eif7hW3C5h5FQKP" class="wolai-block"><span class="inline-wrap">设置<span class="jill"></span>spfile</span></h2><div id="r2RipML3jC5E9mLucJPhpE" class="wolai-block wolai-text"><div><span class="inline-wrap">还原备份的<span class="jill"></span>spfile（此时还是二进制的）</span></div></div><code-block id="bnaZ4PJJkPfqzemSoWXcYS" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token comment">-- 单节点需要open状态</span>
RMAN<span class="token operator">></span> <span class="token keyword">restore</span> spfile <span class="token keyword">to</span> <span class="token string">'/home/oracle/spfile'</span> <span class="token keyword">from</span> <span class="token string">'/home/oracle/rac-backup/s_1092197886.293.1092197887'</span><span class="token punctuation">;</span>

<span class="token keyword">Starting</span> <span class="token keyword">restore</span> at <span class="token number">24</span><span class="token operator">-</span><span class="token keyword">DEC</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token keyword">using</span> target <span class="token keyword">database</span> control <span class="token keyword">file</span> instead <span class="token keyword">of</span> recovery catalog
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID<span class="token operator">=</span><span class="token number">16</span> device <span class="token keyword">type</span><span class="token operator">=</span><span class="token keyword">DISK</span>

channel ORA_DISK_1: restoring spfile <span class="token keyword">from</span> AUTOBACKUP <span class="token operator">/</span>home<span class="token operator">/</span>oracle<span class="token operator">/</span>rac<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">/</span>spfile<span class="token punctuation">.</span>DEMODB<span class="token punctuation">.</span><span class="token number">310</span>himge
channel ORA_DISK_1: SPFILE <span class="token keyword">restore</span> <span class="token keyword">from</span> AUTOBACKUP complete
Finished <span class="token keyword">restore</span> at <span class="token number">24</span><span class="token operator">-</span><span class="token keyword">DEC</span><span class="token operator">-</span><span class="token number">21</span></pre></div></code-block><blockquote id="nHRg8uqe691xHSsVAxfGeD" class="wolai-block"><span class="inline-wrap">如果目标库提示未备份在目标库(mount<span class="jill"></span>状态)上执行</span></blockquote><code-block id="wUVc4MUKHrtTEd4rGBCvzW" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>backup database
<span class="token constant">CONFIGURE</span> <span class="token constant">CONTROLFILE</span> <span class="token constant">AUTOBACKUP</span> <span class="token constant">ON</span><span class="token punctuation">;</span>
<span class="token constant">CONFIGURE</span> <span class="token constant">CONTROLFILE</span> <span class="token constant">AUTOBACKUP</span> <span class="token constant">FORMAT</span> <span class="token constant">FOR</span> <span class="token constant">DEVICE</span> <span class="token constant">TYPE</span> <span class="token constant">DISK</span> <span class="token constant">TO</span> <span class="token string">'%F'</span><span class="token punctuation">;</span> 
<span class="token constant">CONFIGURE</span> <span class="token constant">CONTROLFILE</span> <span class="token constant">AUTOBACKUP</span> <span class="token constant">FORMAT</span> <span class="token constant">FOR</span> <span class="token constant">DEVICE</span> <span class="token constant">TYPE</span> <span class="token string">'SBT_TAPE'</span> <span class="token constant">TO</span> <span class="token string">'%d_%I_%F'</span><span class="token punctuation">;</span></pre></div></code-block><div id="1ta5TJx6iM29s9zuiZBGh8" class="wolai-block wolai-text"><div><span class="inline-wrap">将还原后的<span class="jill"></span>spfile<span class="jill"></span>转化为<span class="jill"></span>pfile</span></div></div><code-block id="eqYUwSYtXnnffSkz5fCsY7" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">create</span> pfile<span class="token operator">=</span><span class="token string">'/home/oracle/pfile'</span> <span class="token keyword">from</span> spfile<span class="token operator">=</span><span class="token string">'/home/oracle/spfile'</span><span class="token punctuation">;</span>

<span class="token keyword">File</span> created<span class="token punctuation">.</span></pre></div></code-block><h2 id="rzKVmgH14Rbrzpv9xJBMhZ" class="wolai-block"><span class="inline-wrap">设置<span class="jill"></span>pfile</span></h2><div id="9FkWS8dhgR4yN1Q8pt6BxL" class="wolai-block wolai-text"><div><span class="inline-wrap">关闭单节点数据库</span></div></div><code-block id="aaSnJWPGGhTd88WytEvJB1" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> shut immediate<span class="token punctuation">;</span>
<span class="token keyword">Database</span> closed<span class="token punctuation">.</span>
<span class="token keyword">Database</span> dismounted<span class="token punctuation">.</span>
ORACLE instance shut down<span class="token punctuation">.</span></pre></div></code-block><div id="t3tdK95RmE7d6WyP3ZwNNE" class="wolai-block wolai-text"><div><span class="inline-wrap">处理<span class="jill"></span>pfile<span class="jill"></span>文件内容：</span></div></div><ol class="wolai-block"><li id="uZAzsqFzeuxWbBwfZyAhkP"><div class="marker"></div><span class="inline-wrap">audit_file_dest, background_dump_dest, core_dump_dest,user_dump_dest, log_archive_dest_1<span class="jill"></span>等，与路径有关的参数，修改为你单实例环境的对应路径。</span></li><li id="oTmSaDiuq1UJyj9i5xYJV2"><div class="marker"></div><span class="inline-wrap">移除<span class="jill"></span>cluster_database_instances，cluster_database<span class="jill"></span>参数</span></li><li id="cNr6edBa2zK3rzvUXpK8iP"><div class="marker"></div><span class="inline-wrap">控制文件路径使用上方查询到的路径</span></li></ol><code-block id="jcs8KoXTkJQwD4ciUq5U8u" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 参考命令</span>
<span class="token function">grep</span> <span class="token string">"^*.*"</span> ./pfile <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">"\*.cluster_database|\*.remote_listener|\*.cluster_database_instances|\*.db_recovery_file_dest|\*.audit_trail"</span> <span class="token parameter variable">-v</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s#+DATA#<span class="token variable">$ORACLE_BASE</span>#g"</span>

<span class="token comment"># 生成修改后的pfile</span>
<span class="token comment"># grep "^*.*" ./pfile | grep -E "\*.cluster_database|\*.remote_listener|\*.cluster_database_instances|\*.control_files|\*.audit_trail" -v | sed "s#+DATA#$ORACLE_BASE#g"> pfile.modify</span>

<span class="token comment"># 修改前pfle</span>
<span class="token assign-left variable">demodb1.__db_cache_size</span><span class="token operator">=</span><span class="token number">671088640</span>
<span class="token assign-left variable">demodb2.__db_cache_size</span><span class="token operator">=</span><span class="token number">671088640</span>
<span class="token assign-left variable">demodb1.__java_pool_size</span><span class="token operator">=</span><span class="token number">16777216</span>
<span class="token assign-left variable">demodb2.__java_pool_size</span><span class="token operator">=</span><span class="token number">16777216</span>
<span class="token assign-left variable">demodb1.__large_pool_size</span><span class="token operator">=</span><span class="token number">33554432</span>
<span class="token assign-left variable">demodb2.__large_pool_size</span><span class="token operator">=</span><span class="token number">33554432</span>
<span class="token assign-left variable">demodb1.__oracle_base</span><span class="token operator">=</span><span class="token string">'/u01/app/oracle'</span><span class="token comment">#ORACLE_BASE set from environment</span>
<span class="token assign-left variable">demodb2.__oracle_base</span><span class="token operator">=</span><span class="token string">'/u01/app/oracle'</span><span class="token comment">#ORACLE_BASE set from environment</span>
<span class="token assign-left variable">demodb1.__pga_aggregate_target</span><span class="token operator">=</span><span class="token number">553648128</span>
<span class="token assign-left variable">demodb2.__pga_aggregate_target</span><span class="token operator">=</span><span class="token number">553648128</span>
<span class="token assign-left variable">demodb1.__sga_target</span><span class="token operator">=</span><span class="token number">1040187392</span>
<span class="token assign-left variable">demodb2.__sga_target</span><span class="token operator">=</span><span class="token number">1040187392</span>
<span class="token assign-left variable">demodb1.__shared_io_pool_size</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">demodb2.__shared_io_pool_size</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">demodb1.__shared_pool_size</span><span class="token operator">=</span><span class="token number">301989888</span>
<span class="token assign-left variable">demodb2.__shared_pool_size</span><span class="token operator">=</span><span class="token number">301989888</span>
<span class="token assign-left variable">demodb1.__streams_pool_size</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">demodb2.__streams_pool_size</span><span class="token operator">=</span><span class="token number">0</span>
*.audit_file_dest<span class="token operator">=</span><span class="token string">'/u01/app/oracle/admin/demodb/adump'</span>
*.audit_trail<span class="token operator">=</span><span class="token string">'db'</span>
*.cluster_database<span class="token operator">=</span>true
*.compatible<span class="token operator">=</span><span class="token string">'11.2.0.4.0'</span>
*.control_files<span class="token operator">=</span><span class="token string">'+DATA/demodb/controlfile/current.267.1081074889'</span>,<span class="token string">'+DATA/demodb/controlfile/current.256.1081074889'</span>
*.db_block_size<span class="token operator">=</span><span class="token number">8192</span>
*.db_create_file_dest<span class="token operator">=</span><span class="token string">'+DATA'</span>
*.db_domain<span class="token operator">=</span><span class="token string">''</span>
*.db_name<span class="token operator">=</span><span class="token string">'demodb'</span>
*.db_recovery_file_dest<span class="token operator">=</span><span class="token string">'+DATA'</span>
*.db_recovery_file_dest_size<span class="token operator">=</span><span class="token number">4621074432</span>
*.diagnostic_dest<span class="token operator">=</span><span class="token string">'/u01/app/oracle'</span>
*.dispatchers<span class="token operator">=</span><span class="token string">'(PROTOCOL=TCP) (SERVICE=demodbXDB)'</span>
<span class="token assign-left variable">demodb1.instance_number</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">demodb2.instance_number</span><span class="token operator">=</span><span class="token number">2</span>
*.memory_target<span class="token operator">=</span><span class="token number">1588592640</span>
*.open_cursors<span class="token operator">=</span><span class="token number">300</span>
*.processes<span class="token operator">=</span><span class="token number">150</span>
*.remote_listener<span class="token operator">=</span><span class="token string">'ora-scan:1521'</span>
*.remote_login_passwordfile<span class="token operator">=</span><span class="token string">'exclusive'</span>
<span class="token assign-left variable">demodb2.thread</span><span class="token operator">=</span><span class="token number">2</span>
<span class="token assign-left variable">demodb1.thread</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">demodb1.undo_tablespace</span><span class="token operator">=</span><span class="token string">'UNDOTBS1'</span>
<span class="token assign-left variable">demodb2.undo_tablespace</span><span class="token operator">=</span><span class="token string">'UNDOTBS2'</span>


<span class="token comment"># 修改后的pfile.modify</span>
*.audit_file_dest<span class="token operator">=</span><span class="token string">'/u01/app/oracle/admin/demodb/adump'</span>
*.compatible<span class="token operator">=</span><span class="token string">'11.2.0.4.0'</span>
*.db_block_size<span class="token operator">=</span><span class="token number">8192</span>
*.db_create_file_dest<span class="token operator">=</span><span class="token string">'/u01/app/oracle'</span>
*.db_domain<span class="token operator">=</span><span class="token string">''</span>
*.db_name<span class="token operator">=</span><span class="token string">'demodb'</span>
*.db_recovery_file_dest<span class="token operator">=</span><span class="token string">'/u01/app/oracle'</span>
*.db_recovery_file_dest_size<span class="token operator">=</span><span class="token number">4621074432</span>
*.diagnostic_dest<span class="token operator">=</span><span class="token string">'/u01/app/oracle'</span>
*.dispatchers<span class="token operator">=</span><span class="token string">'(PROTOCOL=TCP) (SERVICE=demodbXDB)'</span>
*.log_archive_dest_1<span class="token operator">=</span><span class="token string">'location=/u01/app/oracle/archivelog'</span>
*.memory_target<span class="token operator">=</span><span class="token number">1588592640</span>
*.open_cursors<span class="token operator">=</span><span class="token number">300</span>
*.processes<span class="token operator">=</span><span class="token number">150</span>
*.remote_login_passwordfile<span class="token operator">=</span><span class="token string">'exclusive'</span></pre></div></code-block><div id="a198aoC5i6JyY1Vutk6MVR" class="wolai-block wolai-text"><div><span class="inline-wrap">根据<span class="jill"></span>pfile.modify<span class="jill"></span>创建相关文件夹</span></div></div><code-block id="3sXYqmWbreEur6CPvfP7Fc" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /u01/app/oracle/admin/demodb/adump
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /u01/app/oracle/archivelog
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /u01/app/oracle/oradata/restore</pre></div></code-block><div id="aYA7tzGZPJ1E4pVE464crk" class="wolai-block wolai-text"><div><span class="inline-wrap">启动（注意备份<span class="jill"></span>spfile）</span></div></div><code-block id="pZrBmA8X1pFmVu9jtmAwwL" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> startup nomount pfile<span class="token operator">=</span><span class="token string">'/home/oracle/pfile.modify'</span></pre></div></code-block><div id="jv928CyMtMnxibw9NQf6Ft" class="wolai-block wolai-text"><div><span class="inline-wrap">保存参数文件</span></div></div><code-block id="i3E391jvB2rRr1FtbtRFqD" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">create</span> spfile <span class="token keyword">from</span> pfile<span class="token operator">=</span><span class="token string">'/home/oracle/pfile.modify'</span><span class="token punctuation">;</span></pre></div></code-block><h2 id="ci8nfcaydi54rhBA8VF54u" class="wolai-block"><span class="inline-wrap">设置控制文件</span></h2><div id="mYu1mNao8V97MBFtmXUwnp" class="wolai-block wolai-text"><div><span class="inline-wrap">获取<span class="jill"></span>DBID<span class="jill"></span>并删除日志文件</span></div></div><code-block id="sHVHkfKPRHvyrCAnyRHTUC" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>oracle@localhost ~<span class="token punctuation">]</span>$ <span class="token function">grep</span> <span class="token string">"DBID=[[:digit:]]*"</span> /home/oracle/rac-backup/rman.log <span class="token parameter variable">-o</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> /home/oracle/rac-backup/rman.log
<span class="token assign-left variable">DBID</span><span class="token operator">=</span><span class="token number">4077342536</span></pre></div></code-block><div id="dB8Lp3vndqfqbciDidLjc2" class="wolai-block wolai-text"><div><span class="inline-wrap">恢复控制文件</span></div></div><code-block id="hy44K2MHKzG5N4nq1XWVVp" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token punctuation">[</span>oracle<span class="token variable">@localhost</span> <span class="token operator">~</span><span class="token punctuation">]</span>$ rman target <span class="token operator">/</span>
Recovery Manager: <span class="token keyword">Release</span> <span class="token number">11.2</span><span class="token number">.0</span><span class="token number">.4</span><span class="token number">.0</span> <span class="token operator">-</span> Production <span class="token keyword">on</span> Fri <span class="token keyword">Dec</span> <span class="token number">24</span> <span class="token number">20</span>:<span class="token number">35</span>:<span class="token number">59</span> <span class="token number">2021</span>
Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">1982</span><span class="token punctuation">,</span> <span class="token number">2011</span><span class="token punctuation">,</span> Oracle <span class="token operator">and</span><span class="token operator">/</span><span class="token operator">or</span> its affiliates<span class="token punctuation">.</span>  <span class="token keyword">All</span> rights reserved<span class="token punctuation">.</span>
connected <span class="token keyword">to</span> target <span class="token keyword">database</span>: DEMODB <span class="token punctuation">(</span><span class="token operator">not</span> mounted<span class="token punctuation">)</span>

RMAN<span class="token operator">></span> <span class="token keyword">set</span> dbid<span class="token operator">=</span><span class="token number">4077342536</span><span class="token punctuation">;</span>
executing command: <span class="token keyword">SET</span> DBID

RMAN<span class="token operator">></span> <span class="token keyword">restore</span> controlfile <span class="token keyword">from</span> <span class="token string">'/home/oracle/rac-backup/s_1092197886.293.1092197887'</span><span class="token punctuation">;</span>

<span class="token keyword">Starting</span> <span class="token keyword">restore</span> at <span class="token number">25</span><span class="token operator">-</span><span class="token keyword">DEC</span><span class="token operator">-</span><span class="token number">21</span>
<span class="token keyword">using</span> target <span class="token keyword">database</span> control <span class="token keyword">file</span> instead <span class="token keyword">of</span> recovery catalog
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID<span class="token operator">=</span><span class="token number">10</span> device <span class="token keyword">type</span><span class="token operator">=</span><span class="token keyword">DISK</span>

channel ORA_DISK_1: restoring control <span class="token keyword">file</span>
channel ORA_DISK_1: <span class="token keyword">restore</span> complete<span class="token punctuation">,</span> elapsed <span class="token keyword">time</span>: <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">01</span>
output <span class="token keyword">file</span> name<span class="token operator">=</span><span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>DEMODB<span class="token operator">/</span>controlfile<span class="token operator">/</span>o1_mf_jwdjhswt_<span class="token punctuation">.</span>ctl
output <span class="token keyword">file</span> name<span class="token operator">=</span><span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>DEMODB<span class="token operator">/</span>controlfile<span class="token operator">/</span>o1_mf_jwdjhsxg_<span class="token punctuation">.</span>ctl
Finished <span class="token keyword">restore</span> at <span class="token number">25</span><span class="token operator">-</span><span class="token keyword">DEC</span><span class="token operator">-</span><span class="token number">21</span></pre></div></code-block><div id="46YkaCiMso66JRWpV8TxvC" class="wolai-block wolai-text"><div><span class="inline-wrap">启动到<span class="jill"></span>mount</span></div></div><code-block id="mTS9MiaDqp6GFRvEqfkrq8" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre>RMAN<span class="token operator">></span>  <span class="token keyword">alter</span> <span class="token keyword">database</span> mount<span class="token punctuation">;</span>
<span class="token keyword">database</span> mounted
released channel: ORA_DISK_1</pre></div></code-block><div id="mH6wU32tZ1uqb6R7s9wpJN" class="wolai-block wolai-text"><div><span class="inline-wrap">加载备份文件</span></div></div><code-block id="4szKiTx6MKUMLixxk32ow1" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token comment">-- 因为备份集更改了位置，所以删除控制文件中记录的旧信息，注册现在的备份集</span>
RMAN<span class="token operator">></span> crosscheck <span class="token keyword">backup</span> <span class="token keyword">of</span> <span class="token keyword">database</span><span class="token punctuation">;</span>
RMAN<span class="token operator">></span> crosscheck <span class="token keyword">backup</span> <span class="token keyword">of</span> archivelog <span class="token keyword">all</span><span class="token punctuation">;</span>
RMAN<span class="token operator">></span> <span class="token keyword">delete</span> expired backupset<span class="token punctuation">;</span>

RMAN<span class="token operator">></span> catalog <span class="token keyword">start</span> <span class="token keyword">with</span> <span class="token string">'/home/oracle/rac-backup/'</span><span class="token punctuation">;</span> 

searching <span class="token keyword">for</span> <span class="token keyword">all</span> files that <span class="token keyword">match</span> the pattern <span class="token operator">/</span>home<span class="token operator">/</span>oracle<span class="token operator">/</span>rac<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">/</span>

List <span class="token keyword">of</span> Files Unknown <span class="token keyword">to</span> the <span class="token keyword">Database</span>
<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span>
<span class="token keyword">File</span> Name: <span class="token operator">/</span>home<span class="token operator">/</span>oracle<span class="token operator">/</span>rac<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">/</span>nnndf0_full_all_0<span class="token punctuation">.</span><span class="token number">261.1092197861</span>
<span class="token keyword">File</span> Name: <span class="token operator">/</span>home<span class="token operator">/</span>oracle<span class="token operator">/</span>rac<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">/</span>nnndf0_full_all_0<span class="token punctuation">.</span><span class="token number">262.1092197797</span>
<span class="token keyword">File</span> Name: <span class="token operator">/</span>home<span class="token operator">/</span>oracle<span class="token operator">/</span>rac<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">/</span>nnndf0_full_all_0<span class="token punctuation">.</span><span class="token number">265.1092197639</span>
<span class="token keyword">File</span> Name: <span class="token operator">/</span>home<span class="token operator">/</span>oracle<span class="token operator">/</span>rac<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">/</span>s_1092197886<span class="token punctuation">.</span><span class="token number">293.1092197887</span>

<span class="token keyword">Do</span> you really want <span class="token keyword">to</span> catalog the above files <span class="token punctuation">(</span>enter YES <span class="token operator">or</span> <span class="token keyword">NO</span><span class="token punctuation">)</span>? yes
cataloging files<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
cataloging done

List <span class="token keyword">of</span> Cataloged Files
<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span>
<span class="token keyword">File</span> Name: <span class="token operator">/</span>home<span class="token operator">/</span>oracle<span class="token operator">/</span>rac<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">/</span>nnndf0_full_all_0<span class="token punctuation">.</span><span class="token number">261.1092197861</span>
<span class="token keyword">File</span> Name: <span class="token operator">/</span>home<span class="token operator">/</span>oracle<span class="token operator">/</span>rac<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">/</span>nnndf0_full_all_0<span class="token punctuation">.</span><span class="token number">262.1092197797</span>
<span class="token keyword">File</span> Name: <span class="token operator">/</span>home<span class="token operator">/</span>oracle<span class="token operator">/</span>rac<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">/</span>nnndf0_full_all_0<span class="token punctuation">.</span><span class="token number">265.1092197639</span>
<span class="token keyword">File</span> Name: <span class="token operator">/</span>home<span class="token operator">/</span>oracle<span class="token operator">/</span>rac<span class="token operator">-</span><span class="token keyword">backup</span><span class="token operator">/</span>s_1092197886<span class="token punctuation">.</span><span class="token number">293.1092197887</span></pre></div></code-block><h2 id="cAqjqVdSVBiQ4vHNjZ8zeZ" class="wolai-block"><span class="inline-wrap">设置数据文件</span></h2><div id="8h17pbNvPGKPp79BwSQHY6" class="wolai-block wolai-text"><div><span class="inline-wrap">查看<span class="jill"></span>schema</span></div></div><code-block id="oyUje6dpjsdACXU2QfA7Xp" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token constant">RMAN</span><span class="token operator">></span> report schema<span class="token punctuation">;</span>

<span class="token constant">RMAN</span><span class="token operator">-</span><span class="token number">06139</span><span class="token operator">:</span> <span class="token constant">WARNING</span><span class="token operator">:</span> control file is not current <span class="token keyword control-flow">for</span> <span class="token constant">REPORT</span> <span class="token constant">SCHEMA</span>
<span class="token maybe-class-name">Report</span> <span class="token keyword">of</span> database schema <span class="token keyword control-flow">for</span> database <span class="token keyword">with</span> db_unique_name <span class="token constant">DEMODB</span>

<span class="token maybe-class-name">List</span> <span class="token keyword">of</span> <span class="token maybe-class-name">Permanent</span> <span class="token maybe-class-name">Datafiles</span>
<span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span>
<span class="token maybe-class-name">File</span> <span class="token function"><span class="token maybe-class-name">Size</span></span><span class="token punctuation">(</span><span class="token constant">MB</span><span class="token punctuation">)</span> <span class="token maybe-class-name">Tablespace</span>           <span class="token constant">RB</span> segs <span class="token maybe-class-name">Datafile</span> <span class="token maybe-class-name">Name</span>
<span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token number">1</span>    <span class="token number">0</span>        <span class="token constant">SYSTEM</span>               <span class="token operator">**</span><span class="token operator">*</span>     <span class="token operator">+</span><span class="token constant">DATA</span><span class="token operator">/</span>demodb<span class="token operator">/</span>datafile<span class="token operator">/</span>system<span class="token punctuation">.</span><span class="token number">264.1081074747</span>
<span class="token number">2</span>    <span class="token number">0</span>        <span class="token constant">SYSAUX</span>               <span class="token operator">**</span><span class="token operator">*</span>     <span class="token operator">+</span><span class="token constant">DATA</span><span class="token operator">/</span>demodb<span class="token operator">/</span>datafile<span class="token operator">/</span>sysaux<span class="token punctuation">.</span><span class="token number">259.1081074747</span>
<span class="token number">3</span>    <span class="token number">0</span>        <span class="token constant">UNDOTBS1</span>             <span class="token operator">**</span><span class="token operator">*</span>     <span class="token operator">+</span><span class="token constant">DATA</span><span class="token operator">/</span>demodb<span class="token operator">/</span>datafile<span class="token operator">/</span>undotbs1<span class="token punctuation">.</span><span class="token number">258.1081074747</span>
<span class="token number">4</span>    <span class="token number">0</span>        <span class="token constant">USERS</span>                <span class="token operator">**</span><span class="token operator">*</span>     <span class="token operator">+</span><span class="token constant">DATA</span><span class="token operator">/</span>demodb<span class="token operator">/</span>datafile<span class="token operator">/</span>users<span class="token punctuation">.</span><span class="token number">257.1081074747</span>
<span class="token number">5</span>    <span class="token number">0</span>        <span class="token constant">UNDOTBS2</span>             <span class="token operator">**</span><span class="token operator">*</span>     <span class="token operator">+</span><span class="token constant">DATA</span><span class="token operator">/</span>demodb<span class="token operator">/</span>datafile<span class="token operator">/</span>undotbs2<span class="token punctuation">.</span><span class="token number">285.1081074909</span>
<span class="token number">6</span>    <span class="token number">0</span>        <span class="token constant">XY</span>                   <span class="token operator">**</span><span class="token operator">*</span>     <span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>xy<span class="token punctuation">.</span><span class="token property-access">dbf</span>

<span class="token maybe-class-name">List</span> <span class="token keyword">of</span> <span class="token maybe-class-name">Temporary</span> <span class="token maybe-class-name">Files</span>
<span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">==</span>
<span class="token maybe-class-name">File</span> <span class="token function"><span class="token maybe-class-name">Size</span></span><span class="token punctuation">(</span><span class="token constant">MB</span><span class="token punctuation">)</span> <span class="token maybe-class-name">Tablespace</span>           <span class="token function"><span class="token maybe-class-name">Maxsize</span></span><span class="token punctuation">(</span><span class="token constant">MB</span><span class="token punctuation">)</span> <span class="token maybe-class-name">Tempfile</span> <span class="token maybe-class-name">Name</span>
<span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token number">1</span>    <span class="token number">20</span>       <span class="token constant">TEMP</span>                 <span class="token number">32767</span>       <span class="token operator">+</span><span class="token constant">DATA</span><span class="token operator">/</span>demodb<span class="token operator">/</span>tempfile<span class="token operator">/</span>temp<span class="token punctuation">.</span><span class="token number">284.1081074901</span>

<span class="token constant">RMAN</span><span class="token operator">></span> </pre></div></code-block><div id="j4VpBduZvFDTqjDSTq5aut" class="wolai-block wolai-text"><div><span class="inline-wrap">利用<span class="jill"></span>File<span class="jill"></span>列和<span class="jill"></span>DatafileName<span class="jill"></span>列设置新名词</span></div></div><code-block id="hbPgaCi3MBXitGCTFpX1wR" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>run <span class="token punctuation">{</span>
<span class="token keyword">set</span> newname <span class="token keyword control-flow">for</span> datafile <span class="token number">1</span> to <span class="token string">'/u01/app/oracle/oradata/restore/system.dbf'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> newname <span class="token keyword control-flow">for</span> datafile <span class="token number">2</span> to <span class="token string">'/u01/app/oracle/oradata/restore/sysaux.dbf'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> newname <span class="token keyword control-flow">for</span> datafile <span class="token number">3</span> to <span class="token string">'/u01/app/oracle/oradata/restore/undotbs1.dbf'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> newname <span class="token keyword control-flow">for</span> datafile <span class="token number">4</span> to <span class="token string">'/u01/app/oracle/oradata/restore/users.dbf'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> newname <span class="token keyword control-flow">for</span> datafile <span class="token number">5</span> to <span class="token string">'/u01/app/oracle/oradata/restore/undotbs2.dbf'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> newname <span class="token keyword control-flow">for</span> datafile <span class="token number">6</span> to <span class="token string">'/u01/app/oracle/oradata/restore/xy.dbf'</span><span class="token punctuation">;</span>
<span class="token constant">SET</span> <span class="token constant">NEWNAME</span> <span class="token constant">FOR</span> <span class="token constant">TEMPFILE</span> <span class="token number">1</span> to <span class="token string">'/u01/app/oracle/oradata/restore/temp01.dbf'</span><span class="token punctuation">;</span>
restore database<span class="token punctuation">;</span>
<span class="token constant">SWITCH</span> <span class="token constant">DATAFILE</span> <span class="token constant">ALL</span><span class="token punctuation">;</span>
<span class="token constant">SWITCH</span> <span class="token constant">TEMPFILE</span> <span class="token constant">ALL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="2RNoTR3T8iujgbN4hL4YL4" class="wolai-block wolai-text"><div><span class="inline-wrap">上方命令在<span class="jill"></span>rman<span class="jill"></span>下运行正常时，查看数据文件应有如下输出</span></div></div><code-block id="2bk9ynJTVzg9sjY1H76KSy" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>oracle@localhost rac-backup<span class="token punctuation">]</span>$ <span class="token function">ls</span> <span class="token parameter variable">-1</span> /u01/app/oracle/oradata/restore/
sysaux.dbf
system.dbf
undotbs1.dbf
undotbs2.dbf
users.dbf
xy.dbf</pre></div></code-block><div id="aA8qdwjjPg4ezyGt779WAV" class="wolai-block wolai-text"><div><span class="inline-wrap">数据文件恢复后,RECOVER<span class="jill"></span>数据库</span></div></div><code-block id="gtaJF6RHoengEvZW1tRuun" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token constant">RMAN</span><span class="token operator">></span> recover database<span class="token punctuation">;</span></pre></div></code-block><div id="wJYz18U1gRRHqGRjgGcSsT" class="wolai-block wolai-text"><div><span class="inline-wrap">如果提示<span class="jill"></span>RMAN-06025: no backup of archived log for thread 1 with sequence 557 and starting SCN of 22227940 found to restore</span></div></div><div id="iUvYkzLpapvefR7fLnapzt" class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>rac<span class="jill"></span>端备份归档日志或直接使用本文开头使用的归档日志，并复制到单节点的/home/rac-backup<span class="jill"></span>并在单节点注册单个备份片</span></div></div><code-block id="hv5NKum9GvTAkCB2XJcfVi" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token comment">-- 单节点</span>
RMAN<span class="token operator">></span>CATALOG BACKUPPIECE  <span class="token string">'/home/oracle/rac-backup/arch_1092202140_116_.dbf'</span><span class="token punctuation">;</span></pre></div></code-block><div id="6GSrQ6azX3KXTdwKYYqpam" class="wolai-block wolai-text"><div><span class="inline-wrap">重新恢复数据库，只要<span class="jill"></span>ststem.dbf<span class="jill"></span>等数据文件没有报错，可以忽略 media recovery requesting unknown archived log for thread 1 with sequence 559 and starting SCN of 22232905<span class="jill"></span>类似报错</span></div></div><code-block id="oFeMJzfmEazZB6DaDdgHaU" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre>RMAN<span class="token operator">></span> recover <span class="token keyword">database</span><span class="token punctuation">;</span>
<span class="token keyword">Database</span> altered<span class="token punctuation">.</span></pre></div></code-block><h2 id="aYbdDuKvTteRjdtz6N6C4y" class="wolai-block"><span class="inline-wrap">设置重做日志</span></h2><div id="nMW4B3H8e5jC9Lmqi4zWyW" class="wolai-block wolai-text"><div><span class="inline-wrap">设置重做日志文件路径，再输出结果交给<span class="jill"></span>sqlplus<span class="jill"></span>执行</span></div></div><code-block id="tY6BE7APZ4nrsiydBk21ET" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token comment">-- 查看当前重做日志文件位置</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">set</span> pagesize <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">SET</span> LINESIZE <span class="token number">150</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> member <span class="token keyword">from</span> v$logfile<span class="token punctuation">;</span>
<span class="token comment">-- 设置新的重做日志路径</span>
<span class="token comment">-- 24为重做日志文件所在的文件夹的字符长度</span>
<span class="token comment">-- 如果尾部没有.log，可以用编辑器添加</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token string">'alter database rename file '''</span><span class="token operator">||</span>member<span class="token operator">||</span><span class="token string">''' to ''/u01/app/oracle/oradata/restore/'</span><span class="token operator">||</span>substr<span class="token punctuation">(</span>member<span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">''''</span> <span class="token keyword">from</span> v$logfile<span class="token punctuation">;</span>


<span class="token comment">-- 执行重命名的语句</span>
<span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">rename</span> <span class="token keyword">file</span> <span class="token string">'+DATA/demodb/onlinelog/group_2.282.1081074893'</span> <span class="token keyword">to</span> <span class="token string">'/u01/app/oracle/oradata/restore/redo01.log'</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">rename</span> <span class="token keyword">file</span> <span class="token string">'+DATA/demodb/onlinelog/group_2.283.1081074893'</span> <span class="token keyword">to</span> <span class="token string">'/u01/app/oracle/oradata/restore/redo02.log'</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">rename</span> <span class="token keyword">file</span> <span class="token string">'+DATA/demodb/onlinelog/group_1.280.1081074893'</span> <span class="token keyword">to</span> <span class="token string">'/u01/app/oracle/oradata/restore/redo03.log'</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">rename</span> <span class="token keyword">file</span> <span class="token string">'+DATA/demodb/onlinelog/group_1.281.1081074893'</span> <span class="token keyword">to</span> <span class="token string">'/u01/app/oracle/oradata/restore/redo04.log'</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">rename</span> <span class="token keyword">file</span> <span class="token string">'+DATA/demodb/onlinelog/group_3.286.1081074975'</span> <span class="token keyword">to</span> <span class="token string">'/u01/app/oracle/oradata/restore/redo05.log'</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">rename</span> <span class="token keyword">file</span> <span class="token string">'+DATA/demodb/onlinelog/group_3.287.1081074975'</span> <span class="token keyword">to</span> <span class="token string">'/u01/app/oracle/oradata/restore/redo06.log'</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">rename</span> <span class="token keyword">file</span> <span class="token string">'+DATA/demodb/onlinelog/group_4.288.1081074975'</span> <span class="token keyword">to</span> <span class="token string">'/u01/app/oracle/oradata/restore/redo07.log'</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">rename</span> <span class="token keyword">file</span> <span class="token string">'+DATA/demodb/onlinelog/group_4.289.1081074975'</span> <span class="token keyword">to</span> <span class="token string">'/u01/app/oracle/oradata/restore/redo08.log'</span><span class="token punctuation">;</span>

<span class="token comment">-- 执行后重新查看文件名</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> member <span class="token keyword">from</span> v$logfile<span class="token punctuation">;</span>
MEMBER
<span class="token comment">---------------------------------------------</span>
<span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>oradata<span class="token operator">/</span><span class="token keyword">restore</span><span class="token operator">/</span>redo01<span class="token punctuation">.</span>log
<span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>oradata<span class="token operator">/</span><span class="token keyword">restore</span><span class="token operator">/</span>redo02<span class="token punctuation">.</span>log
<span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>oradata<span class="token operator">/</span><span class="token keyword">restore</span><span class="token operator">/</span>redo03<span class="token punctuation">.</span>log
<span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>oradata<span class="token operator">/</span><span class="token keyword">restore</span><span class="token operator">/</span>redo04<span class="token punctuation">.</span>log
<span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>oradata<span class="token operator">/</span><span class="token keyword">restore</span><span class="token operator">/</span>redo05<span class="token punctuation">.</span>log
<span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>oradata<span class="token operator">/</span><span class="token keyword">restore</span><span class="token operator">/</span>redo06<span class="token punctuation">.</span>log
<span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>oradata<span class="token operator">/</span><span class="token keyword">restore</span><span class="token operator">/</span>redo07<span class="token punctuation">.</span>log
<span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>oracle<span class="token operator">/</span>oradata<span class="token operator">/</span><span class="token keyword">restore</span><span class="token operator">/</span>redo08<span class="token punctuation">.</span>log</pre></div></code-block><div id="wqxg8S1D45fogCaqfAyXP1" class="wolai-block wolai-text"><div><span class="inline-wrap">如果有<span class="jill"></span>CLEARING_CURRENT<span class="jill"></span>的日志组，需要清除</span></div></div><code-block id="iFpmkXzVRFyqEGnA48mxYH" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token keyword">group</span><span class="token comment">#,thread#,status from v$log;</span>
    <span class="token keyword">GROUP</span><span class="token comment">#    THREAD# STATUS</span>
<span class="token comment">---------- ---------- ----------------</span>
	 <span class="token number">1</span>	    <span class="token number">1</span> CLEARING
	 <span class="token number">2</span>	    <span class="token number">1</span> CLEARING_CURRENT
	 <span class="token number">3</span>	    <span class="token number">2</span> CLEARING
	 <span class="token number">4</span>	    <span class="token number">2</span> CLEARING_CURRENT

<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">database</span> clear logfile <span class="token keyword">group</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">Database</span> altered<span class="token punctuation">.</span>

<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">database</span> clear logfile <span class="token keyword">group</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">Database</span> altered<span class="token punctuation">.</span>

<span class="token comment">-- 状态为CURRENT,表示日志正在使用</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token keyword">group</span><span class="token comment">#,thread#,status from v$log;</span>
    <span class="token keyword">GROUP</span><span class="token comment">#    THREAD# STATUS</span>
<span class="token comment">---------- ---------- ----------------</span>
	 <span class="token number">1</span>	    <span class="token number">1</span> CLEARING
	 <span class="token number">2</span>	    <span class="token number">1</span> <span class="token keyword">CURRENT</span>
	 <span class="token number">3</span>	    <span class="token number">2</span> CLEARING
	 <span class="token number">4</span>	    <span class="token number">2</span> <span class="token keyword">CURRENT</span></pre></div></code-block><div id="ebxwqvnTMkvthvbp1bThwM" class="wolai-block wolai-text"><div><span class="inline-wrap">备份控制文件</span></div></div><code-block id="eY552gu18HKgW9KMZSUxTv" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">backup</span> controlfile <span class="token keyword">to</span> trace <span class="token keyword">as</span> <span class="token string">'/home/oracle/ctl.control'</span><span class="token punctuation">;</span></pre></div></code-block><h2 id="pi6T3LQWpBdySGPFNXF35b" class="wolai-block"><span class="inline-wrap">启动单节点数据库</span></h2><code-block id="65tSHN23odPLoj38xUvcji" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">open</span> resetlogs<span class="token punctuation">;</span>

<span class="token keyword">Database</span> altered<span class="token punctuation">.</span></pre></div></code-block></article><footer></footer></body></html>