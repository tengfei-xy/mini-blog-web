<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>逻辑迁移一键收集脚本 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font less-lead"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="逻辑迁移一键收集脚本" class="main-title"></div></div></header><article><code-block id="oJJbXcw9BAnjN1dyhQuiWE" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">column</span> OWNER <span class="token keyword">for</span> a30
<span class="token keyword">column</span> DIRECTORY_NAME <span class="token keyword">for</span> a30
<span class="token keyword">column</span> DIRECTORY_PATH <span class="token keyword">for</span> a50
<span class="token keyword">column</span> PARAMETER <span class="token keyword">for</span> a40
<span class="token keyword">column</span> <span class="token keyword">VALUE</span> <span class="token keyword">for</span> a40
<span class="token keyword">column</span> sid format <span class="token number">9999</span>
<span class="token keyword">column</span> command format a20
<span class="token keyword">column</span> program format a25
<span class="token keyword">column</span> username format a15
<span class="token keyword">column</span> machine format a15
<span class="token keyword">column</span> event format a25
<span class="token keyword">column</span> sql_text format a40
<span class="token keyword">column</span> name format a30
<span class="token keyword">column</span> member format a30
<span class="token keyword">column</span> <span class="token keyword">type</span> format a20
<span class="token keyword">column</span> <span class="token keyword">value</span> format a35
<span class="token keyword">column</span> RY_TABLESPACE <span class="token keyword">for</span> a20
<span class="token keyword">column</span> PROFILE <span class="token keyword">for</span> a40
<span class="token keyword">column</span> table_name <span class="token keyword">for</span> a50
<span class="token keyword">column</span> grantor <span class="token keyword">for</span> a30
<span class="token keyword">column</span> GRANTEE <span class="token keyword">for</span> a30
<span class="token keyword">column</span> KSPPDESC <span class="token keyword">for</span> a50
<span class="token keyword">column</span> KSPPINM <span class="token keyword">for</span> a50
<span class="token keyword">column</span> KSPPSTVL <span class="token keyword">for</span> a50
<span class="token keyword">column</span> FILE_NAME <span class="token keyword">for</span> a70
<span class="token keyword">column</span> DB_LINK <span class="token keyword">for</span> a40
<span class="token keyword">column</span> HOST <span class="token keyword">for</span> a40
<span class="token keyword">column</span> table_name <span class="token keyword">for</span> a50
<span class="token keyword">column</span> segment_name <span class="token keyword">for</span> a50

<span class="token keyword">set</span> linesize <span class="token number">1000</span>
<span class="token keyword">set</span> trims <span class="token keyword">on</span>
<span class="token keyword">set</span> echo <span class="token keyword">off</span>
<span class="token keyword">set</span> termout <span class="token keyword">off</span>
spool user_exp_check<span class="token punctuation">.</span>log
<span class="token keyword">create</span> <span class="token keyword">table</span> exp_check <span class="token keyword">as</span> 
<span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">as</span> id <span class="token punctuation">,</span> username <span class="token keyword">from</span> dba_users 
<span class="token keyword">where</span> account_status<span class="token operator">=</span><span class="token string">'OPEN'</span> 
<span class="token operator">and</span> username <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'ANONYMOUS'</span><span class="token punctuation">,</span> <span class="token string">'CTXSYS'</span><span class="token punctuation">,</span> <span class="token string">'DBSNMP'</span><span class="token punctuation">,</span> <span class="token string">'EXFSYS'</span><span class="token punctuation">,</span> <span class="token string">'LBACSYS'</span><span class="token punctuation">,</span><span class="token string">'MDSYS'</span><span class="token punctuation">,</span>  <span class="token string">'MGMT_VIEW'</span><span class="token punctuation">,</span>  <span class="token string">'OLAPSYS'</span><span class="token punctuation">,</span>  <span class="token string">'ORDDATA'</span><span class="token punctuation">,</span>  <span class="token string">'OWBSYS'</span><span class="token punctuation">,</span><span class="token string">'ORDPLUGINS'</span><span class="token punctuation">,</span>  <span class="token string">'ORDSYS'</span><span class="token punctuation">,</span>  <span class="token string">'OUTLN'</span><span class="token punctuation">,</span>  <span class="token string">'SI_INFORMTN_SCHEMA'</span><span class="token punctuation">,</span>  <span class="token string">'SYS'</span><span class="token punctuation">,</span><span class="token string">'SYSMAN'</span><span class="token punctuation">,</span>  <span class="token string">'SYSTEM'</span><span class="token punctuation">,</span>  <span class="token string">'WK_TEST'</span><span class="token punctuation">,</span>  <span class="token string">'WKSYS'</span><span class="token punctuation">,</span>  <span class="token string">'WKPROXY'</span><span class="token punctuation">,</span><span class="token string">'WMSYS'</span><span class="token punctuation">,</span>  <span class="token string">'XDB'</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check directorts'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dba_directories<span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check Character set'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> NLS_DATABASE_PARAMETERS<span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check open user'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> username<span class="token punctuation">,</span>default_tablespace<span class="token punctuation">,</span>temporary_tablespace<span class="token punctuation">,</span>profile<span class="token punctuation">,</span>account_status <span class="token keyword">from</span> dba_users <span class="token keyword">where</span> account_status<span class="token operator">=</span><span class="token string">'OPEN'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check  user privilege and role'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> owner<span class="token punctuation">,</span>table_name<span class="token punctuation">,</span>grantor<span class="token punctuation">,</span>privilege <span class="token keyword">from</span> dba_tab_privs <span class="token keyword">where</span> grantee <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> username <span class="token keyword">from</span> exp_check<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> grantee<span class="token punctuation">,</span>privilege <span class="token keyword">from</span> dba_sys_privs <span class="token keyword">where</span> grantee <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> username <span class="token keyword">from</span> exp_check<span class="token punctuation">)</span> <span class="token keyword">union</span> <span class="token keyword">select</span> grantee<span class="token punctuation">,</span>privilege <span class="token keyword">from</span> dba_sys_privs <span class="token keyword">where</span> grantee <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> granted_role <span class="token keyword">from</span> dba_role_privs <span class="token keyword">where</span> grantee <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> username <span class="token keyword">from</span> exp_check<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check  user index'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> owner<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dba_indexes <span class="token keyword">where</span> owner <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> username <span class="token keyword">from</span> exp_check<span class="token punctuation">)</span> <span class="token keyword">group</span> <span class="token keyword">by</span> owner <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check  user lob'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> l<span class="token punctuation">.</span>owner<span class="token punctuation">,</span>l<span class="token punctuation">.</span>table_name<span class="token punctuation">,</span>l<span class="token punctuation">.</span>segment_name<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Bytes<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> GB <span class="token keyword">from</span> dba_lobs l <span class="token keyword">left</span> <span class="token keyword">join</span> dba_segments s  <span class="token keyword">on</span> l<span class="token punctuation">.</span>segment_name<span class="token operator">=</span>s<span class="token punctuation">.</span>segment_name <span class="token keyword">where</span>  l<span class="token punctuation">.</span>owner  <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> username <span class="token keyword">from</span> exp_check<span class="token punctuation">)</span>  <span class="token keyword">group</span> <span class="token keyword">by</span> l<span class="token punctuation">.</span>owner<span class="token punctuation">,</span>l<span class="token punctuation">.</span>table_name<span class="token punctuation">,</span>l<span class="token punctuation">.</span>segment_name  <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">4</span><span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check  user object count'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> owner<span class="token punctuation">,</span>object_type<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dba_objects <span class="token keyword">where</span> owner  <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> username <span class="token keyword">from</span> exp_check<span class="token punctuation">)</span> <span class="token operator">and</span> object_type <span class="token operator">!=</span><span class="token string">'LOB'</span> <span class="token keyword">group</span> <span class="token keyword">by</span> owner<span class="token punctuation">,</span>object_type<span class="token punctuation">,</span><span class="token keyword">status</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check user object in system/sysaux'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> owner<span class="token punctuation">,</span>segment_name<span class="token punctuation">,</span>tablespace_name <span class="token keyword">from</span> dba_segments <span class="token keyword">where</span> owner  <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> username <span class="token keyword">from</span> exp_check<span class="token punctuation">)</span>  <span class="token operator">and</span> tablespace_name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">,</span><span class="token string">'sysaux'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
if user segment data in sys tablespace
table:alter table tab_name move tablespace tbs_name; 
index:alter index index_name rebuild tablespace tbs_name;
*/</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check invalid object'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> owner<span class="token punctuation">,</span>object_type<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dba_objects
<span class="token keyword">where</span> owner  <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> username <span class="token keyword">from</span> exp_check<span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'INVALID'</span>
<span class="token operator">and</span> object_type <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'INDEX'</span><span class="token punctuation">,</span><span class="token string">'LOB'</span><span class="token punctuation">)</span> <span class="token keyword">group</span> <span class="token keyword">by</span> owner<span class="token punctuation">,</span>object_type <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span>



<span class="token comment">--Parameters that need to be modified for the partition table</span>
<span class="token comment">--Implied parameter of the initial size of the partition table that needs to be modified for 10g migration to 12C</span>
<span class="token comment">--alter system set "_partition_large_extents=flase";</span>
<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check  user partition'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> ksppinm<span class="token punctuation">,</span>ksppstvl<span class="token punctuation">,</span>ksppdesc <span class="token keyword">from</span> x$ksppi x<span class="token punctuation">,</span>x$ksppcv y <span class="token keyword">where</span> x<span class="token punctuation">.</span>indx<span class="token operator">=</span>y<span class="token punctuation">.</span>indx <span class="token operator">and</span> ksppinm <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'_partition_large_extents'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check db space'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span>
    df<span class="token punctuation">.</span>tablespace_name<span class="token punctuation">,</span> 
    <span class="token function">round</span><span class="token punctuation">(</span> df<span class="token punctuation">.</span>total_space <span class="token operator">/</span> <span class="token number">1048576</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token string">"Total Space(MB)"</span><span class="token punctuation">,</span> 
    <span class="token function">round</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> df<span class="token punctuation">.</span>total_space <span class="token operator">-</span> nvl<span class="token punctuation">(</span> fs<span class="token punctuation">.</span>free_space<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1048576</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token string">"Used Space(MB)"</span><span class="token punctuation">,</span> 
    <span class="token function">round</span><span class="token punctuation">(</span> nvl<span class="token punctuation">(</span> fs<span class="token punctuation">.</span>free_space<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1048576</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token string">"Free Space(MB)"</span><span class="token punctuation">,</span> 
    <span class="token function">round</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">-</span> nvl<span class="token punctuation">(</span> fs<span class="token punctuation">.</span>free_space<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">/</span> df<span class="token punctuation">.</span>total_space <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token string">"%Used"</span><span class="token punctuation">,</span> 
    to_char<span class="token punctuation">(</span> Sysdate<span class="token punctuation">,</span> <span class="token string">'yyyy-mm-dd hh24:mi'</span> <span class="token punctuation">)</span> Stat_Time
  <span class="token keyword">from</span>
    <span class="token punctuation">(</span> <span class="token keyword">select</span> tablespace_name<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span> bytes <span class="token punctuation">)</span> total_space <span class="token keyword">from</span> dba_data_files <span class="token keyword">group</span> <span class="token keyword">by</span> tablespace_name <span class="token punctuation">)</span> df<span class="token punctuation">,</span> 
    <span class="token punctuation">(</span> <span class="token keyword">select</span> b<span class="token punctuation">.</span>tablespace_name<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span> b<span class="token punctuation">.</span>bytes <span class="token punctuation">)</span> free_space <span class="token keyword">from</span> dba_free_space b <span class="token keyword">group</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>tablespace_name <span class="token punctuation">)</span> fs
  <span class="token keyword">where</span>
    df<span class="token punctuation">.</span>tablespace_name <span class="token operator">=</span> fs<span class="token punctuation">.</span>tablespace_name<span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span>
    <span class="token operator">and</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dba_tablespaces ts <span class="token keyword">where</span> ts<span class="token punctuation">.</span>contents <span class="token operator">&lt;></span> <span class="token string">'TEMPORARY'</span> <span class="token operator">and</span> ts<span class="token punctuation">.</span>tablespace_name <span class="token operator">=</span> df<span class="token punctuation">.</span>tablespace_name <span class="token punctuation">)</span>
<span class="token keyword">union</span>
<span class="token keyword">select</span>
    df<span class="token punctuation">.</span>tablespace_name<span class="token punctuation">,</span> 
    <span class="token function">round</span><span class="token punctuation">(</span> df<span class="token punctuation">.</span>total_space <span class="token operator">/</span> <span class="token number">1048576</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token string">"Total Space(MB)"</span><span class="token punctuation">,</span> 
    <span class="token function">round</span><span class="token punctuation">(</span> nvl<span class="token punctuation">(</span> us<span class="token punctuation">.</span>used_space<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1048576</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token string">"Used Space(MB)"</span><span class="token punctuation">,</span> 
    <span class="token function">round</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> df<span class="token punctuation">.</span>total_space <span class="token operator">-</span> nvl<span class="token punctuation">(</span> us<span class="token punctuation">.</span>used_space<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1048576</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token string">"Free Space(MB)"</span><span class="token punctuation">,</span> 
    <span class="token function">round</span><span class="token punctuation">(</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token punctuation">(</span> nvl<span class="token punctuation">(</span> us<span class="token punctuation">.</span>used_space<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">/</span> df<span class="token punctuation">.</span>total_space <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token string">"%Used"</span><span class="token punctuation">,</span> 
    to_char<span class="token punctuation">(</span> Sysdate<span class="token punctuation">,</span> <span class="token string">'yyyy-mm-dd hh24:mi'</span> <span class="token punctuation">)</span> Stat_Time
  <span class="token keyword">from</span>
    <span class="token punctuation">(</span> <span class="token keyword">select</span> tablespace_name<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span> bytes <span class="token punctuation">)</span> total_space <span class="token keyword">from</span> dba_temp_files <span class="token keyword">group</span> <span class="token keyword">by</span> tablespace_name <span class="token punctuation">)</span> df<span class="token punctuation">,</span> 
    <span class="token punctuation">(</span> <span class="token keyword">select</span> b<span class="token punctuation">.</span>tablespace_name<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span> b<span class="token punctuation">.</span>bytes_cached <span class="token punctuation">)</span> used_space <span class="token keyword">from</span> v$temp_extent_pool b <span class="token keyword">group</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>tablespace_name <span class="token punctuation">)</span> us
  <span class="token keyword">where</span>
    df<span class="token punctuation">.</span>tablespace_name <span class="token operator">=</span> us<span class="token punctuation">.</span>tablespace_name<span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span>
    <span class="token operator">and</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dba_tablespaces ts <span class="token keyword">where</span> ts<span class="token punctuation">.</span>contents <span class="token operator">=</span> <span class="token string">'TEMPORARY'</span> <span class="token operator">and</span> ts<span class="token punctuation">.</span>tablespace_name <span class="token operator">=</span> df<span class="token punctuation">.</span>tablespace_name <span class="token punctuation">)</span>
  <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">5</span> <span class="token keyword">desc</span><span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check datafile'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> f<span class="token punctuation">.</span>file_id<span class="token punctuation">,</span> f<span class="token punctuation">.</span>file_name<span class="token punctuation">,</span> f<span class="token punctuation">.</span>tablespace_name<span class="token punctuation">,</span> 
  <span class="token function">round</span><span class="token punctuation">(</span> bytes<span class="token operator">/</span><span class="token number">1048576</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span> size_mb<span class="token punctuation">,</span> 
  <span class="token function">round</span><span class="token punctuation">(</span> maxbytes<span class="token operator">/</span><span class="token number">1048576</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span> max_mb<span class="token punctuation">,</span>
  f<span class="token punctuation">.</span>autoextensible 
<span class="token keyword">from</span> dba_data_files f
<span class="token keyword">union</span>
<span class="token keyword">select</span> f<span class="token punctuation">.</span>file_id<span class="token punctuation">,</span> f<span class="token punctuation">.</span>file_name<span class="token punctuation">,</span> f<span class="token punctuation">.</span>tablespace_name<span class="token punctuation">,</span> 
  <span class="token function">round</span><span class="token punctuation">(</span> bytes<span class="token operator">/</span><span class="token number">1048576</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span> size_mb<span class="token punctuation">,</span> 
  <span class="token function">round</span><span class="token punctuation">(</span> maxbytes<span class="token operator">/</span><span class="token number">1048576</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span> max_mb<span class="token punctuation">,</span>
  f<span class="token punctuation">.</span>autoextensible 
<span class="token keyword">from</span> dba_temp_files f
<span class="token keyword">order</span> <span class="token keyword">by</span> tablespace_name<span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check temp space'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> f<span class="token punctuation">.</span>file_id<span class="token punctuation">,</span>f<span class="token punctuation">.</span>file_name<span class="token punctuation">,</span>f<span class="token punctuation">.</span>tablespace_name<span class="token punctuation">,</span><span class="token function">round</span><span class="token punctuation">(</span>bytes<span class="token operator">/</span><span class="token number">1048576</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> size_mb<span class="token punctuation">,</span><span class="token function">round</span><span class="token punctuation">(</span>maxbytes<span class="token operator">/</span><span class="token number">1048576</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> max_mb<span class="token punctuation">,</span>f<span class="token punctuation">.</span>autoextensible 
<span class="token keyword">from</span> dba_temp_files f
<span class="token keyword">order</span> <span class="token keyword">by</span> tablespace_name<span class="token punctuation">;</span>

<span class="token keyword">set</span> heading <span class="token keyword">off</span>
<span class="token keyword">set</span> feedback <span class="token keyword">off</span>
<span class="token keyword">select</span> <span class="token string">'##check dblink'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token keyword">set</span> heading <span class="token keyword">on</span>
<span class="token keyword">set</span> feedback <span class="token keyword">on</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dba_db_links<span class="token punctuation">;</span>

<span class="token comment">/*
##get create user ddl
set linesize 180    
set pages 999
set long 90000 
SELECT DBMS_METADATA.GET_DDL('USER','MMT') FROM DUAL;


##get create dblink ddl
set linesize 180    
set pages 999
set long 90000 
SELECT DBMS_METADATA.GET_DDL('DB_LINK', 'SYS_HUB','SYS') FROM DUAL;


##get create role ddl
if not oracle default role:   select * from dba_roles;
target need create role.

set linesize 180    
set pages 999
set long 90000 
SELECT DBMS_METADATA.GET_DDL('ROLE', 'TESTROLE') FROM DUAL;

select OWNER,TABLE_NAME,PRIVILEGE from role_tab_privs where role='TESTROLE';
select PRIVILEGE from role_sys_privs where role='TESTROLE';  
*/</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> exp_check<span class="token punctuation">;</span>
spool <span class="token keyword">off</span>
undefine username</pre></div></code-block></article><footer></footer></body></html>