<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>全表扫描第一版 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font less-lead"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="全表扫描第一版" class="main-title"></div></div></header><article><h1 id="amSjX19VrwqV3mTH6V22GH" class="wolai-block"><span class="inline-wrap">全表扫描</span></h1><div id="toZRbVPX7onSVUuQzLP3rZ" class="wolai-block wolai-text"><div><span class="inline-wrap">测试环境：Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production</span></div></div><h2 id="jqqbvxhKZxmq55xTjrjwZq" class="wolai-block"><span class="inline-wrap">概念</span></h2><div id="iBjdwEwqpkwEcWBq3EUZ4s" class="wolai-block wolai-text"><div><span class="inline-wrap">在执行计划中<span class="jill"></span>Operation<span class="jill"></span>列的“FULL TABLE SCAN”便是全表扫描。执行全表扫描时，服务器进程连续读取高水平线（high water mark）以下所有块。当一个表不断数据插入时高水平线不断提高，全表扫描中<span class="jill"></span>selete<span class="jill"></span>是以高水平线为终点。而当表中含有大量过空或者接近空的快时就会导致次优的性能。</span></div></div><h2 id="3dHhB8dDS3PQxDivRKogxf" class="wolai-block"><span class="inline-wrap">示例</span></h2><div id="uqFUuwGPx5BuWPUWxfJyck" class="wolai-block wolai-text"><div><span class="inline-wrap">示例：直接对表进行查询</span></div></div><code-block id="fF2aaC3KgrdA6qfJZtU6jb" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> id <span class="token keyword">from</span> idt<span class="token punctuation">;</span></pre></div></code-block><div id="a6ctVCrVqDevzEwasYvyTi" class="wolai-block wolai-text"><div><span class="inline-wrap">执行计划如下</span></div></div><code-block id="nD3EAfFt4n5SY9hFJyGsM7" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token comment">-- 将下列查询语句的执行计划写入到执行表并执行</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token comment">/*+ gather_plan_statistics */</span> id <span class="token keyword">from</span> idt<span class="token punctuation">;</span>

<span class="token comment">-- 显示上一条命令的在缓存库中执行计划的信息(执行计划表有省略)</span>
<span class="token comment">-- iostats 能够显示 Starts、E-Rows、A-Rows、A-Time、Buffers</span>
<span class="token comment">-- last 仅显示最后一次执行的统计信息</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span><span class="token punctuation">(</span>dbms_xplan<span class="token punctuation">.</span>display_cursor<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'iostats last'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">------------------------------------------------------------------------------------</span>
<span class="token operator">|</span> Id  <span class="token operator">|</span> Operation	        <span class="token operator">|</span> Name <span class="token operator">|</span> Starts <span class="token operator">|</span> E<span class="token operator">-</span><span class="token keyword">Rows</span> <span class="token operator">|</span> A<span class="token operator">-</span><span class="token keyword">Rows</span> <span class="token operator">|</span>	A<span class="token operator">-</span><span class="token keyword">Time</span>	   <span class="token operator">|</span> Buffers <span class="token operator">|</span>
<span class="token comment">------------------------------------------------------------------------------------</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">SELECT</span> STATEMENT  <span class="token operator">|</span>	     <span class="token operator">|</span>	<span class="token number">1</span>     <span class="token operator">|</span>	       <span class="token operator">|</span>	<span class="token number">100</span>K  <span class="token operator">|</span><span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00.04</span> <span class="token operator">|</span>    <span class="token number">6837</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>  <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span><span class="token operator">|</span> IDT  <span class="token operator">|</span>	<span class="token number">1</span>     <span class="token operator">|</span>	   <span class="token number">9</span>   <span class="token operator">|</span>	<span class="token number">100</span>K  <span class="token operator">|</span><span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00.04</span> <span class="token operator">|</span>    <span class="token number">6837</span> <span class="token operator">|</span>
</pre></div></code-block><div id="gjGWxMLgp2VWC1fRQNPjF2" class="wolai-block wolai-text"><div><span class="inline-wrap">在上图可得知①在执行期间通过逻辑读访问的块数量为</span><span class="inline-wrap"><b>6837</b></span><span class="inline-wrap">。</span></div></div><div id="dvZiKCSyhgUGVHUZvAByXd" class="wolai-block wolai-text"><div><span class="inline-wrap">高效执行<span class="jill"></span>SQL<span class="jill"></span>语句，目标就是最小化逻辑读。</span></div></div><h3 id="m9zA1wXKK96KATNMz9ddJV" class="wolai-block"><span class="inline-wrap">设置行预读</span></h3><div id="2xAobpNsRWwqxha4P43qTm" class="wolai-block wolai-text"><div><span class="inline-wrap">Q：什么是</span><span class="inline-wrap"><b>行预读</b></span><span class="inline-wrap">？</span></div></div><div id="b4smHNbJZWPNjfX5ErRFkd" class="wolai-block wolai-text"><div><span class="inline-wrap">A：当客户端从数据库取回数据是，一次取回多行的技术就是行预读。</span></div></div><blockquote id="18eLKZKou7YzkSmzXdWuMT" class="wolai-block"><span class="inline-wrap"><a href="https://docs.oracle.com/cd/B19306_01/server.102/b14357/ch8.htm"><span>官方文档</span></a></span><span class="inline-wrap">解释翻译如下：</span><span class="inline-wrap">
</span><span class="inline-wrap">设置<span class="jill"></span>SQL*Plus<span class="jill"></span>每次从数据库中获取的行数。取值范围为<span class="jill"></span>1 ~ 5000。</span><span class="inline-wrap">
</span><span class="inline-wrap">设置<span class="jill"></span>ARRAYSIZE<span class="jill"></span>的有效性取决于<span class="jill"></span>Oracle<span class="jill"></span>数据库如何填充网络数据包以及您的网络延迟和吞吐量。在<span class="jill"></span>SQL*Plus<span class="jill"></span>和<span class="jill"></span>Oracle<span class="jill"></span>数据库的最新版本中，ARRAYSIZE<span class="jill"></span>可能没有什么作用。过大的大小很容易占用更多的<span class="jill"></span>SQL*Plus<span class="jill"></span>内存，从而降低整体性能。</span></blockquote><code-block id="nhMqhnpxQwdCGJm2DeSgsi" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token comment">-- 默认行预读是15</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">show</span> arraysize
arraysize <span class="token number">15</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">set</span> arraysize <span class="token number">100</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token comment">/*+ gather_plan_statistics */</span> id <span class="token keyword">from</span> idt<span class="token punctuation">;</span>
<span class="token number">100009</span> <span class="token keyword">rows</span> selected<span class="token punctuation">.</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span><span class="token punctuation">(</span>dbms_xplan<span class="token punctuation">.</span>display_cursor<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'iostats last'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">------------------------------------------------------------------------------------</span>
<span class="token operator">|</span> Id  <span class="token operator">|</span> Operation	        <span class="token operator">|</span> Name <span class="token operator">|</span> Starts <span class="token operator">|</span> E<span class="token operator">-</span><span class="token keyword">Rows</span> <span class="token operator">|</span> A<span class="token operator">-</span><span class="token keyword">Rows</span> <span class="token operator">|</span>	A<span class="token operator">-</span><span class="token keyword">Time</span>	   <span class="token operator">|</span> Buffers <span class="token operator">|</span>
<span class="token comment">------------------------------------------------------------------------------------</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">SELECT</span> STATEMENT  <span class="token operator">|</span>   	 <span class="token operator">|</span>    <span class="token number">1</span>   <span class="token operator">|</span>	       <span class="token operator">|</span>	<span class="token number">100</span>K  <span class="token operator">|</span><span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00.01</span> <span class="token operator">|</span>    <span class="token number">1170</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>  <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span><span class="token operator">|</span> IDT  <span class="token operator">|</span>	  <span class="token number">1</span>   <span class="token operator">|</span>	   <span class="token number">9</span>   <span class="token operator">|</span>	<span class="token number">100</span>K  <span class="token operator">|</span><span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00.01</span> <span class="token operator">|</span>    <span class="token number">1170</span> <span class="token operator">|</span>

<span class="token comment">-- 恢复默认</span>
<span class="token keyword">SQL</span><span class="token operator">></span><span class="token keyword">set</span> arraysize <span class="token number">15</span></pre></div></code-block><div id="t1G2YKGaEEW4J8z4qvNBcn" class="wolai-block wolai-text"><div><span class="inline-wrap">通过设置行预读缓存从</span><span class="inline-wrap"><b>6937</b></span><span class="inline-wrap">降低到</span><span class="inline-wrap"><b>1170</b></span></div></div><div id="o2KKH2oFyaMEwiQmSiY94P" class="wolai-block wolai-text"><div><span class="inline-wrap">总结：全表扫描执行的逻辑非常依赖于行预取的设置</span></div></div><h3 id="xycRW1s4crjroRHyNNgXiu" class="wolai-block"><span class="inline-wrap">降低高水平线（当表存储在自动段管理空间时）</span></h3><div id="7N6oBpFB9CwvtcFmzkSCqs" class="wolai-block wolai-text"><div><span class="inline-wrap">场景：DELETE<span class="jill"></span>量大于<span class="jill"></span>INSERT<span class="jill"></span>时</span></div></div><code-block id="6G4stwqAuZuqyUXSjMhzBb" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">delete</span> idt <span class="token keyword">where</span> id <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token number">99990</span> <span class="token keyword">rows</span> deleted<span class="token punctuation">.</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token comment">/*+ gather_plan_statistics */</span> id <span class="token keyword">from</span> idt<span class="token punctuation">;</span>
<span class="token number">19</span> <span class="token keyword">rows</span> selected<span class="token punctuation">.</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span><span class="token punctuation">(</span>dbms_xplan<span class="token punctuation">.</span>display_cursor<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'iostats last'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">------------------------------------------------------------------------------------</span>
<span class="token operator">|</span> Id  <span class="token operator">|</span> Operation	         <span class="token operator">|</span> Name <span class="token operator">|</span> Starts <span class="token operator">|</span> E<span class="token operator">-</span><span class="token keyword">Rows</span> <span class="token operator">|</span> A<span class="token operator">-</span><span class="token keyword">Rows</span> <span class="token operator">|</span>	A<span class="token operator">-</span><span class="token keyword">Time</span>	 <span class="token operator">|</span> Buffers <span class="token operator">|</span>
<span class="token comment">------------------------------------------------------------------------------------</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">SELECT</span> STATEMENT  <span class="token operator">|</span>	     <span class="token operator">|</span>	<span class="token number">1</span>      <span class="token operator">|</span>	      <span class="token operator">|</span>	 <span class="token number">19</span>    <span class="token operator">|</span><span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00.01</span> <span class="token operator">|</span>    <span class="token number">170</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>  <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span><span class="token operator">|</span> IDT  <span class="token operator">|</span>	<span class="token number">1</span>      <span class="token operator">|</span>	  <span class="token number">9</span>   <span class="token operator">|</span>	 <span class="token number">19</span>    <span class="token operator">|</span><span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00.01</span> <span class="token operator">|</span>    <span class="token number">170</span> <span class="token operator">|</span>

</pre></div></code-block><div id="ggAihwrQdhwVT926wmrCNv" class="wolai-block wolai-text"><div><span class="inline-wrap">此时即使全表扫描只返回只有<span class="jill"></span>19<span class="jill"></span>条，逻辑读依然特别高，相当于每返回<span class="jill"></span>1<span class="jill"></span>条就要进行<span class="jill"></span>10<span class="jill"></span>次逻辑读。</span></div></div><code-block id="nPtRGKFqgssSszf44uNPQW" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token comment">-- 对idt表启动行迁移，默认关闭</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> idt <span class="token keyword">enable</span> <span class="token keyword">row</span> movement<span class="token punctuation">;</span>
<span class="token keyword">Table</span> altered<span class="token punctuation">.</span>
<span class="token comment">-- 重组物理表，降低高水平线（Hight water mark）</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> idt shrink space<span class="token punctuation">;</span>
<span class="token keyword">Table</span> altered<span class="token punctuation">.</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token comment">/*+ gather_plan_statistics */</span> id <span class="token keyword">from</span> idt<span class="token punctuation">;</span>
<span class="token number">19</span> <span class="token keyword">rows</span> selected<span class="token punctuation">.</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span><span class="token punctuation">(</span>dbms_xplan<span class="token punctuation">.</span>display_cursor<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'iostats last'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">---------------------------------------------------------------------------------------------</span>
<span class="token operator">|</span> Id  <span class="token operator">|</span> Operation	        <span class="token operator">|</span> Name <span class="token operator">|</span> Starts <span class="token operator">|</span> E<span class="token operator">-</span><span class="token keyword">Rows</span> <span class="token operator">|</span> A<span class="token operator">-</span><span class="token keyword">Rows</span> <span class="token operator">|</span>	A<span class="token operator">-</span><span class="token keyword">Time</span>	   <span class="token operator">|</span> Buffers <span class="token operator">|</span> <span class="token keyword">Reads</span>  <span class="token operator">|</span>
<span class="token comment">---------------------------------------------------------------------------------------------</span>
<span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">SELECT</span> STATEMENT  <span class="token operator">|</span>	     <span class="token operator">|</span>	<span class="token number">1</span>     <span class="token operator">|</span>	       <span class="token operator">|</span>	 <span class="token number">19</span>   <span class="token operator">|</span><span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00.01</span> <span class="token operator">|</span>	 <span class="token number">3</span>     <span class="token operator">|</span>	  <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span>  <span class="token keyword">TABLE</span> ACCESS <span class="token keyword">FULL</span><span class="token operator">|</span> IDT  <span class="token operator">|</span>	<span class="token number">1</span>     <span class="token operator">|</span>	   <span class="token number">9</span>   <span class="token operator">|</span>	 <span class="token number">19</span>   <span class="token operator">|</span><span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00.01</span> <span class="token operator">|</span>	 <span class="token number">3</span>     <span class="token operator">|</span>	  <span class="token number">1</span> <span class="token operator">|</span></pre></div></code-block><div id="wFtgEnpBiiD1naEGDWTvhd" class="wolai-block wolai-text"><div><span class="inline-wrap">此时逻辑读的块量仅为<span class="jill"></span>3</span></div></div><div id="kPGX8hYdjy72xdArNZQYRo" class="wolai-block wolai-text"><div><span class="inline-wrap">总结：当表含有大量空时会导致次优的性能，需要降低<span class="jill"></span>HWM<span class="jill"></span>值，进行重组表</span></div></div></article><footer></footer></body></html>