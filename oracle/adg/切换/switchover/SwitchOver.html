<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>SwitchOver - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font less-lead"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="SwitchOver" class="main-title"></div></div></header><article><h2 id="gXcpztWZN8KSeRkbsUXNUJ" class="wolai-block"><span class="inline-wrap">状态确定</span></h2><div id="ucYXE2QSEttvF9UcsPEAiT" class="wolai-block wolai-text"><div><span class="inline-wrap">主备库状态<span class="jill"></span>open<span class="jill"></span>和归档模式</span></div></div><code-block id="mR9bb6pnfxvDtsLmbJeJ1u" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token constant">SQL</span><span class="token operator">></span> select open_mode<span class="token punctuation">,</span>log_mode <span class="token keyword module">from</span> v$database<span class="token punctuation">;</span>

<span class="token constant">OPEN_MODE</span>	     <span class="token constant">LOG_MODE</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token constant">READ</span> <span class="token constant">WRITE</span>	     <span class="token constant">ARCHIVELOG</span></pre></div></code-block><div id="rBwmUq2BfeFbS4kpLMrAC7" class="wolai-block wolai-text"><div><span class="inline-wrap">主库角色为<span class="jill"></span>primery</span></div></div><code-block id="muf97GU3HmD4UkMhw1EWAn" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> database_role <span class="token keyword">from</span> v$<span class="token keyword">database</span><span class="token punctuation">;</span>

DATABASE_ROLE
<span class="token comment">----------------</span>
<span class="token keyword">PRIMARY</span></pre></div></code-block><div id="919ZY9d3WrUXKmMToqPhXd" class="wolai-block wolai-text"><div><span class="inline-wrap">涉及参数</span></div></div><code-block id="unzJAFAPFc5paLkRZyMAgi" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">show</span> parameter db_file_name_convert
<span class="token keyword">show</span> parameter log_file_name_convert
<span class="token keyword">show</span> parameter standby_file_management
<span class="token keyword">show</span> parameter fal_server
<span class="token keyword">show</span> parameter log_archive_config
<span class="token keyword">show</span> parameter log_archive_dest_2
<span class="token keyword">show</span> parameter log_archive_dest_2_state</pre></div></code-block><div id="qGibA1JLT6W69P5jX57Axe" class="wolai-block wolai-text"><div><span class="inline-wrap">确定主库归档状态，下方实例为正常状态为</span></div></div><code-block id="jnCT5KYbZ3eUFpRVsigRTB" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> DEST_NAME<span class="token punctuation">,</span><span class="token keyword">STATUS</span><span class="token punctuation">,</span>RECOVERY_MODE <span class="token keyword">from</span> V$ARCHIVE_DEST_STATUS <span class="token keyword">where</span> DEST_NAME<span class="token operator">=</span><span class="token string">'LOG_ARCHIVE_DEST_2'</span><span class="token punctuation">;</span>

DEST_NAME
<span class="token comment">--------------------------------------------------------------------------------</span>
<span class="token keyword">STATUS</span>	  RECOVERY_MODE
<span class="token comment">--------- -----------------------</span>
LOG_ARCHIVE_DEST_2
VALID	  MANAGED <span class="token keyword">REAL</span> <span class="token keyword">TIME</span> <span class="token keyword">APPLY</span></pre></div></code-block><div id="d4DMgeSuLGEw6dZRJbusF3" class="wolai-block wolai-text"><div><span class="inline-wrap">主库确定备用重做日志是否存在,如没有，需要添加，大小以及文件数量参考备库</span></div></div><code-block id="mcrB5DRwTzg6MAuPZrvCXH" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token constant">SQL</span><span class="token operator">></span> select group#<span class="token punctuation">,</span><span class="token constant">STATUS</span><span class="token punctuation">,</span><span class="token constant">ARCHIVED</span> <span class="token keyword module">from</span> v$standby_log<span class="token punctuation">;</span>
alter database add standby logfile thread <span class="token number">1</span> group <span class="token number">1</span><span class="token punctuation">(</span><span class="token string">'/u01/app/oracle/oradata/redo1.log'</span><span class="token punctuation">)</span> size 200M<span class="token punctuation">;</span>
alter database add standby logfile thread <span class="token number">1</span> group <span class="token number">2</span><span class="token punctuation">(</span><span class="token string">'/u01/app/oracle/oradata/redo2.log'</span><span class="token punctuation">)</span> size 200M<span class="token punctuation">;</span> 
alter database add standby logfile thread <span class="token number">1</span> group <span class="token number">3</span><span class="token punctuation">(</span><span class="token string">'/u01/app/oracle/oradata/redo3.log'</span><span class="token punctuation">)</span> size 200M<span class="token punctuation">;</span> </pre></div></code-block><div id="mEyc6RbVVSYwKGzKFMsyPo" class="wolai-block wolai-text"><div><span class="inline-wrap">查看主备库匹配<span class="jill"></span>sequence<span class="jill"></span>是否统一</span></div></div><code-block id="cz4EHDbEGEqdmEssZg9ASV" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>select <span class="token function">max</span><span class="token punctuation">(</span>sequence#<span class="token punctuation">)</span> <span class="token keyword module">from</span> v$archived_log<span class="token punctuation">;</span>
select pid<span class="token punctuation">,</span>process<span class="token punctuation">,</span>status<span class="token punctuation">,</span>sequence# <span class="token keyword module">from</span> v$managed_standby<span class="token punctuation">;</span></pre></div></code-block><div id="ghD3xRz1XnZ1ztxrjqS1UQ" class="wolai-block wolai-text"><div><span class="inline-wrap">查看备库是否有<span class="jill"></span>Archive gap，如有，需要先处理</span></div></div><code-block id="gBfqGhAwCWw1EsnHDzbQ8V" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token keyword">select</span> * from V<span class="token variable">$ARCHIVE_GAP</span><span class="token punctuation">;</span></pre></div></code-block><div id="tYDp5LNj8t1e1MKzHUayVh" class="wolai-block wolai-text"><div><span class="inline-wrap">关闭会话</span></div></div><code-block id="uxWgZAuBy6hNrvXB7dCjpg" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token comment">-- 查看</span>
<span class="token keyword">select</span> username<span class="token punctuation">,</span>sid<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>event<span class="token punctuation">,</span>program<span class="token punctuation">,</span>machine<span class="token punctuation">,</span>sql_id <span class="token keyword">from</span> v$<span class="token keyword">session</span> <span class="token keyword">where</span> username <span class="token operator">!=</span><span class="token string">'SYS'</span><span class="token punctuation">;</span></pre></div></code-block><div id="pPBwvya5gd6RG9ithX4S8G" class="wolai-block wolai-text"><div><span class="inline-wrap">修改<span class="jill"></span>log_archive_dest_2</span></div></div><code-block id="wFsEwSHs5Yv4KV66SsjgKP" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token comment">-- col VALUE_COL_PLUS_SHOW_PARAM for a100</span>
<span class="token comment">-- show parameter log_archive_dest_2</span>
<span class="token keyword">alter</span> system <span class="token keyword">set</span> log_archive_dest_2<span class="token operator">=</span><span class="token string">'service=tns_ora_src lgwr sync affirm valid_for=(online_logfiles,primary_role) db_unique_name=ora_src'</span>
<span class="token keyword">select</span> dest_name<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>error <span class="token keyword">from</span> v$archive_dest <span class="token keyword">where</span> <span class="token keyword">STATUS</span><span class="token operator">=</span><span class="token string">'VALID'</span><span class="token punctuation">;</span></pre></div></code-block><div id="6r7zUYzXFxAdz8ATUC3HAA" class="wolai-block wolai-text"><div><span class="inline-wrap">修改<span class="jill"></span>fal_server</span></div></div><code-block id="k4Cj2qxDSZshQKGiSdoUEL" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> system <span class="token keyword">set</span> fal_server<span class="token operator">=</span><span class="token string">'tns_ora_dst'</span> scope<span class="token operator">=</span>both<span class="token punctuation">;</span></pre></div></code-block><h2 id="tRAtT4ezuh4J6EU2qWrpai" class="wolai-block"><span class="inline-wrap">进行切换</span></h2><div id="kxwjtKap3atsyre58tVQWL" class="wolai-block wolai-text"><div><span class="inline-wrap">查看是否能切换角色</span></div></div><code-block id="uTtE2GSvZ6N82KLBuCjZ6E" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">SELECT</span> SWITCHOVER_STATUS <span class="token keyword">FROM</span> V$<span class="token keyword">DATABASE</span><span class="token punctuation">;</span></pre></div></code-block><div id="hqyM55fHauyHEjLj85Eeb1" class="wolai-block wolai-text"><div><span class="inline-wrap">主切备</span></div></div><code-block id="83gfeL8hk7p5LAqd9d6BbJ" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token comment">--  ALTER DATABASE COMMIT TO SWITCHOVER TO PHYSICAL STANDBY;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> <span class="token keyword">COMMIT</span> <span class="token keyword">TO</span> SWITCHOVER <span class="token keyword">TO</span> PHYSICAL STANDBY <span class="token keyword">WITH</span> <span class="token keyword">SESSION</span> <span class="token keyword">SHUTDOWN</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> startup nomount<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">database</span> mount standby <span class="token keyword">database</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">open</span> <span class="token keyword">read</span> only<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">database</span> recover managed standby <span class="token keyword">database</span> <span class="token keyword">using</span> <span class="token keyword">current</span> logfile disconnect <span class="token keyword">from</span> <span class="token keyword">session</span><span class="token punctuation">;</span>
<span class="token comment">-- alter database recover managed standby database cancel;</span></pre></div></code-block><div id="hq9e4pBQaTACfXEukfetiY" class="wolai-block wolai-text"><div><span class="inline-wrap">备切主</span></div></div><code-block id="9UyF6PmWhbguXqiVh7Vhiy" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> <span class="token keyword">COMMIT</span> <span class="token keyword">TO</span> SWITCHOVER <span class="token keyword">TO</span> <span class="token keyword">primary</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token keyword">status</span> <span class="token keyword">from</span> v$instance<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">database</span> <span class="token keyword">open</span><span class="token punctuation">;</span></pre></div></code-block></article><footer></footer></body></html>