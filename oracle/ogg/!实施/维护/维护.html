<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>维护 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font less-lead"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="维护" class="main-title"></div></div></header><article><h1 id="o6UktLfuFTHoXK8uCwCvyN" class="wolai-block"><span class="inline-wrap">配置自动删除<span class="jill"></span>Trail</span></h1><div id="2YYRUMPZpk6uiSURkY6Vhm" class="wolai-block wolai-text"><div><span class="inline-wrap">配置<span class="jill"></span>purgeoldextracts<span class="jill"></span>参数</span></div></div><code-block id="9Bv8V899NbcjepoingRad3" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token comment"># 修改purgeoldextracts参数</span>
GGSCI<span class="token operator">></span> edit param mgr
purgeoldextracts /u01/app/ogg/dirdat, usecheckpoints, minkeepdays <span class="token number">7</span>

<span class="token comment"># /u01/app/ogg/dirdat 参数表示为Trail文件夹路径</span>
<span class="token comment"># usecheckpoints 参数表示首先要保证满足检查点需要，不能删除未处理队列</span>
<span class="token comment"># minkeepdays 参数表示最小保留7天</span>
<span class="token comment"># 如果logdump开着，则无法删除</span></pre></div></code-block><div id="vmFaupv6c61BW6f6fPAzmH" class="wolai-block wolai-text"><div><span class="inline-wrap">重启<span class="jill"></span>mgr</span></div></div><code-block id="pK9fS6QrgsQ4f14bxDp84w" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">GGSCI<span class="token operator">></span> stop mgr
GGSCI<span class="token operator">></span> start mgr</pre></div></code-block><h1 id="uJnHfLkHw8ABVDu5dTHdJ3" class="wolai-block"><span class="inline-wrap">配置<span class="jill"></span>Trail<span class="jill"></span>文件大小</span></h1><div id="8FQwojBkqPYUwkh5aRiTaV" class="wolai-block wolai-text"><div><span class="inline-wrap">关闭<span class="jill"></span>EXTRACT</span></div></div><code-block id="7JgYEbuDAoWzKLJxtzsQqY" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token constant">GGSCI</span><span class="token operator">></span> stop <span class="token constant">EORA_1</span></pre></div></code-block><div id="4ai4hnzTSJ3AGam3oq3AwU" class="wolai-block wolai-text"><div><span class="inline-wrap">修改为<span class="jill"></span>100M<span class="jill"></span>大小</span></div></div><code-block id="pBEVVUZhnkazxG1wzrQzFC" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token constant">GGSCI</span><span class="token operator">></span> alter <span class="token constant">EXTTRAIL</span> <span class="token operator">/</span>u01<span class="token operator">/</span>app<span class="token operator">/</span>ogg<span class="token operator">/</span>dirdat<span class="token operator">/</span>aa extract <span class="token constant">EORA_1</span> megabytes <span class="token number">100</span></pre></div></code-block><div id="5zKj4RVzqNsXrAYyCtZBMJ" class="wolai-block wolai-text"><div><span class="inline-wrap">启动<span class="jill"></span>EXTRACT</span></div></div><code-block id="uqkeWcRHw5h7qgcV6rECP4" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token constant">GGSCI</span><span class="token operator">></span> start eora_1</pre></div></code-block><h1 id="jiy5UB1G2FvQBaPgmPNMsQ" class="wolai-block"><span class="inline-wrap">配置自动重启<span class="jill"></span>Extract<span class="jill"></span>和<span class="jill"></span>Replicat<span class="jill"></span>进程</span></h1><div id="cnspHRb79wbRN2cmCZfCB9" class="wolai-block wolai-text"><div><span class="inline-wrap">配置<span class="jill"></span>AUTORESTART<span class="jill"></span>参数</span></div></div><code-block id="udy4AZMA6FEUPV5Nftsaoe" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">GGSCI <span class="token punctuation">(</span>ogg1<span class="token punctuation">)</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span> edit param mgr
AUTORESTART EXTRACT *,RETRIES <span class="token number">5</span>,WAITMINUTES <span class="token number">3</span>, RESETMINUTES <span class="token number">60</span>
<span class="token comment">#AUTORESTART REPLICAT *,RETRIES 5,WAITMINUTES 3, RESETMINUTES 60</span>

<span class="token comment"># RETRIES 参数表示尝试5次</span>
<span class="token comment"># WAITMINUTES 参数表示每3分钟尝试</span>
<span class="token comment"># RESETMINUTES 参数表示开始新尝试</span></pre></div></code-block><div id="6oiUnUQYP9sRWfPhbkQtR8" class="wolai-block wolai-text"><div><span class="inline-wrap">重启<span class="jill"></span>mgr</span></div></div><code-block id="dv3DKY2jnV3NtvD9pcJxLB" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">GGSCI<span class="token operator">></span> stop mgr
GGSCI<span class="token operator">></span> start mgr</pre></div></code-block><h1 id="nGmoWJqvd6AA9vabFYHgiK" class="wolai-block"><span class="inline-wrap">配置新增表</span></h1><ol class="wolai-block"><li id="pYpGChFEqmkqW5w2dRjX6k"><div class="marker"></div><span class="inline-wrap">源系统执行</span></li></ol><code-block id="cASQmYuU3pB4TnEtMoWfjz" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">GGSCI<span class="token operator">></span> <span class="token function">add</span> trandata SCHEMA.TABLE</pre></div></code-block><div id="u3wX6ZpkSUdJMUN2BWK2hw" class="wolai-block wolai-text"><div><span class="inline-wrap">注：如果配置文件指定了通配符，跳过配置该表步骤</span></div></div><ol class="wolai-block"><li id="8tnsVDcS4Zxf1YCH29xRoq"><div class="marker"></div><span class="inline-wrap">Extract、Data Pump<span class="jill"></span>里面最后的<span class="jill"></span>table<span class="jill"></span>列表里加入新的复制表</span></li><li id="xmWfaey3p9TFQiymqDQpwJ"><div class="marker"></div><span class="inline-wrap">在目标端<span class="jill"></span>replicat<span class="jill"></span>的配置中加入该表的映射，并在目标数据库中建立表结构</span></li><li id="qimDs63qa4mnUQ9X17p5Ro"><div class="marker"></div><span class="inline-wrap">如果有外键和触发器，需要在目标系统禁用</span></li><li id="4bJMK9RCCo7uX9HLbtE5is"><div class="marker"></div><span class="inline-wrap">重启进程(Extract、Data Pump、Replicat)</span></li></ol><h1 id="qRrvRqNJ8rWS2T5KN8ozUB" class="wolai-block"><span class="inline-wrap">配置去除表</span></h1><div id="x1TSWDp7ZmEkLaas8XfpEi" class="wolai-block wolai-text"><div><span class="inline-wrap">注：如果配置文件指定了通配符，源端<span class="jill"></span>drop<span class="jill"></span>后，目标端<span class="jill"></span>drop<span class="jill"></span>即可</span></div></div><ol class="wolai-block"><li id="5T5i3cVSL6yo4z6yQc9hGf"><div class="marker"></div><span class="inline-wrap">源端系统：停止<span class="jill"></span>Extract<span class="jill"></span>进程（请勿清理归档日志、检查长事务）</span></li><li id="uKHA148GkrTYoE6V3z1TWX"><div class="marker"></div><span class="inline-wrap">目标端系统：停止<span class="jill"></span>Replicat<span class="jill"></span>进程</span></li><li id="hDu3EZwMmLeRhx4QQUCiue"><div class="marker"></div><span class="inline-wrap">在源端系统修改参数文件排除所不复制的表:</span></li></ol><code-block id="ugk4JHgsMkMQuA3m1Ufg1k" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token comment"># 写法1</span>
ggsci<span class="token operator">></span> edit param EORA_1
-- table orcl.xx1<span class="token punctuation">;</span>
-- table orcl.xx2<span class="token punctuation">;</span>
<span class="token comment"># 写法2</span>
ggsci<span class="token operator">></span> edit param EORA_1
tableexclude orcl.xx1<span class="token punctuation">;</span>
tableexclude orcl.xx2<span class="token punctuation">;</span>
table orcl.*<span class="token punctuation">;</span></pre></div></code-block><ol class="wolai-block"><li id="uaV5eS3ov94jhkMhgpJ14B"><div class="marker"></div><span class="inline-wrap">在目标端系统修改<span class="jill"></span>Replicat<span class="jill"></span>配置文件中排除该表:</span></li></ol><code-block id="17Z1oGZchp7nPT3k9Y3b8v" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token comment"># 写法1</span>
GGSCI<span class="token operator">></span> edit param RORA_1
-- mapexclude orcl.xx1 TARGET orcl.xx1
-- mapexclude orcl.xx2 TARGET orcl.xx2
<span class="token comment"># 写法2</span>
GGSCI<span class="token operator">></span> edit param RORA_1
mapexclude orcl.xx1
mapexclude orcl.xx2
MAP orcl.* ,TARGET orcl.*<span class="token punctuation">;</span></pre></div></code-block><ol class="wolai-block"><li id="tpS9wQoYcFR386wDdNJx6h"><div class="marker"></div><span class="inline-wrap">在目标端系统上启动复制进程</span></li><li id="ashWXhxou9r4SxgQLgQtzU"><div class="marker"></div><span class="inline-wrap">在源端系统上启动源端的抓取进程</span></li></ol><h1 id="7PPPLYEGD3zjKsCCc862yj" class="wolai-block"><span class="inline-wrap">配置修改表结构</span></h1><ol class="wolai-block"><li id="cNoPp5pZLfrphPiiGKPaS1"><div class="marker"></div><span class="inline-wrap">停止源的<span class="jill"></span>Extract<span class="jill"></span>进程和目标端的<span class="jill"></span>Replicat<span class="jill"></span>进程（注意归档日志存在、检查长事务）</span></li><li id="h8VQPuRQBzfn4EvPZci9GT"><div class="marker"></div><span class="inline-wrap">修改目标表结构</span></li><li id="eofHkVaYYd1vePsTHML8um"><div class="marker"></div><span class="inline-wrap">修改源表结构</span></li><li id="xf57RdxcyxLhhYyqAsDFEp"><div class="marker"></div><span class="inline-wrap">表无主键或者修改了主键，需要执行下列步骤，否则跳过</span></li></ol><code-block id="pJPYCcwFG8rZaMZu1D2usE" class="wolai-block"><div class="wolai-pre"><div data-lang="Javascript" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">ggsci<span class="token operator">></span> dblogin userid ogg<span class="token punctuation">,</span> password ogg
ggsci<span class="token operator">></span> <span class="token keyword">delete</span> trandata schema<span class="token punctuation">.</span><span class="token property-access">mytable</span>
ggsci<span class="token operator">></span> add  trandata schema<span class="token punctuation">.</span><span class="token property-access">mytable</span></pre></div></code-block><ol class="wolai-block"><li id="mXa18xHX6pAiWXeXbvxroe"><div class="marker"></div><span class="inline-wrap">重新启动源端和目标端的抓取和复制进程。</span></li></ol><h1 id="rocyaatWx2vq7KWZjimqjS" class="wolai-block"><span class="inline-wrap">配置延迟告警</span></h1><code-block id="8gDJuc1SNVxpvXLAX4HAPt" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">GGSCI<span class="token operator">></span> edit param EORA_1
LAGREPORTHOURS <span class="token number">1</span>
LAGINFOMINUTES <span class="token number">30</span>
LAGCRITICALMINUTES <span class="token number">45</span>

<span class="token comment"># LAGREPORTHOURS 参数表示每隔1小时检查EXTRACT的延迟情况</span>
<span class="token comment"># LAGINFOMINUTES 参数表示如果超过了30分钟就把延迟作为信息记录到错误日志中</span>
<span class="token comment"># LAGCRITICALMINUTES 参数表示如果延迟超过了45分钟，则把它作为警告写到错误日志中。</span></pre></div></code-block><div id="9UbQXqtepPyb6s3sf2aeiG" class="wolai-block wolai-text"><div><span class="inline-wrap">重启<span class="jill"></span>mgr</span></div></div><code-block id="9NkNunrZVjhLxkKZ1dTHEa" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token constant">GGSCI</span><span class="token operator">></span> stop mgr
<span class="token constant">GGSCI</span><span class="token operator">></span> start mgr</pre></div></code-block><h1 id="4PtbeNCVLeCua8KunSMoJs" class="wolai-block"><span class="inline-wrap">配置长事务告警</span></h1><div id="fpSMwLckz9TVgn5QUMQt8j" class="wolai-block wolai-text"><div><span class="inline-wrap">配置<span class="jill"></span>warnlongtrans<span class="jill"></span>参数</span></div></div><code-block id="oXr23gxnnj1opCEA5SFc5b" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">GGSCI<span class="token operator">></span> edit param EORA_1
warnlongtrans 12h, checkintervals 10m
<span class="token comment"># checkintervals 参数表示会每隔10分钟检查一下长交易</span>
<span class="token comment"># warnlongtrans 参数超过12个小时的长交易（ogg 11g默认4小时）</span>
<span class="token comment"># 如果有，将在ggserr.log里面加入一条告警信息</span></pre></div></code-block><div id="uuRPX2oGrNJ75CLTDiUp1i" class="wolai-block wolai-text"><div><span class="inline-wrap">重启<span class="jill"></span>Extract</span></div></div><code-block id="xpGHC2HioCLf1kwVUKQQf3" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">GGSCI<span class="token operator">></span> stop EORA_1
GGSCI<span class="token operator">></span> start EORA_1</pre></div></code-block><h1 id="5UueYKCmvESrMJ9Gv2fcpC" class="wolai-block"><span class="inline-wrap">配置表重新同步（业务不停止）</span></h1><ol class="wolai-block"><li id="hGDnFjiinXmrHaYHGDFtNp"><div class="marker"></div><span class="inline-wrap">确认<span class="jill"></span>ext/dpe/rep<span class="jill"></span>进程均无较大延迟，否则等待追平再执行操作</span></li><li id="jSRKid48YEtJU9MwSVcuPW"><div class="marker"></div><span class="inline-wrap">停止目标端的<span class="jill"></span>rep<span class="jill"></span>进程</span></li></ol><div id="rqXfbhfXCZda9DVJSiEnsT" class="wolai-block wolai-text"><div><span class="inline-wrap">注意：步骤<span class="jill"></span>3-5<span class="jill"></span>为将源端数据通过<span class="jill"></span>exp/imp<span class="jill"></span>导入到目标端，客户也可以选择其它初始化方式，比如<span class="jill"></span>expdp/impdp。</span></div></div><ol class="wolai-block"><li id="3EgCHR84k8tYXA29dD2wAL"><div class="marker"></div><span class="inline-wrap">在源端获得当前的<span class="jill"></span>scn<span class="jill"></span>号(以<span class="jill"></span>scn<span class="jill"></span>号为<span class="jill"></span>1176681<span class="jill"></span>为例)。例如：</span></li></ol><code-block id="k6bqRSGQb5m6wBXSSndypy" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">select</span> dbms_flashback<span class="token punctuation">.</span>get_system_change_number <span class="token keyword">from</span> dual<span class="token punctuation">;</span></pre></div></code-block><ol class="wolai-block"><li id="f8qpi9LtANXyMmaVvNQMmh"><div class="marker"></div><span class="inline-wrap">在源端导出所需重新初始化的表或者几张表数据，并且指定到刚才记下的<span class="jill"></span>scn<span class="jill"></span>号。例如：</span></li></ol><code-block id="tapsGv8CiAMtucZpQqiJbM" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">exp / <span class="token assign-left variable">tables</span><span class="token operator">=</span>SCHEMA.TABLES <span class="token assign-left variable">grants</span><span class="token operator">=</span>n <span class="token assign-left variable">statistics</span><span class="token operator">=</span>none <span class="token assign-left variable">triggers</span><span class="token operator">=</span>n <span class="token assign-left variable">compress</span><span class="token operator">=</span>n <span class="token assign-left variable">FLASHBACK_SCN</span><span class="token operator">=</span><span class="token number">1176681</span>
expdp <span class="token punctuation">\</span>"/as sysdba <span class="token punctuation">\</span>" <span class="token assign-left variable">dumpfile</span><span class="token operator">=</span>expdat_%U.dmp <span class="token assign-left variable">directory</span><span class="token operator">=</span>ogg_dump <span class="token assign-left variable">tables</span><span class="token operator">=</span>XX <span class="token assign-left variable">FLASHBACK_SCN</span><span class="token operator">=</span><span class="token number">1176681</span> <span class="token assign-left variable">FILESIZE</span><span class="token operator">=</span>10240m <span class="token assign-left variable">logfile</span><span class="token operator">=</span> expdat_exp.log</pre></div></code-block><ol class="wolai-block"><li id="e3M6FJnN5z6extceyWPeYx"><div class="marker"></div><span class="inline-wrap">将<span class="jill"></span>dump<span class="jill"></span>传输到目标端；</span></li><li id="bWNhcB3psHEKKgyW2N4QLn"><div class="marker"></div><span class="inline-wrap">在目标端，导入数据；</span></li></ol><code-block id="oMX2Carg2zfp1B2FL1FS1j" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token function">nohup</span> imp ogg/ogg <span class="token assign-left variable">file</span><span class="token operator">=</span>nanhai.dmp <span class="token assign-left variable">fromuser</span><span class="token operator">=</span>xxx <span class="token assign-left variable">touser</span><span class="token operator">=</span>xxx <span class="token assign-left variable">ignore</span><span class="token operator">=</span>y <span class="token operator">&amp;</span>
impdp <span class="token punctuation">\</span>"/as sysdba <span class="token punctuation">\</span>"  <span class="token assign-left variable">dumpfile</span><span class="token operator">=</span>expdat_%U.dmp <span class="token assign-left variable">directory</span><span class="token operator">=</span>ogg_dump  <span class="token assign-left variable">REMAP_SCHEMA</span><span class="token operator">=</span>source_schema:target_schema  <span class="token assign-left variable">logfile</span><span class="token operator">=</span>expdat_imp.log</pre></div></code-block><ol class="wolai-block"><li id="qH9pbQeiY4femYnhuQaJVH"><div class="marker"></div><span class="inline-wrap">如果这些表有外键，在目标端检查这些外键并禁止它们；</span></li><li id="4hYtWaqi2hjNwhLCCq8QAL"><div class="marker"></div><span class="inline-wrap">编辑目标端对应的<span class="jill"></span>Replicat<span class="jill"></span>参数文件，在其<span class="jill"></span>map<span class="jill"></span>里面加入一个过滤条件，只对这些重新初始化的表应用指定<span class="jill"></span>scn<span class="jill"></span>号之后的记录（一定要注意不要修改本次初始化之外的其它表，会造成数据丢失！）：</span></li></ol><code-block id="wgy7H1WigTZoTPd7wr2EcW" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">GGSCI<span class="token operator">></span> edit params RORA_1
map source.mytab, target target.mytab, filter <span class="token punctuation">(</span> @GETENV <span class="token punctuation">(</span><span class="token string">"TRANSACTION"</span>, <span class="token string">"CSN"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1176681</span> <span class="token punctuation">)</span> <span class="token punctuation">;</span></pre></div></code-block><ol class="wolai-block"><li id="oksCag9dhJbobRJ7FC2syK"><div class="marker"></div><span class="inline-wrap">确认参数无误后，启动目标端的<span class="jill"></span>rep<span class="jill"></span>进程；</span></li><li id="eUDp5ja26PcA6rwoRDwEex"><div class="marker"></div><span class="inline-wrap">使用<span class="jill"></span>info repxx<span class="jill"></span>或者<span class="jill"></span>lag repxx<span class="jill"></span>直到该进程追上，停止该进程去掉<span class="jill"></span>filter<span class="jill"></span>即可进入正常复制</span></li></ol><h1 id="25vgYa5LAsBKM15vZwgf93" class="wolai-block"><span class="inline-wrap">配置<span class="jill"></span>DDL<span class="jill"></span>支持</span></h1><div id="58GFqsPg3YzPD1erNxfh6V" class="wolai-block wolai-text"><div><span class="inline-wrap">源端执行：可选</span></div></div><div id="4cCZUabq1suJsiLXaRWPkt" class="wolai-block wolai-text"><div><span class="inline-wrap">OGG<span class="jill"></span>的<span class="jill"></span>DDL<span class="jill"></span>复制需要大量访问数据字典信息，通过数据库定期收集统计信息，提高性能</span></div></div><code-block id="9sLNRzqierum2HbxSpSMHW" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">sqlplus  <span class="token operator">/</span> <span class="token keyword">as</span> sysdba
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">session</span> <span class="token keyword">enable</span> parallel dml<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">execute</span> dbms_stats<span class="token punctuation">.</span>gather_schema_stats<span class="token punctuation">(</span><span class="token string">'ORCL'</span><span class="token punctuation">,</span><span class="token keyword">cascade</span><span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">execute</span> dbms_stats<span class="token punctuation">.</span>gather_schema_stats<span class="token punctuation">(</span><span class="token string">'SYS'</span><span class="token punctuation">,</span><span class="token keyword">cascade</span><span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">execute</span> dbms_stats<span class="token punctuation">.</span>gather_schema_stats<span class="token punctuation">(</span><span class="token string">'SYSTEM'</span><span class="token punctuation">,</span><span class="token keyword">cascade</span><span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block><ol class="wolai-block"><li id="tyEo1V7pYA2qhzTLGpZTTE"><div class="marker"></div><span class="inline-wrap">源和目标端库执行内容</span></li></ol><code-block id="quY7HFSwwvsuHa1vdFpE1D" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token comment">-- cd ogg安装目录</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token variable">@ddl_setup.sql</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">GRANT</span> GGS_GGSUSER_ROLE <span class="token keyword">TO</span> ogg<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token variable">@ddl_enable.sql</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token variable">@ddl_pin.sql</span> ogg<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">GRANT</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">ON</span> utl_file <span class="token keyword">TO</span> ogg<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">GRANT</span> <span class="token keyword">CONNECT</span> <span class="token keyword">TO</span> goldengate<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token keyword">GRANT</span> RESOURCE <span class="token keyword">TO</span> goldengate<span class="token punctuation">;</span>
<span class="token comment">-- cd $ORACHE_HOME</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token variable">@rdbms</span><span class="token operator">/</span>admin<span class="token operator">/</span>dbmspool<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">;</span>
<span class="token comment">-- ddl状态查看,其中包含DDL日志路径</span>
<span class="token keyword">SQL</span><span class="token operator">></span> <span class="token variable">@ddl_status.sql</span></pre></div></code-block><ol class="wolai-block"><li id="ik8FwoJh4wA3wME7L5CEa8"><div class="marker"></div><span class="inline-wrap">源端关闭回收站</span><code-block id="s4DJ9SpiLSPPhCEjyAU7jC" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">alter system <span class="token keyword">set</span> recyclebin<span class="token operator">=</span>off</pre></div></code-block></li><li id="98Ro8riCxL75dp43S86VN7"><div class="marker"></div><span class="inline-wrap">源端<span class="jill"></span>Extract<span class="jill"></span>进程加入以下内容，并重启(DDL<span class="jill"></span>捕捉的<span class="jill"></span>trigger<span class="jill"></span>与<span class="jill"></span>OGG<span class="jill"></span>的<span class="jill"></span>extract<span class="jill"></span>进程是相互独立的)</span><code-block id="kE54JSDxXp9axru3wm8imu" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">ddl include <span class="token keyword">all</span></pre></div></code-block></li><li id="ud6XbcvmHhyPMWFDrs2Ket"><div class="marker"></div><span class="inline-wrap">目标端<span class="jill"></span>Replicate<span class="jill"></span>进程加入以下内容，并重启</span><code-block id="ttdHUTwbKd8MWMHZw9uBev" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all">ddl include all 
ddlerror default ignore retryop maxretries <span class="token number">3</span> retrydelay <span class="token number">5</span>
<span class="token comment"># default ignore 参数表示DDL语句执行错误时忽略</span>
<span class="token comment"># maxretries 参数表示重试3次</span>
<span class="token comment"># retrydelay 参数表示重试时间5s，默认60s</span></pre></div></code-block></li></ol></article><footer></footer></body></html>