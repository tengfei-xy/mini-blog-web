<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>长事务 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font less-lead"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="长事务" class="main-title"></div></div></header><article><div id="s4ptryE5SehH9fvHWoxrUT" class="wolai-block wolai-text"><div><span class="inline-wrap">查看长交易的方法</span></div></div><code-block id="8WVzsPT7M5dDaqUfpcCHfU" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>ggsci<span class="token operator">></span> send extract <span class="token operator">&lt;</span>进程名<span class="token operator">></span> , showtrans <span class="token punctuation">[</span>thread n<span class="token punctuation">]</span> <span class="token punctuation">[</span>count n<span class="token punctuation">]</span>
<span class="token comment"># 其中，&lt;进程名>为所要察看的进程名，如extsz/extxm/extjx等；</span>
<span class="token comment"># Thread n是可选的，表示只查看其中一个节点上的未提交交易；</span>
<span class="token comment"># Count n也是可选的，表示只显示n条记录。</span></pre></div></code-block><div id="fJkWZFN3mxSWAV4t2Avafc" class="wolai-block wolai-text"><div><span class="inline-wrap">例如,查看<span class="jill"></span>extsz<span class="jill"></span>进程中节点<span class="jill"></span>1<span class="jill"></span>上最长的<span class="jill"></span>10<span class="jill"></span>个交易，可以通过下列命令：</span></div></div><code-block id="uUCq7FTbpZ6CXGhfChqqZu" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>ggsci<span class="token operator">></span> send extract extsz , showtrans thread <span class="token number">1</span>  count <span class="token number">10</span>
<span class="token comment"># 输出结果是以时间降序排列的所有未提交交易列表，通过xid可以查找到对应的事务，</span>
<span class="token comment"># 可以请应用开发商和DBA帮助可以查找出未提交原因，通过数据库予以提交或者回滚后GoldenGate的checkpoint会自动向前滚动。</span></pre></div></code-block><div id="4ki5yRbFTG6Lk19aNxjsiM" class="wolai-block wolai-text"><div><span class="inline-wrap">跳过事务</span></div></div><code-block id="g5XrM66dVxmL8n9e9SSyox" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>ggsci<span class="token operator">></span> SEND EXTRACT <span class="token operator">&lt;</span>进程名<span class="token operator">></span>, SKIPTRANS <span class="token operator">&lt;</span><span class="token number">5.17</span>.2763<span class="token operator"><span class="token file-descriptor important">4</span>></span> THREAD <span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">2</span>></span> </pre></div></code-block><div id="ivUimK5ZkDozDfycDUvTmf" class="wolai-block wolai-text"><div><span class="inline-wrap">强制认为该事务已经提交</span></div></div><code-block id="16QMYnDzqFgToLzCf9McLN" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>ggsci<span class="token operator">></span> SEND EXTRACT <span class="token operator">&lt;</span>进程名<span class="token operator">></span>, FORCETRANS <span class="token operator">&lt;</span><span class="token number">5.17</span>.2763<span class="token operator"><span class="token file-descriptor important">4</span>></span> THREAD <span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">1</span>></span></pre></div></code-block><div id="kjPvcunHLA1x1iEYLcjjYU" class="wolai-block wolai-text"><div><span class="inline-wrap">说明：使用这些命令只会让<span class="jill"></span>GoldenGate<span class="jill"></span>进程跳过或者认为该交易已经提交，但并不改变数据库中的交易，他们依旧存在于数据库中。因此，强烈建议使用数据库中提交或者回滚交易而不是使用<span class="jill"></span>GoldenGate<span class="jill"></span>处理。</span></div></div><h1 id="9ZWWKm9Cf6z9MadoWvqiWd" class="wolai-block"><span class="inline-wrap">示例</span></h1><div id="qSN2GPQ1Dj9SvMDC6vaHTm" class="wolai-block wolai-text"><div><span class="inline-wrap">今天查看<span class="jill"></span>gg<span class="jill"></span>的<span class="jill"></span>error log<span class="jill"></span>发现一直警告有长事务在执行，具体信息如下：</span></div></div><div id="6tsLJ7oxZNGSjyWGVK1hTV" class="wolai-block wolai-text"><div><span class="inline-wrap">2012-04-20 14:40:52 WARNING OGG-01027 Oracle GoldenGate Capture for Oracle, extksr1.prm: Long Running Transaction: XID 747.6.1036520, Items 353, Extract EXTKSR1, Redo Thread 3, SCN 17.4265175431 (77279619463), Redo Seq #16378, Redo RBA 12319760.
2012-04-20 14:44:10 INFO  OGG-00538 Oracle GoldenGate Capture for Oracle, extksr1.prm: Metadata not invalidated for [MYNET_APP.M_GOODS_STOCK2] because of TRUNCATE.
2012-04-20 14:44:10 INFO  OGG-01487 Oracle GoldenGate Capture for Oracle, extksr1.prm: DDL found, operation [truncate table m_goods_stock2 (size 30)], start SCN [77315214174], commit SCN [77315214348] instance [yesmynet1 (1)], DDL seqno [1238], marker seqno [1238].
2012-04-20 14:44:10 INFO  OGG-00487 Oracle GoldenGate Capture for Oracle, extksr1.prm: DDL operation included [INCLUDE MAPPED], optype [TRUNCATE], objtype [TABLE], objowner [MYNET_APP], objname [M_GOODS_STOCK2].
2012-04-20 14:44:10 INFO  OGG-00497 Oracle GoldenGate Capture for Oracle, extksr1.prm: Writing DDL operation to extract trail file.
2012-04-20 14:45:52 WARNING OGG-01027 Oracle GoldenGate Capture for Oracle, extksr1.prm: Long Running Transaction: XID 747.6.1036520, Items 353, Extract EXTKSR1, Redo Thread 3, SCN 17.4265175431 (77279619463), Redo Seq #16378, Redo RBA 12319760.</span></div></div><div id="uQVG1CeJnJY6P7K3Ty6Z36" class="wolai-block wolai-text"><div><span class="inline-wrap">登陆到<span class="jill"></span>gg<span class="jill"></span>命令行界面查看详细信息如下：</span></div></div><code-block id="em9UzbgpwWFtJAxWe6nvwq" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>GGSCI <span class="token punctuation">(</span>rac3<span class="token punctuation">)</span> <span class="token number">1</span><span class="token operator"><span class="token file-descriptor important">2</span>></span> send extract extksr1,showtrans thread <span class="token number">3</span>

Sending showtrans request to EXTRACT EXTKSR1 <span class="token punctuation">..</span>.

Oldest redo log files necessary to restart Extract are:

Redo Thread <span class="token number">1</span>, Redo Log Sequence Number <span class="token number">29263</span>, SCN <span class="token number">18.5141377</span> <span class="token punctuation">(</span><span class="token number">77314552705</span><span class="token punctuation">)</span>, RBA <span class="token number">23003664</span>
Redo Thread <span class="token number">2</span>, Redo Log Sequence Number <span class="token number">27746</span>, SCN <span class="token number">18.5141481</span> <span class="token punctuation">(</span><span class="token number">77314552809</span><span class="token punctuation">)</span>, RBA <span class="token number">3775504</span>
Redo Thread <span class="token number">3</span>, Redo Log Sequence Number <span class="token number">16378</span>, SCN <span class="token number">17.4265175431</span> <span class="token punctuation">(</span><span class="token number">77279619463</span><span class="token punctuation">)</span>, RBA <span class="token number">12319760</span>

<span class="token punctuation">\</span>------------------------------------------------------------
XID:         <span class="token number">747.6</span>.1036520
Items:        <span class="token number">353</span>   
Extract:       EXTKSR1  
Redo Thread:     <span class="token number">3</span>   
Start Time:      <span class="token number">2012</span>-04-19:04:16:49 
SCN:         <span class="token number">17.4265175431</span> <span class="token punctuation">(</span><span class="token number">77279619463</span><span class="token punctuation">)</span>    
Redo Seq:       <span class="token number">16378</span>
Redo RBA:       <span class="token number">12319760</span>      
Status:        Running  </pre></div></code-block><div id="55twQfnHExbaBYvjzvzc58" class="wolai-block wolai-text"><div><span class="inline-wrap">通过<span class="jill"></span>xid<span class="jill"></span>在数据库里可以查看到对应的语句如下：</span></div></div><code-block id="vJCbVQZQNZojQWhJmrTzax" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre>SYS@ yesmynet3 <span class="token operator">></span>col sql_fulltext <span class="token keyword">for</span> a200
SYS@ yesmynet3 <span class="token operator">></span><span class="token keyword">select</span> addr <span class="token keyword">from</span> v$<span class="token keyword">transaction</span> <span class="token keyword">where</span> XIDUSN<span class="token operator">||</span>XIDSLOT<span class="token operator">||</span>XIDSQN<span class="token operator">=</span><span class="token number">74761036520</span><span class="token punctuation">;</span>
ADDR
<span class="token comment">----------------</span>
<span class="token number">0000000516</span>EF0EC0

SYS@ yesmynet3 <span class="token operator">></span><span class="token keyword">select</span> prev_sql_id <span class="token keyword">from</span> v$<span class="token keyword">session</span> <span class="token keyword">where</span> taddr <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'0000000516EF0EC0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
PREV_SQL_ID
<span class="token comment">-------------</span>
<span class="token number">08</span>kc5bgraw6jn

SYS@ yesmynet3 <span class="token operator">></span><span class="token keyword">select</span> sql_fulltext <span class="token keyword">from</span> v$<span class="token keyword">sql</span> <span class="token keyword">where</span> sql_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'08kc5bgraw6jn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SQL_FULLTEXT
<span class="token comment">---------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="token keyword">update</span> m_edm_result <span class="token keyword">set</span> cancel_flag<span class="token operator">=</span>:<span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span>:<span class="token number">2</span><span class="token punctuation">,</span> email<span class="token operator">=</span>:<span class="token number">3</span><span class="token punctuation">,</span> fail_reason<span class="token operator">=</span>:<span class="token number">4</span><span class="token punctuation">,</span> member_id<span class="token operator">=</span>:<span class="token number">5</span><span class="token punctuation">,</span> order_id<span class="token operator">=</span>:<span class="token number">6</span><span class="token punctuation">,</span> plan_send_time<span class="token operator">=</span>:<span class="token number">7</span><span class="token punctuation">,</span> result<span class="token operator">=</span>:<span class="token number">8</span><span class="token punctuation">,</span> send_count<span class="token operator">=</span>:<span class="token number">9</span><span class="token punctuation">,</span> send_time<span class="token operator">=</span>:<span class="token number">10</span><span class="token punctuation">,</span> sender_email<span class="token operator">=</span>:<span class="token number">11</span><span class="token punctuation">,</span> subject<span class="token operator">=</span>:<span class="token number">12</span><span class="token punctuation">,</span> submit_time<span class="token operator">=</span>:<span class="token number">13</span><span class="token punctuation">,</span> template_path<span class="token operator">=</span>:<span class="token number">14</span><span class="token punctuation">,</span> version<span class="token operator">=</span>:<span class="token number">15</span> <span class="token keyword">where</span> id<span class="token operator">=</span>:<span class="token number">16</span> <span class="token operator">and</span> version<span class="token operator">=</span>:<span class="token number">17</span></pre></div></code-block><div id="k8Wm9p2JRz7yyoCSShVTcS" class="wolai-block wolai-text"><div><span class="inline-wrap">由于这条语句从昨天凌晨<span class="jill"></span>4<span class="jill"></span>点多就开始执行了，所以在<span class="jill"></span>v$session<span class="jill"></span>里面查出来的<span class="jill"></span>sql_id<span class="jill"></span>可能已经没有了，我这里就是匹配之前执行的<span class="jill"></span>sql_id。</span></div></div><div id="sEyZQMp6jk4RLjvwztwNZi" class="wolai-block wolai-text"><div><span class="inline-wrap">由于该语句是在节点<span class="jill"></span>3<span class="jill"></span>上执行的，联系相关人员，发现这条语句的相关<span class="jill"></span>java<span class="jill"></span>代码条件有问题，待修改完毕，再观察观察吧。</span></div></div><div id="1GvcEQrtHobMZtPZo8VDpZ" class="wolai-block wolai-text"><div><span class="inline-wrap">另：由于该语句是在源库的<span class="jill"></span>gg error log<span class="jill"></span>里出现的警告，如果想让<span class="jill"></span>gg<span class="jill"></span>跳过该语句不执行的话，执行如下命令：</span></div></div><code-block id="3BDSbikHFKqxf8QtLjhQLp" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre>GGSCI <span class="token punctuation">(</span>rac3<span class="token punctuation">)</span> <span class="token number">14</span><span class="token operator">></span> SEND EXTRACT EXTKSR1<span class="token punctuation">,</span> SKIPTRANS <span class="token operator">&lt;</span><span class="token number">747.6</span><span class="token number">.1036520</span><span class="token operator">></span> THREAD <span class="token number">3</span></pre></div></code-block><div id="8cNQBLPz8h1LEm3NbvG4op" class="wolai-block wolai-text"><div><span class="inline-wrap">执行如下命令,强制认为该事务已经提交 ：</span></div></div><code-block id="wBzyenmN3HJeFwqntoeWJT" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>GGSCI <span class="token punctuation">(</span>rac3<span class="token punctuation">)</span> <span class="token number">1</span><span class="token operator"><span class="token file-descriptor important">4</span>></span> SEND EXTRACT EXTKSR1, FORCETRANS <span class="token operator">&lt;</span><span class="token number">747.6</span>.103652<span class="token operator"><span class="token file-descriptor important">0</span>></span> THREAD <span class="token number">3</span></pre></div></code-block><div id="v5uvqCRGLfpbBjhRAWCckt" class="wolai-block wolai-text"><div><span class="inline-wrap">不过还是建议在数据库里对该事务进行提交或者回滚操作，最好别让<span class="jill"></span>gg<span class="jill"></span>来处理！</span></div></div></article><footer></footer></body></html>