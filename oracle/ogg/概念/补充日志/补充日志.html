<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>补充日志 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font less-lead"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="补充日志" class="main-title"></div></div></header><article><h1 id="4YSPZm8JiAg63YbfyXk3SC" class="wolai-block"><span class="inline-wrap">概念</span></h1><div id="p5m72J8bekAkNRG2pXzdwT" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>补充日志：</b></span><span class="inline-wrap"><b>补充日志：</b></span><span class="inline-wrap"> 主要是针对 UPDATE 命令的，是对重做日志记录中 变更矢量块的补充信息，增加了变更矢量记载的记录量。日志挖掘器(LogMiner)、闪回事务查询、闪回事务等都需要 补充日志的支持。尤其是 日志挖掘器如果发现未启用补充日志，就拒绝服务。也就是说补充日志主要是为<span class="jill"></span>UPDATE 命令服务的，补充的目的是高度还原 UPDATE 命令，避免因为<span class="jill"></span>update 命令造成的行迁移和行移动，让<span class="jill"></span>LogMiner 通过分析重做日志中识别 update 命令 不是 由 insert 和 delete 完成的。如果未启用补充日志，重做日志只将 UPDATE 命令更改的字段的旧值保存在撤销数据块的变更矢量中。而在数据块中的变更矢量中记载被修改后的字段的新值。同行中的未被修改的字段，不会被记载。如果启用了补充日志，重做日志中的撤销数据块的变更矢量中会记录 被修改字段前的值和修改后的值，而且还会记录修改字段的那个条件的值。即变更矢量中会记载：几号数据文件<span class="jill"></span>+<span class="jill"></span>几号文件中的几号块<span class="jill"></span>+<span class="jill"></span>第几个字段<span class="jill"></span>+<span class="jill"></span>修改后的值<span class="jill"></span>+<span class="jill"></span>修改前的值<span class="jill"></span>+“where 条件” 的值。</span><span class="inline-wrap"> 主要是针对 UPDATE 命令的，是对重做日志记录中 变更矢量块的补充信息，增加了变更矢量记载的记录量。日志挖掘器(LogMiner)、闪回事务查询、闪回事务等都需要 补充日志的支持。尤其是 日志挖掘器如果发现未启用补充日志，就拒绝服务。也就是说补充日志主要是为<span class="jill"></span>UPDATE 命令服务的，补充的目的是高度还原 UPDATE 命令，避免因为<span class="jill"></span>update 命令造成的行迁移和行移动，让<span class="jill"></span>LogMiner 通过分析重做日志中识别 update 命令 不是 由 insert 和 delete 完成的。如果未启用补充日志，重做日志只将 UPDATE 命令更改的字段的旧值保存在撤销数据块的变更矢量中。而在数据块中的变更矢量中记载被修改后的字段的新值。同行中的未被修改的字段，不会被记载。如果启用了补充日志，重做日志中的撤销数据块的变更矢量中会记录 被修改字段前的值和修改后的值，而且还会记录修改字段的那个条件的值。即变更矢量中会记载：几号数据文件<span class="jill"></span>+<span class="jill"></span>几号文件中的几号块<span class="jill"></span>+<span class="jill"></span>第几个字段<span class="jill"></span>+<span class="jill"></span>修改后的值<span class="jill"></span>+<span class="jill"></span>修改前的值<span class="jill"></span>+“where 条件” 的值。</span></div></div><div id="1wpLHo1KHvYJPDuujWBE2T" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>行移动：</b></span><span class="inline-wrap"> 指 update 命令执行时时，在索引组织表中有时会导致整行被转移至另一个索引块中。该情况或过程称为行移动。</span></div></div><div id="oU1GvY5svwZ8kS4d6TVtn8" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>行迁移：</b></span><span class="inline-wrap"><b>行迁移：</b></span><span class="inline-wrap"> 如果是在堆栈表中，update 命令导致行太长，在数据块空间不足的情况下会将部分（行头部除外）迁移到另一个数据块中，行头任然保留在原数据块中。</span><span class="inline-wrap"> 如果是在堆栈表中，update 命令导致行太长，在数据块空间不足的情况下会将部分（行头部除外）迁移到另一个数据块中，行头任然保留在原数据块中。</span></div></div><div id="dM71diWjwwjAtytntubsiJ" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>补充日志分为：数据库级补充日志、 表级补充日志</b></span></div></div><div id="nzf4QnHjdtFcrLA69qxuCt" class="wolai-block wolai-text"><div><span class="inline-wrap">其他补充日志都是基于数据库级最小补充日志之上的，如果未启用数据库级最小补充日志，在启用或使用其他补充日志时，会自动启用数据库的最小补充日志(Implicit)。</span></div></div><div id="jB9oK87KRiMqZQ5nFz4avS" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>数据库级补充日志分为：最小补充日志、标识关键字段补充日志</b></span></div></div><div id="cK7URWGpnve6YAHNiwyL4L" class="wolai-block wolai-text"><div><span class="inline-wrap">最小补充日志：是最基本的一种数据库级补充日志，而 LogMiner 正是依赖最小补充日志工作服务的(即识别 行移动 行迁移)。
启用最小补充日志命令： ALTER DATABASE ADD Supplemental LOG DATA ;</span></div></div><div id="co5SjeJARpHv34ZNVDcRey" class="wolai-block wolai-text"><div><span class="inline-wrap">关闭最小补充日志命令：ALTER DATABASEDROP SupplementalLOG DATA;</span></div></div><div id="tpAzxovhF6S8j5kyrTnMsS" class="wolai-block wolai-text"><div><span class="inline-wrap">标识关键字段补充日志：分为主键、外键、唯一索引、全体字段 补充日志<span class="jill"></span>4<span class="jill"></span>种。</span></div></div><div id="tn9XSiHuyrRDz21yzhWZvh" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>主键补充日志：</b></span></div></div><div id="kky2dF25kaaef74nhMPHXe" class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>update 命令的重做记录中添加被修改行的主键字段的旧值，无论是否被修改，都记录。</span></div></div><div id="iKmewYN9KmQTzS3LTxuDEQ" class="wolai-block wolai-text"><div><span class="inline-wrap">如果表没有主键，则由长度最小的唯一索引字段代替，若连唯一索引也没有，则记录该行所有字段。
alter database add supplemental log data (Primary key) columns ;</span></div></div><div id="wMpHReJfjzuyUek8qg3NF8" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>唯一索引补充日志：</b></span></div></div><div id="tnPr8gKp3TqwwxTUUZ2miU" class="wolai-block wolai-text"><div><span class="inline-wrap">唯一索引主要是为 复合索引（唯一）服务的。只有唯一索引的字段被 update 时，才会记录该字段被修改前的值。</span></div></div><div id="sRKRsmQqAKveJvCoTHM99W" class="wolai-block wolai-text"><div><span class="inline-wrap">alter database add supplemental log data (unique) columns ;</span></div></div><div id="v8KXEs3Ys9S85uXFWsNGzY" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>外键补充日志：</b></span></div></div><div id="3hCAgPwhk2BWSJNSHfTzJk" class="wolai-block wolai-text"><div><span class="inline-wrap">同唯一索引补充日志一样，只有外键字段被 update 时，才会记录被修改前的旧值，即也是为复合外键服务的。</span></div></div><div id="1XXdsMyvjzJuhaiAGVeshw" class="wolai-block wolai-text"><div><span class="inline-wrap">alter database add supplemental log data (foreign key ) columns ;</span></div></div><div id="qhNvXjKt8PWC9tmmHJLFda" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>全体字段补充日志：</b></span></div></div><div id="eVNVt2wgQxPyHoic7az9T2" class="wolai-block wolai-text"><div><span class="inline-wrap">顾名思义就所有字段的值不论是否被修改都记录。会导致磁盘快速增长，LGWR<span class="jill"></span>进程繁忙。不建议使用。</span></div></div><div id="eoeXMUyXqcmCJakkv6Wfy8" class="wolai-block wolai-text"><div><span class="inline-wrap">alter database add supplemental log data (all) columns ;</span></div></div><div id="hBB5Rq6k47XggWNdAsF1xN" class="wolai-block wolai-text"><div><span class="inline-wrap">这 4 种补充日志可以并行使用，效果累加。</span></div></div><div id="nUA8ReowbLFTBj4rex8hc5" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>表级补充日志</b></span><span class="inline-wrap">分为： 主键、唯一索引、外键、全体字段、用户自定义字段 5<span class="jill"></span>种。</span></div></div><div id="6bJQKRELsjisQ8mCV5cYdV" class="wolai-block wolai-text"><div><span class="inline-wrap">前 4 种 同数据库级标识关键字段补充日志效果用法一样。只不过是在特定表上启用补充日志。</span></div></div><div id="r9HKLKt99bmvDTC6m4rWFC" class="wolai-block wolai-text"><div><span class="inline-wrap">1、 alter table tb_name add supplemental log data (primary key) columns ;
2、alter table tb_name add supplemental log data (unique) columns ;
3、 alter table tb_name add supplemental log data (foreign key) columns ;
4、 alter table tb_name add supplemental log data (all) columns ;
5、 alter table tb_name add supplemental log group group_name (col01,col02,col05,col09) | always ;</span></div></div><div id="8nieY2fwoS4gtYCdpCPZw4" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>自定义字段表级补充日志：</b></span></div></div><div id="p142UGbaoG92tDTc98aLn9" class="wolai-block wolai-text"><div><span class="inline-wrap">用户可以任意指定哪些字段的旧值需要被补充日志记录。</span></div></div><div id="uynisqVvTnrEt3xRfz7HFz" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>有条件日志组：</b></span><span class="inline-wrap"><b>有条件日志组：</b></span><span class="inline-wrap"> 只要补充日志组中至少一个列被修改(update)，那么就要记录所有(日志组)指定列的前镜像(旧值)。</span><span class="inline-wrap"> 只要补充日志组中至少一个列被修改(update)，那么就要记录所有(日志组)指定列的前镜像(旧值)。</span></div></div><div id="tCA5g7R16fsnEPx1dBi4io" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>无条件日志组：</b></span><span class="inline-wrap"><b>无条件日志组：</b></span><span class="inline-wrap"> 当表被修改时要记录所有(日志组)指定列的前镜像(旧值)，无论改变是否对任一(日志组)指定列造成影响。需添加 always 关键字。</span><span class="inline-wrap"> 当表被修改时要记录所有(日志组)指定列的前镜像(旧值)，无论改变是否对任一(日志组)指定列造成影响。需添加 always 关键字。</span></div></div><h1 id="aFYPcwV9DE9hexo2q5Rh5y" class="wolai-block"><span class="inline-wrap">官方文档说明</span></h1><div id="q6FemajyBpz6hb8JjpGAu8" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>conditional log group</b></span><span class="inline-wrap">：A </span><span class="inline-wrap"><a href="http://docs.oracle.com/cd/E11882_01/server.112/e17069/strms_glossary.htm#CHDJHFHF"><span><b>supplemental log group</b></span></a></span><span class="inline-wrap"> that logs the before images of all specified columns only if at least one of the columns in the supplemental log group is modified.</span></div></div><div id="8rdMNRLXJ3JmeMZKwCqmfL" class="wolai-block wolai-text"><div><span class="inline-wrap">unconditional log group：A </span><span class="inline-wrap"><a href="http://docs.oracle.com/cd/E11882_01/server.112/e17069/strms_glossary.htm#CHDJHFHF"><span><b>supplemental log group</b></span></a></span><span class="inline-wrap"> that logs the before images of specified columns when the table is changed, regardless of whether the change affected any of the specified columns.</span></div></div><div id="vur1oHp3kU9GrwxERLBEoC" class="wolai-block wolai-text"><div><span class="inline-wrap">表级补充日志的情况 通过 dba_log_groups 和 dba_log_group_columns 视图查询获得</span></div></div><div id="drxCX1GWwhdvopXty8AysK" class="wolai-block wolai-text"><div><span class="inline-wrap">补充日志不是独立的日志，而是对重做日志变更矢量的补充。LogMiner、闪回事务、闪回事务查询等功能需要开启补充日志才能正常工作。</span></div></div><div id="eNscnWBZvHVw2DAyAy3qyU" class="wolai-block wolai-text"><div><span class="inline-wrap">补充日志可分为两类数据库级别补充日志和表级别补充日志，数据库级别补充日志可分为最小补充日志、主键补充日志、唯一索引补充日志、外键补充日志、全体补充日志<span class="jill"></span>6<span class="jill"></span>种，表级别补充日志在数据库级别补充日志的基础上增加了一种自定义补充日志，没有最小补充日志。</span></div></div><div id="9PRM63mzTjimykUGiy4fSR" class="wolai-block wolai-text"><div><span class="inline-wrap">因为<span class="jill"></span>insert<span class="jill"></span>会记录所有修改后字段，delete<span class="jill"></span>会记录所有修改前字段，所以补全日志只对<span class="jill"></span>update<span class="jill"></span>产生影响，开启补全日志时共享池中的<span class="jill"></span>SQL<span class="jill"></span>游标都会失效，他们的影响和功能如下：</span></div></div><div id="kymRxsrQbeXk9N6i774Dra" class="wolai-block wolai-simple-table"><table><thead><tr><th style="width: 185px"><br/></th><th style="width: 185px"><span class="inline-wrap">最小补充日志</span></th><th style="width: 185px"><span class="inline-wrap">主键补充日志</span></th><th style="width: 185px"><span class="inline-wrap">唯一补充日志</span></th></tr></thead><tbody><tr><td><span class="inline-wrap">Update<span class="jill"></span>操作的影响</span></td><td><span class="inline-wrap">产生特殊的日志信息，可以识别<span class="jill"></span>update<span class="jill"></span>命令产生的行迁移和行转换。Logminer<span class="jill"></span>和闪回事务查询功能需要最小补全日志支持。打开最小补全日志会使共享池<span class="jill"></span>SQL<span class="jill"></span>游标失效。</span></td><td><span class="inline-wrap">无条件补充日志，无论主键是否被修改旧值都会被记录到日志中。没有主键则记录长度最小唯一非空索引，没有非空唯一索引则记录所有字段。依赖最小补全日志，开启主键补充日志自动开启最小补充日志。关闭最小补全日志自动关闭主键补全日志</span></td><td><span class="inline-wrap">有条件补充日志，当复合唯一索引的其中一个字段被修改时，唯一索引的所有字段旧值都会被记录。唯一补充日志专门为复合唯一索引服务。</span></td></tr><tr><td><span class="inline-wrap">开启/关闭</span></td><td><span class="inline-wrap">开启/关闭：  alter database add/drop supplemental log data。</span></td><td><span class="inline-wrap">开启/关闭(数据库级)：  alter database add/drop supplemental log data (primary key) columns。  开启/关闭(表级)：  alter table T1 add/drop supplemental log data (primary key) columns。</span></td><td><span class="inline-wrap">开启/关闭(数据库级)：  alter database add/drop supplemental log data (unique) columns。  开启/关闭(表级)：  alter table T1 add/drop supplemental log data (unique) columns。</span></td></tr><tr><td><span class="inline-wrap">依赖</span></td><td><span class="inline-wrap">无</span></td><td><span class="inline-wrap">依赖最小补全日志</span></td><td><span class="inline-wrap">依赖最小补全日志</span></td></tr></tbody></table></div><div id="4JiUX3ccv9k8z8N3nYavHr" class="wolai-block wolai-simple-table"><table><thead><tr><th style="width: 185px"><br/></th><th style="width: 185px"><span class="inline-wrap">外键补充日志</span></th><th style="width: 185px"><span class="inline-wrap">全体补充日志</span></th><th style="width: 185px"><span class="inline-wrap">自定义补充日志(表)</span></th></tr></thead><tbody><tr><td><span class="inline-wrap">Update<span class="jill"></span>操作的影响</span></td><td><span class="inline-wrap">有条件补充日志，当复合外键索引的其中一个字段被修改时，外键索引的所有字段旧值都会被记录。唯一补充日志专为复合外键索引服务。</span></td><td><span class="inline-wrap">无条件补充日志，表的所有字段旧值都会被记录（除了<span class="jill"></span>LOB、LONG<span class="jill"></span>类型）。</span></td><td><span class="inline-wrap">有/无条件补充日志，设置多个字段为日志组，日志组中的任何字段被修改，整个日志组字段的旧值都记录在日志中。</span></td></tr><tr><td><span class="inline-wrap">开启/关闭</span></td><td><span class="inline-wrap">开启/关闭(数据库级)：  alter database add/drop supplemental log data (foreign key) columns。  开启/关闭(表级)：  alter table T1 add/drop supplemental log data (foreign key) columns。</span></td><td><span class="inline-wrap">开启/关闭(数据库级)：  alter database add/drop supplemental log data (all) columns。  开启/关闭(表级)：  alter table T1 add/drop supplemental log data (all) columns。</span></td><td><span class="inline-wrap">开启/关闭(表级)：  alter table T1 add/drop supplemental log group GROUPNAME(C1,C2,C3) allways。</span></td></tr><tr><td><span class="inline-wrap">依赖</span></td><td><span class="inline-wrap">依赖最小补全日志</span></td><td><span class="inline-wrap">依赖最小补全日志</span></td><td><span class="inline-wrap">依赖最小补全日志</span></td></tr></tbody></table></div></article><footer></footer></body></html>