<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/wolai.css"/><title>集群-2.2-手动 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font less-lead"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="集群-2.2-手动" class="main-title"></div></div></header><article><h1 id="pH5GAk7aZKAH9dAYftyWFJ" class="wolai-block"><span class="inline-wrap">一、配置信息</span></h1><div id="eUA3zNWGSgcDzkA6wxVpcH" class="wolai-block wolai-simple-table"><table><thead><tr><th style="width: 246.66666666666666px"><span class="inline-wrap">主机名</span></th><th style="width: 246.66666666666666px"><span class="inline-wrap">IP</span></th><th style="width: 246.66666666666666px"><span class="inline-wrap">规格</span></th></tr></thead><tbody><tr><td><span class="inline-wrap">ob1</span></td><td><span class="inline-wrap">192.168.3.71</span></td><td><span class="inline-wrap">6C20G</span></td></tr><tr><td><span class="inline-wrap">ob2</span></td><td><span class="inline-wrap">192.168.3.72</span></td><td><span class="inline-wrap">6C20G</span></td></tr><tr><td><span class="inline-wrap">ob3</span></td><td><span class="inline-wrap">192.168.3.73</span></td><td><span class="inline-wrap">6C20G</span></td></tr></tbody></table></div><div id="hqdZeDuuJKbAjEZpWa8BcW" class="wolai-block wolai-text"><div><span class="inline-wrap">文件准备：</span></div></div><ul class="wolai-block"><li id="xvj8Q9HaoNoCi6JJXJL5bD"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">2.2.50<span class="jill"></span>版本的<span class="jill"></span>mini-ob-deploy.tar</span></li><li id="3TFWWTRfW8yDTzJHPWQNhS"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">client-2.0.0-2.el7.x86_64.rpm、libobclient-2.0.0-2.el7.x86_64.rpm</span></li><li id="jdeLhpSQprNS6QWn3oZk4a"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">obproxy-3.1.0-1.el7.x86_64.rpm</span></li></ul><div id="7v3iwGWzMwxguLFCxPkTL3" class="wolai-block wolai-text"><div><span class="inline-wrap">下载链接:</span><span class="inline-wrap"><a href="https://pan.baidu.com/s/1KEb2QFoM4rlNHJOq1ljSTQ"><span>https://pan.baidu.com/s/1KEb2QFoM4rlNHJOq1ljSTQ</span></a></span><span class="inline-wrap"> 提取码:cebv</span></div></div><h1 id="6ebLzdwLM9JFBEYHdo9bhv" class="wolai-block"><span class="inline-wrap">二、集群搭建</span></h1><h2 id="auejNJCW29RMB6Fxs31cTK" class="wolai-block"><span class="inline-wrap">2.1 系统配置</span></h2><ol class="wolai-block"><li id="cYw5FukKMrah1WWSiVZKEr"><div class="marker"></div><span class="inline-wrap">各个节点修改主机名</span><code-block id="jz6fv7bj45Lqmc8vgXmW7h" class="wolai-block"><div class="wolai-pre"><div data-lang="Shell" class="marker"></div><pre><span class="token function">hostname</span> ob1
hostnamectl set-hostname ob1</pre></div></code-block></li><li id="rubjAFekfZzBdgGjKwwXir"><div class="marker"></div><span class="inline-wrap">关闭防火墙、SELINUX</span><code-block id="1Xqi2caipKSRUB5dQuKX8x" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>systemctl stop firewalld <span class="token operator">&amp;&amp;</span> systemctl disable firewalld
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/config <span class="token operator">&amp;&amp;</span>  setenforce <span class="token number">0</span></pre></div></code-block></li><li id="sbL217cU1pZRHji8Xmz9Uo"><div class="marker"></div><span class="inline-wrap">安装包</span><code-block id="2BTTijsjYxwWVUEe999Bmr" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token parameter variable">-q</span> ntp net-tools telnet <span class="token function">expect</span> gcc gcc-c++ <span class="token function">lsof</span> mariadb</pre></div></code-block></li><li id="uJLqiQUuWZbN5gpy7FYR9f"><div class="marker"></div><span class="inline-wrap">设置<span class="jill"></span>limits.conf</span><code-block id="aGJFCGUWkD86ZvodTun6DB" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">cat</span> <span class="token operator">>></span> /etc/security/limits.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
* soft nofile 655350
* hard nofile 655350
* soft stack 20480
* hard stack 20480
* soft nproc 655360
* hard nproc 655360
* soft core unlimited
* hard core unlimited
EOF</span></pre></div></code-block></li><li id="idvYQtbod4jwY7UUyXXhoC"><div class="marker"></div><span class="inline-wrap">设置内核参数</span><code-block id="d3Nt3qUaqzREytnbgVYUQB" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">cat</span> <span class="token operator">>></span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
fs.aio-max-nr = 1048576
net.core.somaxconn = 2048
net.core.netdev_max_backlog = 10000
net.core.rmem_default = 16777216
net.core.wmem_default = 16777216
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216

net.ipv4.ip_local_port_range = 3500 65535
net.ipv4.ip_forward = 0
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.tcp_syncookies = 0
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_slow_start_after_idle=0

vm.swappiness = 0
kernel.core_pattern = /data/1/core-%e-%p-%t
vm.min_free_kbytes = 2097152
vm.max_map_count=655360
EOF</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span></pre></div></code-block></li><li id="gbA27wYUXwzyZUMrZFsiYK"><div class="marker"></div><span class="inline-wrap">时间同步</span><span class="inline-wrap">
</span><span class="inline-wrap">节点一执行</span><code-block id="19ZdyoFfL3gBDURnVtyQNA" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">cat</span> <span class="token operator">></span> /etc/ntp.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
driftfile /var/lib/ntp/drift
server 127.127.1.0 
#Fudge 127.127.1.0 stratum 10
includefile /etc/ntp/crypto/pw
keys /etc/ntp/keys
disable monitor
EOF</span></pre></div></code-block><div id="pwVPEWEdbpQc36z8oFEs2s" class="wolai-block wolai-text"><div><span class="inline-wrap">其他节点执行</span></div></div><code-block id="6scm6vas8GGrpErPo79b6E" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">cat</span> <span class="token operator">></span> /etc/ntp.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
driftfile /var/lib/ntp/drift
restrict 127.0.0.1 
restrict ::1
server 192.168.3.71
Fudge 192.168.3.71 stratum 10
includefile /etc/ntp/crypto/pw
keys /etc/ntp/keys
disable monitor
EOF</span></pre></div></code-block><div id="hFikWeL1DSsi5HJ4bsC3su" class="wolai-block wolai-text"><div><span class="inline-wrap">在每个节点重启服务</span></div></div><code-block id="8txiUQtbVpwn8jG3zE1nDq" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>systemctl enable ntpd
systemctl restart ntpd</pre></div></code-block></li><li id="cDBDQfjCcgRFY7Q9QSiZHy"><div class="marker"></div><span class="inline-wrap">创建<span class="jill"></span>obadmin<span class="jill"></span>用户</span><code-block id="gQop8afyuo8RHdY5WZvKc5" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">groupadd</span> obadmin
<span class="token function">useradd</span> <span class="token parameter variable">-g</span> obadmin <span class="token parameter variable">-s</span> /bin/bash <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">`</span>openssl <span class="token function">passwd</span> <span class="token parameter variable">-1</span> <span class="token string">"obadmin"</span><span class="token variable">`</span></span> <span class="token parameter variable">-m</span> <span class="token parameter variable">-d</span> /home/obadmin obadmin</pre></div></code-block></li><li id="8cftipMdrePD8C48quiVUn"><div class="marker"></div><span class="inline-wrap">使用<span class="jill"></span>obadmin<span class="jill"></span>用户互信</span><code-block id="qgZGhvETvPWq6aytaxLEvZ" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>ssh-keygen <span class="token parameter variable">-t</span> rsa
ssh-copy-id  <span class="token number">192.168</span>.3.71
ssh-copy-id  <span class="token number">192.168</span>.3.72
ssh-copy-id  <span class="token number">192.168</span>.3.73</pre></div></code-block></li><li id="otAyriMZDPTtACz8jTdHKf"><div class="marker"></div><span class="inline-wrap">初始化文件结构并赋权</span><code-block id="pMPs2sQWyoULJSLRiXrtjV" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># root每个节点执行</span>
<span class="token assign-left variable">ob_data</span><span class="token operator">=</span><span class="token string">"/data/oceanbase"</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">"<span class="token variable">$ob_data</span>"</span>/1/obdemo/<span class="token punctuation">{</span>etc3,sort_dir,sstable<span class="token punctuation">}</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">"<span class="token variable">$ob_data</span>"</span>/log1/obdemo/<span class="token punctuation">{</span>clog,etc2,ilog,slog,oob_clog<span class="token punctuation">}</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> obadmin:obadmin <span class="token string">"<span class="token variable">$ob_data</span>"</span> /data

<span class="token comment"># obadmin用户执行</span>
<span class="token assign-left variable">ob_data</span><span class="token operator">=</span><span class="token string">"/data/oceanbase"</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/oceanbase/<span class="token punctuation">{</span>admin,bin,etc,store<span class="token punctuation">}</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/oceanbase/store/obdemo
<span class="token function">cp</span> ~/mini-ob-deploy/bin/observer ~/oceanbase/bin/
<span class="token keyword">for</span> <span class="token for-or-select variable">t</span> <span class="token keyword">in</span> <span class="token punctuation">{</span>etc3,sort_dir,sstable<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$ob_data</span>"</span>/1/obdemo/<span class="token variable">$t</span> ~/oceanbase/store/obdemo/<span class="token variable">$t</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">t</span> <span class="token keyword">in</span> <span class="token punctuation">{</span>clog,etc2,ilog,slog,oob_clog<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$ob_data</span>"</span>/log1/obdemo/<span class="token variable">$t</span> ~/oceanbase/store/obdemo/<span class="token variable">$t</span><span class="token punctuation">;</span> <span class="token keyword">done</span></pre></div></code-block></li></ol><h2 id="geDrf9vS7Y9mxrZvHaurjy" class="wolai-block"><span class="inline-wrap">2.2 初始化数据</span></h2><div id="gfK3qoF6jfnXiNACnLBroA" class="wolai-block wolai-text"><div><span class="inline-wrap">参考链接：</span><span class="inline-wrap"><a href="https://www.modb.pro/db/33734"><span>安装文档</span></a></span></div></div><ol class="wolai-block"><li id="rDycDLB6BE6grQDpdRY5LQ"><div class="marker"></div><span class="inline-wrap">每个节点启动<span class="jill"></span>OBServer<span class="jill"></span>进程</span><ol class="wolai-block"><li id="paKVfuZxNmYvcwnutYKLEu"><div class="marker"></div><span class="inline-wrap">observer.log<span class="jill"></span>里通常会报错<span class="jill"></span>fid file doesn&#39;t exist(pidfile=&quot;run/observer.pid&quot;，可以忽略</span></li><li id="87KmpSmF4odNWnB3Aymuz9"><div class="marker"></div><span class="inline-wrap">-z<span class="jill"></span>参数，节点<span class="jill"></span>1<span class="jill"></span>设置为<span class="jill"></span>zone1,节点<span class="jill"></span>2<span class="jill"></span>设置为<span class="jill"></span>zone2,节点<span class="jill"></span>3<span class="jill"></span>设置为<span class="jill"></span>zone3</span></li><li id="9vPLNA1HhfkaQB8eoohFnU"><div class="marker"></div><span class="inline-wrap">使用<span class="jill"></span>kvm<span class="jill"></span>的虚拟机启动<span class="jill"></span>observer<span class="jill"></span>需要复制<span class="jill"></span>cpu<span class="jill"></span>配置，关机时设置，参考</span><span class="inline-wrap"><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html-single/virtualization_tuning_and_optimization_guide/index"><span>文档 3.3.2. Option: CPU Configuration</span></a></span></li><li id="r1kqFuZtvAaGE3XmcoNwbt"><div class="marker"></div><span class="inline-wrap">workers_per_cpu_quota=4，用于设置租户的每个 CPU 配额所允许的最大并发数。</span></li><li id="jf6TSg5rEtFdhXiFdiEfVy"><div class="marker"></div><span class="inline-wrap">memory_limit=16，用于最大内存</span></li></ol><code-block id="68vaFtjQgFhpSzt8Ty3Gjr" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">ob_data</span><span class="token operator">=</span><span class="token string">"/data/oceanbase"</span>
<span class="token assign-left variable">ob_node1_ip</span><span class="token operator">=</span><span class="token string">"192.168.3.71"</span>
<span class="token assign-left variable">ob_node2_ip</span><span class="token operator">=</span><span class="token string">"192.168.3.72"</span>
<span class="token assign-left variable">ob_node3_ip</span><span class="token operator">=</span><span class="token string">"192.168.3.73"</span>
<span class="token assign-left variable">ob_cluster_name</span><span class="token operator">=</span><span class="token string">"obdemo"</span>
<span class="token assign-left variable">ob_ifcfg</span><span class="token operator">=</span><span class="token string">"eth0"</span>
<span class="token assign-left variable">zone</span><span class="token operator">=</span><span class="token string">"zone"</span><span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">".$"</span> <span class="token parameter variable">-o</span><span class="token variable">)</span></span>

~/oceanbase/bin/observer <span class="token parameter variable">-l</span> warn <span class="token parameter variable">-i</span> <span class="token string">"<span class="token variable">$ob_ifcfg</span>"</span> <span class="token parameter variable">-P</span> <span class="token number">2882</span> <span class="token parameter variable">-p</span> <span class="token number">2881</span> <span class="token parameter variable">-z</span> <span class="token variable">$zone</span> <span class="token parameter variable">-d</span> ~/oceanbase/store/<span class="token variable">$ob_cluster_name</span> <span class="token parameter variable">-r</span> <span class="token string">"<span class="token variable">$ob_node1_ip</span>:2882:2881;<span class="token variable">$ob_node2_ip</span>:2882:2881;<span class="token variable">$ob_node3_ip</span>:2882:2881"</span> <span class="token parameter variable">-c</span> <span class="token number">20210928</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$ob_cluster_name</span>"</span> <span class="token parameter variable">-o</span> <span class="token string">"memory_limit=25G,cache_wash_threshold=1G,row_purge_thread_count=1,net_thread_count=1,enable_syslog_recycle=True,enable_merge_by_turn=FALSE,cpu_count=16,location_refresh_thread_count=2,max_syslog_file_count=3,major_freeze_duty_time=Disable,__easy_memory_limit=1G,schema_history_expire_time=1d,merge_thread_count=1,writing_throttling_trigger_percentage=70,_max_trx_size=2M,workers_per_cpu_quota=6,enable_separate_sys_clog=0,datafile_disk_percentage=90,__min_full_resource_pool_memory=536870912,system_memory=4G,memory_chunk_cache_size=128M,trace_log_slow_query_watermark=10s,writing_throttling_maximum_duration=1m,switchover_process_thread_count=1,datafile_size=40G,minor_freeze_times=500,stack_size=1536K,disk_io_thread_coun=1,config_additional_dir=<span class="token variable">$ob_data</span>/1/<span class="token variable">$ob_cluster_name</span>/etc3;<span class="token variable">$ob_data</span>/log1/<span class="token variable">$ob_cluster_name</span>/etc2"</span> <span class="token operator">></span> /dev/nul <span class="token number">2</span><span class="token operator">&amp;></span><span class="token number">1</span>
<span class="token builtin class-name">echo</span> <span class="token string">"netstat -tunlp | grep observer"</span></pre></div></code-block></li><li id="82yAajFZGnQ4SVL6437EXP"><div class="marker"></div><span class="inline-wrap">确保<span class="jill"></span>observer<span class="jill"></span>进程启动且监听中</span><code-block id="t64ts5bHyasCfnSDaa47u9" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token punctuation">[</span>obadmin@ob1 <span class="token operator">~</span><span class="token punctuation">]</span>$ netstat <span class="token operator">-</span>tunlp <span class="token operator">|</span> grep observer
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">:</span><span class="token number">2881</span>            <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">:</span><span class="token operator">*</span>               <span class="token constant">LISTEN</span>      <span class="token number">25921</span><span class="token operator">/</span>observer      
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">:</span><span class="token number">2882</span>            <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">:</span><span class="token operator">*</span>               <span class="token constant">LISTEN</span>      <span class="token number">25921</span><span class="token operator">/</span>observer </pre></div></code-block></li><li id="h88Vg9fLPRxs3Jkm8NCjaK"><div class="marker"></div><span class="inline-wrap">任意节点执行以进行初始化,mysql<span class="jill"></span>密码为空</span><code-block id="c7rzZ418jC22BWWj2URDH1" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 如果没有mysql，检查下yum是否安装完整</span>
~/mini-ob-deploy/mysql  <span class="token parameter variable">-h127.0.0.1</span> <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-P2881</span> <span class="token parameter variable">-p</span>

MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> 
<span class="token builtin class-name">set</span> session <span class="token assign-left variable">ob_query_timeout</span><span class="token operator">=</span><span class="token number">100000000000</span><span class="token punctuation">;</span>
<span class="token builtin class-name">set</span> session <span class="token assign-left variable">ob_trx_lock_timeout</span><span class="token operator">=</span><span class="token number">5000000</span><span class="token punctuation">;</span>

<span class="token comment"># 三节点模式</span>
MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> alter system bootstrap ZONE <span class="token string">'zone1'</span> SERVER <span class="token string">'192.168.3.71:2882'</span>, ZONE <span class="token string">'zone2'</span> SERVER <span class="token string">'192.168.3.72:2882'</span>, ZONE <span class="token string">'zone3'</span> SERVER <span class="token string">'192.168.3.73:2882'</span><span class="token punctuation">;</span>

<span class="token comment"># 如果反反复复搭建失败或资源不足，可以用如下命令实现单节点集群</span>
<span class="token comment"># 单节点模式</span>
MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> alter system bootstrap ZONE <span class="token string">'zone1'</span> SERVER <span class="token string">'192.168.3.71:2882'</span><span class="token punctuation">;</span></pre></div></code-block><div id="wgM9ZFRnqFGBDKKEAQqj9H" class="wolai-block wolai-text"><div><span class="inline-wrap">可能的问题：</span></div></div></li><li id="qfMjAkoXoDXbeR24Nz9jn3"><div class="marker"></div><span class="inline-wrap">TIMEOUT，通常和文件配置无关，与系统本身的内核、主机内存（可以增加内存）有关，ntp<span class="jill"></span>与服务器偏差小于<span class="jill"></span>30ms。</span></li><li id="7FPTGCiDfbueHG2yo7r7E6"><div class="marker"></div><span class="inline-wrap">System ERROR，需要清空文件后，重新初始化</span></li><li id="ctj9yH3Rz9z6AbpXt48Kxd"><div class="marker"></div><span class="inline-wrap">inti twice，需要清空文件后，重新初始化</span></li><li id="xzJpVCaggjoyHM1VkuUY6n"><div class="marker"></div><span class="inline-wrap">Lost connection to MySQL server during query，检查其他节点是否存在<span class="jill"></span>2881（默认）端口监听</span></li><li id="tSLFhURP7Ami8M4CKyc1YT"><div class="marker"></div><span class="inline-wrap">通常启动完<span class="jill"></span>obeserver<span class="jill"></span>后，将启动<span class="jill"></span>observer<span class="jill"></span>进程与开启<span class="jill"></span>2881、2882<span class="jill"></span>端口,如果失败建议重新实施，删除配置如下</span><code-block id="jx2Xtr91VUKaq6eAk1LnDy" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">ob_data</span><span class="token operator">=</span><span class="token string">"/data/oceanbase"</span>
<span class="token function">kill</span> <span class="token parameter variable">-9</span> <span class="token variable"><span class="token variable">`</span>pgrep observer<span class="token variable">`</span></span> <span class="token operator">&amp;&amp;</span> <span class="token function">sleep</span> <span class="token number">3</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token string">"<span class="token variable">$ob_data</span>"</span>/*
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> ~/oceanbase
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> ~/audit ~/cgroup/ ~/etc/ ~/log/ ~/run/
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">"<span class="token variable">$ob_data</span>"</span>/1/obdemo/<span class="token punctuation">{</span>etc3,sort_dir,sstable<span class="token punctuation">}</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token string">"<span class="token variable">$ob_data</span>"</span>/log1/obdemo/<span class="token punctuation">{</span>clog,etc2,ilog,slog,oob_clog<span class="token punctuation">}</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/oceanbase/<span class="token punctuation">{</span>admin,bin,etc,store<span class="token punctuation">}</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/oceanbase/store/obdemo
<span class="token function">cp</span> ~/mini-ob-deploy/bin/observer ~/oceanbase/bin/
<span class="token keyword">for</span> <span class="token for-or-select variable">t</span> <span class="token keyword">in</span> <span class="token punctuation">{</span>etc3,sort_dir,sstable<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$ob_data</span>"</span>/1/obdemo/<span class="token variable">$t</span> ~/oceanbase/store/obdemo/<span class="token variable">$t</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">t</span> <span class="token keyword">in</span> <span class="token punctuation">{</span>clog,etc2,ilog,slog,oob_clog<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$ob_data</span>"</span>/log1/obdemo/<span class="token variable">$t</span> ~/oceanbase/store/obdemo/<span class="token variable">$t</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
systemctl <span class="token function">reboot</span> <span class="token parameter variable">-i</span></pre></div></code-block></li><li id="276nyZMPcQgWT2dosGTqVu"><div class="marker"></div><span class="inline-wrap">集群初始化成功后，修改默认<span class="jill"></span>sys<span class="jill"></span>租户<span class="jill"></span>root<span class="jill"></span>用户的密码。</span><code-block id="eE9N9scb3rnGxN5QmfF2H1" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 注：当前方式是直接连接到observer,如需连接到集群，需要配置obproxy</span>
mysql <span class="token parameter variable">-h127.1</span> -uroot@sys <span class="token parameter variable">-P2881</span> <span class="token parameter variable">-p</span> <span class="token parameter variable">-c</span> <span class="token parameter variable">-A</span>
MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> alter user root identified by <span class="token string">'bb123456'</span><span class="token punctuation">;</span></pre></div></code-block></li></ol><h1 id="bY8HAvH6cbsB2oQwK8iF3E" class="wolai-block"><span class="inline-wrap">三、启动<span class="jill"></span>obproxy</span></h1><h2 id="aa8csttAAFkaB1Uw42Dfkd" class="wolai-block"><span class="inline-wrap">3.1 环境配置</span></h2><ol class="wolai-block"><li id="fX9kegG4fTCgMgVEkiTpHv"><div class="marker"></div><span class="inline-wrap">安装<span class="jill"></span>obproxy</span><code-block id="4rsJ2gCZk4nm4q8sdgSuac" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> obproxy-3.1.0-1.el7.x86_64.rpm</pre></div></code-block></li><li id="nMi3HAMsBBi7d1qDQxgHTg"><div class="marker"></div><span class="inline-wrap">创建用户</span><code-block id="xa2xjxcrHtVfY5QKhreMrD" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">groupadd</span> admin 
<span class="token function">useradd</span> <span class="token parameter variable">-s</span> /bin/bash <span class="token parameter variable">-m</span>  <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">`</span>openssl <span class="token function">passwd</span> <span class="token parameter variable">-1</span> <span class="token string">"admin"</span><span class="token variable">`</span></span> <span class="token parameter variable">-d</span> /home/admin <span class="token parameter variable">-g</span> admin admin</pre></div></code-block></li><li id="iZpsdR6Aj4ABscV22zdWfq"><div class="marker"></div><span class="inline-wrap">文件夹赋权</span><code-block id="jzR9cuEv7UPpx18y5D6eZe" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">chown</span> <span class="token parameter variable">-R</span> admin:admin /home/admin</pre></div></code-block></li><li id="3PuBc9sqZBBcY2tssRPyWP"><div class="marker"></div><span class="inline-wrap">使用<span class="jill"></span>obadmin<span class="jill"></span>用户运行<span class="jill"></span>obproxy<span class="jill"></span>进行初始化</span><blockquote id="jtJcFe8ygaFRr34woixy1C" class="wolai-block"><span class="inline-wrap">如果是单节点，删除其他变量</span></blockquote><code-block id="8HbVXtaViCFFJ4U28xcaM2" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">ob_node1_ip</span><span class="token operator">=</span><span class="token string">"192.168.3.71:2881"</span>
<span class="token assign-left variable">ob_node2_ip</span><span class="token operator">=</span><span class="token string">"192.168.3.72:2881"</span>
<span class="token assign-left variable">ob_node3_ip</span><span class="token operator">=</span><span class="token string">"192.168.3.73:2881"</span>
<span class="token assign-left variable">ob_cluster_name</span><span class="token operator">=</span><span class="token string">"obdemo"</span>
/home/admin/obproxy-3.1.0/bin/obproxy <span class="token parameter variable">-p2883</span> <span class="token parameter variable">-r</span> <span class="token string">"<span class="token variable">${ob_node1_ip}</span>;<span class="token variable">${ob_node2_ip}</span>;<span class="token variable">${ob_node3_ip}</span>"</span> <span class="token parameter variable">-o</span> <span class="token assign-left variable">enable_strict_kernel_release</span><span class="token operator">=</span>false,enable_cluster_checkout<span class="token operator">=</span>false <span class="token parameter variable">-c</span> <span class="token string">"<span class="token variable">$ob_cluster_name</span>"</span></pre></div></code-block></li></ol><h2 id="6JkxaZ8iEGrn5DuTpuz2KR" class="wolai-block"><span class="inline-wrap">3.2 创建<span class="jill"></span>OBProxy<span class="jill"></span>专用用户</span></h2><div id="7V6zwNm3QPqoWu8BQyp54Q" class="wolai-block wolai-text"><div><span class="inline-wrap">参考</span><span class="inline-wrap"><a href="https://www.modb.pro/db/32314"><span>配置文档</span></a></span></div></div><div id="5aeEewPkV5BARrwjZgFJVS" class="wolai-block wolai-text"><div><span class="inline-wrap">参考</span><span class="inline-wrap"><a href="https://www.bilibili.com/read/cv12865702"><span>配置文档<span class="jill"></span>2</span></a></span></div></div><ul class="wolai-block"><li id="fzrYhQ46SDx2wFEzZeUTKv"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">root@proxysys<span class="jill"></span>账号</span><span class="inline-wrap">
</span><span class="inline-wrap">说明：OBProxy<span class="jill"></span>的管理员账号，每个<span class="jill"></span>OBProxy<span class="jill"></span>进程的管理员账号相互独立。</span></li><li id="dBmsz6ieg4m2fkvmdrmJoH"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">proxyro@sys<span class="jill"></span>账号</span><span class="inline-wrap">
</span><span class="inline-wrap">说明：OBProxy<span class="jill"></span>访问<span class="jill"></span>OB<span class="jill"></span>集群的账号，OBProxy<span class="jill"></span>需要跟<span class="jill"></span>OceanBase<span class="jill"></span>集群保持通信，首先在<span class="jill"></span>OB<span class="jill"></span>集群创建<span class="jill"></span>proxyro@sys<span class="jill"></span>用户，并设置密码，然后在<span class="jill"></span>OBProxy<span class="jill"></span>中修改<span class="jill"></span>observer_sys_password<span class="jill"></span>配置项为这个密码，即打通了<span class="jill"></span>OBProxy<span class="jill"></span>和<span class="jill"></span>OB<span class="jill"></span>集群的连通。</span></li></ul><ol class="wolai-block"><li id="dsLa86a3X7b5DA5c6DShvQ"><div class="marker"></div><span class="inline-wrap">任一节点下，登陆<span class="jill"></span>OB<span class="jill"></span>集群<span class="jill"></span>sys<span class="jill"></span>租户，创建<span class="jill"></span>obproxy<span class="jill"></span>的内部<span class="jill"></span>proxyro<span class="jill"></span>用户，并设置密码</span><code-block id="1QbBbxj6uteCMTbUxrE4z8" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre><span class="token punctuation">[</span>obadmin<span class="token variable">@ob1</span> <span class="token operator">~</span><span class="token punctuation">]</span>$ mysql <span class="token operator">-</span>h127<span class="token punctuation">.</span><span class="token number">1</span> <span class="token operator">-</span>uroot<span class="token variable">@sys</span> <span class="token operator">-</span>P2881 <span class="token operator">-</span>pbb123456 <span class="token operator">-</span>c <span class="token operator">-</span>A oceanbase
mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">user</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> proxyro identified <span class="token keyword">by</span> <span class="token string">'bb123456'</span><span class="token punctuation">;</span>
mysql<span class="token operator">></span> <span class="token keyword">grant</span> <span class="token keyword">select</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> proxyro<span class="token punctuation">;</span></pre></div></code-block></li><li id="giLh2NJQQzgxMinqm7UMAe"><div class="marker"></div><span class="inline-wrap">确定启动了<span class="jill"></span>obproxy<span class="jill"></span>后，以<span class="jill"></span>obproxy<span class="jill"></span>管理员账号<span class="jill"></span>root@proxysys<span class="jill"></span>登录<span class="jill"></span>OBProxy，设置<span class="jill"></span>proxyro@sys<span class="jill"></span>的密码为上一步<span class="jill"></span>OB<span class="jill"></span>集群创建的<span class="jill"></span>proxyro<span class="jill"></span>用户的密码</span><code-block id="9ydQz8uqfsxZS3kATyJGSq" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 密码空</span>
<span class="token punctuation">[</span>admin@ob1 ~<span class="token punctuation">]</span>$ mysql <span class="token parameter variable">-h127.0.0.1</span> <span class="token parameter variable">-P2883</span> -uroot@proxysys <span class="token parameter variable">-p</span>
mysql<span class="token operator">></span> alter proxyconfig <span class="token builtin class-name">set</span> observer_sys_password <span class="token operator">=</span> <span class="token string">'bb123456'</span><span class="token punctuation">;</span></pre></div></code-block></li><li id="6DoWd2yHQshQw3xmW4JbPi"><div class="marker"></div><span class="inline-wrap">以<span class="jill"></span>obproxy<span class="jill"></span>管理员账号<span class="jill"></span>root@proxysys<span class="jill"></span>登录<span class="jill"></span>OBProxy<span class="jill"></span>进行配置<span class="jill"></span>obproxy<span class="jill"></span>参数。</span><code-block id="71fNVLJkZFgy8BMC21XCAh" class="wolai-block"><div class="wolai-pre"><div data-lang="Sql" class="marker"></div><pre>mysql <span class="token operator">-</span>h127<span class="token punctuation">.</span><span class="token number">0.0</span><span class="token number">.1</span> <span class="token operator">-</span>P2883 <span class="token operator">-</span>uroot<span class="token variable">@proxysys</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> enable_metadb_used<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> enable_proxy_scramble<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> proxy_mem_limited<span class="token operator">=</span><span class="token number">2</span>G<span class="token punctuation">;</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> log_dir_size_threshold<span class="token operator">=</span><span class="token number">10</span>G<span class="token punctuation">;</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> slow_proxy_process_time_threshold<span class="token operator">=</span><span class="token string">'1000ms'</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> xflush_log_level<span class="token operator">=</span>ERROR<span class="token punctuation">;</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> syslog_level<span class="token operator">=</span>WARN<span class="token punctuation">;</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> enable_compression_protocol<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> automatic_match_work_thread<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> work_thread_num<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> proxyconfig <span class="token keyword">set</span> client_max_connections<span class="token operator">=</span><span class="token number">16384</span><span class="token punctuation">;</span></pre></div></code-block></li><li id="5h6YeZ7ifXcQm98JqF5ig2"><div class="marker"></div><span class="inline-wrap">连接正常示例</span><code-block id="nzVNvojEv9JFhVHSUEuAor" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@ob1 data<span class="token punctuation">]</span><span class="token comment"># obclient -h192.168.3.71 -uroot@sys#obdemo -P2883 -A -pbb123456</span>
Welcome to the OceanBase.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MySQL connection <span class="token function">id</span> is <span class="token number">1</span>
Server version: <span class="token number">5.6</span>.25 OceanBase <span class="token number">2.2</span>.50 <span class="token punctuation">(</span>r1-1c6441e8fb858c80da395f934f67ed305425864e<span class="token punctuation">)</span> <span class="token punctuation">(</span>Built Mar  <span class="token number">6</span> <span class="token number">2020</span> <span class="token number">18</span>:41:01<span class="token punctuation">)</span>

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2018</span>, Oracle, MariaDB Corporation Ab and others.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span></pre></div></code-block><div id="nFMxynMbLQFYyGqTZtpxe5" class="wolai-block wolai-text"><div><span class="inline-wrap">如遇到下列问题表示认证出错，可查看<span class="jill"></span>log/obproxy.log 从关键词</span><span class="inline-wrap"><code>Now closing connection</code></span><span class="inline-wrap">向上搜索</span></div></div><code-block id="wjpArhVocW3RcntoHBwNNM" class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token constant">ERROR</span> <span class="token number">2013</span> <span class="token punctuation">(</span><span class="token constant">HY000</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Lost</span> connection to <span class="token maybe-class-name">MySQL</span> server at <span class="token string">'reading authorization packet'</span><span class="token punctuation">,</span> system error<span class="token operator">:</span> <span class="token number">11</span>
<span class="token constant">ERROR</span> <span class="token number">2013</span> <span class="token punctuation">(</span><span class="token constant">HY000</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Lost</span> connection to <span class="token maybe-class-name">MySQL</span> server at <span class="token string">'reading authorization packet'</span><span class="token punctuation">,</span> system error<span class="token operator">:</span> <span class="token number">0</span></pre></div></code-block><blockquote id="cXDCDmYkU4btFPdftmfHQP" class="wolai-block"><span class="inline-wrap">参考文档：</span><span class="inline-wrap">
</span><span class="inline-wrap"><a href="https://www.bookstack.cn/read/oceanbase-1.4-zh/0d371dbe7ad07af3.md"><span>启动<span class="jill"></span>obproxy<span class="jill"></span>问题</span></a></span><span class="inline-wrap">：MySQL 5.7.8<span class="jill"></span>之前版本， 用户名长度超过<span class="jill"></span>16<span class="jill"></span>字节会被截断。5.7.8<span class="jill"></span>版本之后版本用户长度超过<span class="jill"></span>32<span class="jill"></span>字节会被截断。这里的用户名应包含完整的<span class="jill"></span>username@tenantname#clustername。</span><span class="inline-wrap">
</span><span class="inline-wrap"><a href="https://open.oceanbase.com/articles/1100261"><span>重新安装<span class="jill"></span>obproxy</span></a></span></blockquote></li></ol></article><footer></footer></body></html>