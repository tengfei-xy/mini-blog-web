<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/wolai.css"/><title>Rust - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="full-width small-font"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="Rust" class="main-title"></div></div></header><article><h1 id="fVQm1KAwqQqutT4DDGGuu3" class="wolai-block"><span class="inline-wrap"><a href="https://github.com/prometheus/client_rust/tree/master/examples"><span>官方示例</span></a></span><details id="fNUn6CRJULrbR1rrvykgR8" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">actix-web</span></summary><div id="byoJYdBWsnCU1DeB4UdUBE" class="wolai-block wolai-text"><div><span class="inline-wrap">添加库</span></div></div><code-block id="oYwDZaEdnDfkRJfZ8MCgWt" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token function">cargo</span> <span class="token function">add</span> actix_web
<span class="token function">cargo</span> <span class="token function">add</span> prometheus_client</pre></div></code-block><div id="vdBGnDGTyJhFramzHUK6wG" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://github.com/prometheus/client_rust/blob/master/examples/actix-web.rs"><span>具体实现</span></a></span></div></div><code-block id="gWFQWVSt6sjTczbQTur7Q2" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">Mutex</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">actix_web<span class="token punctuation">::</span></span><span class="token punctuation">{</span>web<span class="token punctuation">,</span> <span class="token class-name">App</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">,</span> <span class="token class-name">HttpServer</span><span class="token punctuation">,</span> <span class="token class-name">Responder</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">prometheus_client<span class="token punctuation">::</span>encoding<span class="token punctuation">::</span>text<span class="token punctuation">::</span></span>encode<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">prometheus_client<span class="token punctuation">::</span>encoding<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">EncodeLabelSet</span><span class="token punctuation">,</span> <span class="token class-name">EncodeLabelValue</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">prometheus_client<span class="token punctuation">::</span>metrics<span class="token punctuation">::</span>counter<span class="token punctuation">::</span></span><span class="token class-name">Counter</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">prometheus_client<span class="token punctuation">::</span>metrics<span class="token punctuation">::</span>family<span class="token punctuation">::</span></span><span class="token class-name">Family</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">prometheus_client<span class="token punctuation">::</span>registry<span class="token punctuation">::</span></span><span class="token class-name">Registry</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Clone, Debug, Hash, PartialEq, Eq, EncodeLabelValue)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Method</span> <span class="token punctuation">{</span>
    <span class="token class-name">Get</span><span class="token punctuation">,</span>
    <span class="token class-name">Post</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Clone, Debug, Hash, PartialEq, Eq, EncodeLabelSet)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">MethodLabels</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> method<span class="token punctuation">:</span> <span class="token class-name">Method</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Metrics</span> <span class="token punctuation">{</span>
    requests<span class="token punctuation">:</span> <span class="token class-name">Family</span><span class="token operator">&lt;</span><span class="token class-name">MethodLabels</span><span class="token punctuation">,</span> <span class="token class-name">Counter</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Metrics</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">inc_requests</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> method<span class="token punctuation">:</span> <span class="token class-name">Method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>requests<span class="token punctuation">.</span><span class="token function">get_or_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">MethodLabels</span> <span class="token punctuation">{</span> method <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AppState</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> registry<span class="token punctuation">:</span> <span class="token class-name">Registry</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// metrics_handler：这个函数是一个异步函数，</span>
<span class="token comment">// 它接收一个 AppState 的互斥锁（Mutex）作为参数。</span>
<span class="token comment">// 这个函数首先获取互斥锁的所有权，然后创建一个新的字符串 body，并将 state.registry 编码到 body 中。</span>
<span class="token comment">// 最后，它返回一个 HTTP 响应，内容类型为 "application/openmetrics-text"，并且响应体为 body。</span>
<span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">metrics_handler</span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Data</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">AppState</span><span class="token operator">>></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">HttpResponse</span><span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> body <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">encode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> body<span class="token punctuation">,</span> <span class="token operator">&amp;</span>state<span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">HttpResponse</span><span class="token punctuation">::</span><span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">content_type</span><span class="token punctuation">(</span><span class="token string">"application/openmetrics-text; version=1.0.0; charset=utf-8"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 函数介绍:</span>
<span class="token comment">// some_handler：这个函数也是一个异步函数，</span>
<span class="token comment">// 它接收一个 Metrics 类型的数据。</span>
<span class="token comment">// 这个函数会增加 Metrics 中的请求计数，然后返回一个字符串 "okay"。</span>
<span class="token comment">// --- </span>
<span class="token comment">// 输入参数</span>
<span class="token comment">// web::Data&lt;T> 是 Actix Web 框架中的一个类型，用于在多个请求处理器（request handlers）之间共享数据。</span>
<span class="token comment">// 这里的 T 是泛型参数，可以是任何类型。在你的代码中，T 被替换为 Metrics 类型，</span>
<span class="token comment">// 所以 web::Data&lt;Metrics> 表示的是一个可以在多个请求处理器之间共享的 Metrics 数据。</span>
<span class="token comment">// Actix Web 中的 web::Data 是线程安全的，因此可以在异步环境中使用。</span>
<span class="token comment">// 当你需要在多个请求处理器之间共享一些数据时，可以使用 web::Data。</span>
<span class="token comment">// 例如，你可能需要共享数据库连接池，或者像这里的 Metrics 这样的度量数据。</span>
<span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">some_handler</span><span class="token punctuation">(</span>metrics<span class="token punctuation">:</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Data</span><span class="token operator">&lt;</span><span class="token class-name">Metrics</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">impl</span> <span class="token class-name">Responder</span> <span class="token punctuation">{</span>
    metrics<span class="token punctuation">.</span><span class="token function">inc_requests</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">::</span><span class="token class-name">Get</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token string">"okay"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// main 函数：这是程序的入口点。</span>
<span class="token comment">// 它首先创建一个新的 Metrics 对象，</span>
<span class="token comment">// 然后创建一个新的 AppState 对象。这两个对象都被初始化为默认值。</span>
<span class="token attribute attr-name">#[actix_web::main]</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> metrics <span class="token operator">=</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Data</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Metrics</span> <span class="token punctuation">{</span>
        requests<span class="token punctuation">:</span> <span class="token class-name">Family</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> state <span class="token operator">=</span> <span class="token class-name">AppState</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">:</span> <span class="token class-name">Registry</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    state
        <span class="token punctuation">.</span>registry
        <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"requests"</span><span class="token punctuation">,</span> <span class="token string">"Count of requests"</span><span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>requests<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token namespace">web<span class="token punctuation">::</span></span><span class="token class-name">Data</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpServer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">App</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">app_data</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">app_data</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">"/metrics"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>metrics_handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">"/handler"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token namespace">web<span class="token punctuation">::</span></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>some_handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
<span class="token punctuation">}</span></pre></div></code-block><details id="2PyQnbuuUCtz5j7YY3PCtB" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">操作说明</span></summary><div id="asYQPWj4dkU7rd1U8ApVPN" class="wolai-block wolai-text"><div><span class="inline-wrap">通过</span><span class="inline-wrap"><code>curl 127.0.0.1:8080/handler</code></span><span class="inline-wrap">，可以从</span><span class="inline-wrap"><code>curl 127.0.0.1:8080/metrics</code></span><span class="inline-wrap">发现变化，即</span></div></div><code-block id="62SWbu71GnRAeGk8T6YVHe" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token comment"># HELP requests Count of requests.</span>
<span class="token comment"># TYPE requests counter</span>
requests_total<span class="token punctuation">{</span>method<span class="token operator">=</span><span class="token string">"Get"</span><span class="token punctuation">}</span> <span class="token number">1</span>
<span class="token comment"># EOF</span></pre></div></code-block></details></details></h1><h1 id="kAhkmzeLzfrb1SJhW1eTiM" class="wolai-block"><span class="inline-wrap">基础示例</span><details id="3hZF2M4Aaq1i5d92MQRFYs" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">创建指标</span></summary><details id="gbzFtBRgks2xLKs815rKNB" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">Counter</span></summary><div class="block-ref"><div class="decorator"></div><div id="g1HddQPNbdN61LzgiYTE9y" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明</span><span class="inline-wrap">：表示单个单调递增的计数器，其值只能增加或在重启时重置为零。</span></div></div></div><code-block id="87Z7P8sPLy5vKbtycmfzoc" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">prometheus<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Counter</span><span class="token punctuation">,</span> <span class="token class-name">CounterVec</span><span class="token punctuation">,</span> <span class="token class-name">Opts</span><span class="token punctuation">,</span> <span class="token class-name">Registry</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token class-name">Opts</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"my_counter"</span><span class="token punctuation">,</span> <span class="token string">"My counter help"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"my_namespace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">::</span><span class="token function">with_opts</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

counter<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></details><details id="gxmoA1VVzuUxcm1zqvXkYv" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">Gauge</span></summary><div class="block-ref"><div class="decorator"></div><div id="mGny8PRGFrGNRYk6DTWcum" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明</span><span class="inline-wrap">：</span><span class="inline-wrap">其值可以增加或减少。Gauge 通常用于表示当前状态、资源可用性等。</span></div></div></div><code-block id="kkd3EPiRuhmbj9n35c2gZX" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">prometheus<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Gauge</span><span class="token punctuation">,</span> <span class="token class-name">Opts</span><span class="token punctuation">,</span> <span class="token class-name">Registry</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token class-name">Opts</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"my_gauge"</span><span class="token punctuation">,</span> <span class="token string">"My gauge help"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"my_namespace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> gauge <span class="token operator">=</span> <span class="token class-name">Gauge</span><span class="token punctuation">::</span><span class="token function">with_opts</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gauge<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></details><details id="mMwjPRrxPxfUntdi27oCxB" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">Histogram</span></summary><div class="block-ref"><div class="decorator"></div><div id="3TAECrQAvuhKbpjix3ZNiM" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明</span><span class="inline-wrap">：</span><span class="inline-wrap">表示一组数据的分布情况。Histogram 将数据划分为多个区间，并记录每个区间内的数据量。</span></div></div></div><code-block id="2EA7DnYuHNA1HM2ix72HFY" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">prometheus<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Histogram</span><span class="token punctuation">,</span> <span class="token class-name">HistogramOpts</span><span class="token punctuation">,</span> <span class="token class-name">HistogramVec</span><span class="token punctuation">,</span> <span class="token class-name">Opts</span><span class="token punctuation">,</span> <span class="token class-name">Registry</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token class-name">HistogramOpts</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"my_histogram"</span><span class="token punctuation">,</span> <span class="token string">"My histogram help"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"my_namespace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> histogram <span class="token operator">=</span> <span class="token class-name">Histogram</span><span class="token punctuation">::</span><span class="token function">with_opts</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

histogram<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></details><details id="iuW1RGCZkEUbRG3VpJ1qT7" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">Summary</span></summary><div class="block-ref"><div class="decorator"></div><div id="fiA4CT1JZ8mdALrNxxLibe" class="wolai-block wolai-text"><div><span class="blue inline-wrap">说明</span><span class="inline-wrap">：类似于 Histogram，但它提供了更精细的统计信息，例如平均值、标准差、分位数等。</span></div></div></div><code-block id="twrYHZiZS1aK5V3N3gmDup" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">prometheus<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Opts</span><span class="token punctuation">,</span> <span class="token class-name">Registry</span><span class="token punctuation">,</span> <span class="token class-name">Summary</span><span class="token punctuation">,</span> <span class="token class-name">SummaryOpts</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token class-name">SummaryOpts</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"my_summary"</span><span class="token punctuation">,</span> <span class="token string">"My summary help"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"my_namespace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> summary <span class="token operator">=</span> <span class="token class-name">Summary</span><span class="token punctuation">::</span><span class="token function">with_opts</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

summary<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre></div></code-block></details></details><details id="mHNCavy24VsjWyFgDKiSfe" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">注册指标</span></summary><code-block id="kf9UaeBo78ZxRHM8wboLXG" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">prometheus<span class="token punctuation">::</span></span><span class="token punctuation">{</span>register<span class="token punctuation">,</span> <span class="token class-name">Counter</span><span class="token punctuation">,</span> <span class="token class-name">Opts</span><span class="token punctuation">,</span> <span class="token class-name">Registry</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token class-name">Opts</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"my_counter"</span><span class="token punctuation">,</span> <span class="token string">"My counter help"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"my_namespace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">::</span><span class="token function">with_opts</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 进行注册</span>
<span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>counter<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

counter<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></details><details id="qQbZXkr5JojvnjpotSAKHd" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">导出指标到<span class="jill"></span>Prometheus<span class="jill"></span>客户端</span></summary><code-block id="gnsoaZiuWaRgg9tq1jj5nS" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">prometheus<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Encoder</span><span class="token punctuation">,</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> encoder <span class="token operator">=</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> metric_families <span class="token operator">=</span> <span class="token namespace">prometheus<span class="token punctuation">::</span></span><span class="token function">gather</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>metric_families<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></details></h1><h1 id="pYbXojRiHzMPBUkpGUVhPM" class="wolai-block"><span class="inline-wrap">拓展示例</span><details id="odgMF5CgGw85YbcAniGStB" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">自定义指标</span></summary><code-block id="6TApDwSSb62Z3dbJUMG1jD" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">prometheus<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Collector</span><span class="token punctuation">,</span> <span class="token class-name">Counter</span><span class="token punctuation">,</span> <span class="token class-name">CounterVec</span><span class="token punctuation">,</span> <span class="token class-name">Desc</span><span class="token punctuation">,</span> <span class="token class-name">Metric</span><span class="token punctuation">,</span> <span class="token class-name">Opts</span><span class="token punctuation">,</span> <span class="token class-name">Registry</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">MyCollector</span> <span class="token punctuation">{</span>
    counter<span class="token punctuation">:</span> <span class="token class-name">Counter</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">MyCollector</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">MyCollector</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> opts <span class="token operator">=</span> <span class="token class-name">Opts</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"my_counter"</span><span class="token punctuation">,</span> <span class="token string">"My counter help"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">"my_namespace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token class-name">Counter</span><span class="token punctuation">::</span><span class="token function">with_opts</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MyCollector</span> <span class="token punctuation">{</span> counter <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Collector</span> <span class="token keyword">for</span> <span class="token class-name">MyCollector</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">desc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">Desc</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">collect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Metric</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> my_collector <span class="token operator">=</span> <span class="token class-name">MyCollector</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> registry <span class="token operator">=</span> <span class="token class-name">Registry</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>my_collector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></details><details id="tsyHcuRatPA3UTRZzZxQZA" class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">自定义<span class="jill"></span>Exporter</span></summary><code-block id="rqSDu4QRNNUF9WoB9MJs6n" class="wolai-block"><div class="wolai-pre"><div data-lang="Rust" class="marker"></div><pre style="white-space: pre-wrap; word-break: break-all"><span class="token keyword">use</span> <span class="token namespace">prometheus<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Encoder</span><span class="token punctuation">,</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">MyExporter</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">MyExporter</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">MyExporter</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyExporter</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">export</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> encoder <span class="token operator">=</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> metric_families <span class="token operator">=</span> <span class="token namespace">prometheus<span class="token punctuation">::</span></span><span class="token function">gather</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>metric_families<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> my_exporter <span class="token operator">=</span> <span class="token class-name">MyExporter</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> output <span class="token operator">=</span> my_exporter<span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></details></h1><div id="q8KwGbmZi6mbByNRezGYfA" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div></article><footer></footer></body></html>